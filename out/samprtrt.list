# file opened: ./src/SAMPRTRT.asm
   1  0000              ; ===================================================================
   2  0000              ; SAM.PR World - 2025 Fausto Pracek
   3  0000              ; ===================================================================
   4  0000
   5  0000                      DEVICE ZXSPECTRUM48
   6  0000                      SLDOPT COMMENT WPMEM, LOGPOINT, ASSERTION
   7  0000
   8  0000                      ORG 0x8000               ; Loader address (0x8000)
   9  8000
  10  8000                      INCLUDE "TILES.asm"
# file opened: ./inc/TILES.asm
   1+ 8000              ; ===================================================================
   2+ 8000              ; Tiles
   3+ 8000              ; ===================================================================
   4+ 8000
   5+ 8000              ; --------------------------------------------------------------------
   6+ 8000              ; Constants
   7+ 8000              ; --------------------------------------------------------------------
   8+ 8000              TILE_VERTICAL_WALL		        EQU		0
   9+ 8000              TILE_BLOCK	   					EQU		1
  10+ 8000              TILE_BLOCK_ROW_COMPETED			EQU		2
  11+ 8000              TILE_BLOCK_EMPTY    			EQU		3
  12+ 8000              TILE_HORIZONTAL_WALL			EQU		4
  13+ 8000              TILE_FIRST_CHAR 				EQU		5
  14+ 8000              TILES_DEF:
  14+ 8000
  15+ 8000              ; Verical wall
  16+ 8000 02           	db 2
  17+ 8001 FF           	db 255
  18+ 8002 10           	db 16
  19+ 8003 10           	db 16
  20+ 8004 10           	db 16
  21+ 8005 FF           	db 255
  22+ 8006 02           	db 2
  23+ 8007 02           	db 2
  24+ 8008              ; Block
  25+ 8008 00           	db 0x00
  26+ 8009 7E           	db 0x7E
  27+ 800A 40           	db 0x40
  28+ 800B 42           	db 0x42
  29+ 800C 42           	db 0x42
  30+ 800D 42           	db 0x42
  31+ 800E 5E           	db 0x5E
  32+ 800F 00           	db 0x00
  33+ 8010              ; Block (Row completed)
  34+ 8010 FF           	db 0xFF
  35+ 8011 81           	db 0x81
  36+ 8012 81           	db 0x81
  37+ 8013 81           	db 0x81
  38+ 8014 81           	db 0x81
  39+ 8015 81           	db 0x81
  40+ 8016 81           	db 0x81
  41+ 8017 FF           	db 0xFF
  42+ 8018              ; Block (Row empty)
  43+ 8018 FF           	db 0xFF
  44+ 8019 FF           	db 0xFF
  45+ 801A FF           	db 0xFF
  46+ 801B FF           	db 0xFF
  47+ 801C FF           	db 0xFF
  48+ 801D FF           	db 0xFF
  49+ 801E FF           	db 0xFF
  50+ 801F FF           	db 0xFF
  51+ 8020              ; Horizontal wall
  52+ 8020 22           	db 34
  53+ 8021 22           	db 34
  54+ 8022 22           	db 34
  55+ 8023 3E           	db 62
  56+ 8024 22           	db 34
  57+ 8025 22           	db 34
  58+ 8026 E3           	db 227
  59+ 8027 22           	db 34
  60+ 8028
  61+ 8028
  62+ 8028
  63+ 8028
  64+ 8028              ; Char " "
  65+ 8028 00           	db 0x00
  66+ 8029 00           	db 0x00
  67+ 802A 00           	db 0x00
  68+ 802B 00           	db 0x00
  69+ 802C 00           	db 0x00
  70+ 802D 00           	db 0x00
  71+ 802E 00           	db 0x00
  72+ 802F 00           	db 0x00
  73+ 8030              ; Char "!"
  74+ 8030 00           	db 0x00
  75+ 8031 30           	db 0x30
  76+ 8032 30           	db 0x30
  77+ 8033 30           	db 0x30
  78+ 8034 30           	db 0x30
  79+ 8035 00           	db 0x00
  80+ 8036 30           	db 0x30
  81+ 8037 00           	db 0x00
  82+ 8038              ; Char """
  83+ 8038 00           	db 0x00
  84+ 8039 6C           	db 0x6C
  85+ 803A 6C           	db 0x6C
  86+ 803B 48           	db 0x48
  87+ 803C 00           	db 0x00
  88+ 803D 00           	db 0x00
  89+ 803E 00           	db 0x00
  90+ 803F 00           	db 0x00
  91+ 8040              ; Char "#"
  92+ 8040 00           	db 0x00
  93+ 8041 2C           	db 0x2C
  94+ 8042 7E           	db 0x7E
  95+ 8043 2C           	db 0x2C
  96+ 8044 2C           	db 0x2C
  97+ 8045 7E           	db 0x7E
  98+ 8046 2C           	db 0x2C
  99+ 8047 00           	db 0x00
 100+ 8048              ; Char "$"
 101+ 8048 00           	db 0x00
 102+ 8049 18           	db 0x18
 103+ 804A 3E           	db 0x3E
 104+ 804B 58           	db 0x58
 105+ 804C 3C           	db 0x3C
 106+ 804D 1A           	db 0x1A
 107+ 804E 7C           	db 0x7C
 108+ 804F 00           	db 0x00
 109+ 8050              ; Char "%"
 110+ 8050 00           	db 0x00
 111+ 8051 62           	db 0x62
 112+ 8052 64           	db 0x64
 113+ 8053 08           	db 0x08
 114+ 8054 10           	db 0x10
 115+ 8055 26           	db 0x26
 116+ 8056 46           	db 0x46
 117+ 8057 00           	db 0x00
 118+ 8058              ; Char "&"
 119+ 8058 00           	db 0x00
 120+ 8059 38           	db 0x38
 121+ 805A 6C           	db 0x6C
 122+ 805B 38           	db 0x38
 123+ 805C 6A           	db 0x6A
 124+ 805D 64           	db 0x64
 125+ 805E 3A           	db 0x3A
 126+ 805F 00           	db 0x00
 127+ 8060              ; Char "'"
 128+ 8060 00           	db 0x00
 129+ 8061 30           	db 0x30
 130+ 8062 30           	db 0x30
 131+ 8063 20           	db 0x20
 132+ 8064 00           	db 0x00
 133+ 8065 00           	db 0x00
 134+ 8066 00           	db 0x00
 135+ 8067 00           	db 0x00
 136+ 8068              ; Char "("
 137+ 8068 00           	db 0x00
 138+ 8069 0C           	db 0x0C
 139+ 806A 18           	db 0x18
 140+ 806B 18           	db 0x18
 141+ 806C 18           	db 0x18
 142+ 806D 18           	db 0x18
 143+ 806E 0C           	db 0x0C
 144+ 806F 00           	db 0x00
 145+ 8070              ; Char "("
 146+ 8070 00           	db 0x00
 147+ 8071 30           	db 0x30
 148+ 8072 18           	db 0x18
 149+ 8073 18           	db 0x18
 150+ 8074 18           	db 0x18
 151+ 8075 18           	db 0x18
 152+ 8076 30           	db 0x30
 153+ 8077 00           	db 0x00
 154+ 8078              ; Char "*"
 155+ 8078 00           	db 0x00
 156+ 8079 00           	db 0x00
 157+ 807A 00           	db 0x00
 158+ 807B 66           	db 0x66
 159+ 807C 18           	db 0x18
 160+ 807D 66           	db 0x66
 161+ 807E 00           	db 0x00
 162+ 807F 00           	db 0x00
 163+ 8080              ; Char "+"
 164+ 8080 00           	db 0x00
 165+ 8081 00           	db 0x00
 166+ 8082 18           	db 0x18
 167+ 8083 18           	db 0x18
 168+ 8084 7E           	db 0x7E
 169+ 8085 18           	db 0x18
 170+ 8086 18           	db 0x18
 171+ 8087 00           	db 0x00
 172+ 8088              ; Char ","
 173+ 8088 00           	db 0x00
 174+ 8089 00           	db 0x00
 175+ 808A 00           	db 0x00
 176+ 808B 00           	db 0x00
 177+ 808C 00           	db 0x00
 178+ 808D 30           	db 0x30
 179+ 808E 30           	db 0x30
 180+ 808F 10           	db 0x10
 181+ 8090              ; Char "-"
 182+ 8090 00           	db 0x00
 183+ 8091 00           	db 0x00
 184+ 8092 00           	db 0x00
 185+ 8093 00           	db 0x00
 186+ 8094 3C           	db 0x3C
 187+ 8095 00           	db 0x00
 188+ 8096 00           	db 0x00
 189+ 8097 00           	db 0x00
 190+ 8098              ; Char "."
 191+ 8098 00           	db 0x00
 192+ 8099 00           	db 0x00
 193+ 809A 00           	db 0x00
 194+ 809B 00           	db 0x00
 195+ 809C 00           	db 0x00
 196+ 809D 30           	db 0x30
 197+ 809E 30           	db 0x30
 198+ 809F 00           	db 0x00
 199+ 80A0              ; Char "/"
 200+ 80A0 00           	db 0x00
 201+ 80A1 02           	db 0x02
 202+ 80A2 06           	db 0x06
 203+ 80A3 0C           	db 0x0C
 204+ 80A4 18           	db 0x18
 205+ 80A5 30           	db 0x30
 206+ 80A6 60           	db 0x60
 207+ 80A7 00           	db 0x00
 208+ 80A8              ; Char "0"
 209+ 80A8 00           	db 0x00
 210+ 80A9 3C           	db 0x3C
 211+ 80AA 66           	db 0x66
 212+ 80AB 6E           	db 0x6E
 213+ 80AC 76           	db 0x76
 214+ 80AD 66           	db 0x66
 215+ 80AE 3C           	db 0x3C
 216+ 80AF 00           	db 0x00
 217+ 80B0              ; Char "1"
 218+ 80B0 00           	db 0x00
 219+ 80B1 18           	db 0x18
 220+ 80B2 38           	db 0x38
 221+ 80B3 58           	db 0x58
 222+ 80B4 18           	db 0x18
 223+ 80B5 18           	db 0x18
 224+ 80B6 7E           	db 0x7E
 225+ 80B7 00           	db 0x00
 226+ 80B8              ; Char "2"
 227+ 80B8 00           	db 0x00
 228+ 80B9 3C           	db 0x3C
 229+ 80BA 46           	db 0x46
 230+ 80BB 1C           	db 0x1C
 231+ 80BC 30           	db 0x30
 232+ 80BD 60           	db 0x60
 233+ 80BE 7E           	db 0x7E
 234+ 80BF 00           	db 0x00
 235+ 80C0              ; Char "3"
 236+ 80C0 00           	db 0x00
 237+ 80C1 3C           	db 0x3C
 238+ 80C2 46           	db 0x46
 239+ 80C3 1C           	db 0x1C
 240+ 80C4 06           	db 0x06
 241+ 80C5 46           	db 0x46
 242+ 80C6 3C           	db 0x3C
 243+ 80C7 00           	db 0x00
 244+ 80C8              ; Char "4"
 245+ 80C8 00           	db 0x00
 246+ 80C9 30           	db 0x30
 247+ 80CA 30           	db 0x30
 248+ 80CB 60           	db 0x60
 249+ 80CC 7E           	db 0x7E
 250+ 80CD 0C           	db 0x0C
 251+ 80CE 0C           	db 0x0C
 252+ 80CF 00           	db 0x00
 253+ 80D0              ; Char "5"
 254+ 80D0 00           	db 0x00
 255+ 80D1 7E           	db 0x7E
 256+ 80D2 60           	db 0x60
 257+ 80D3 7E           	db 0x7E
 258+ 80D4 06           	db 0x06
 259+ 80D5 46           	db 0x46
 260+ 80D6 3C           	db 0x3C
 261+ 80D7 00           	db 0x00
 262+ 80D8              ; Char "6"
 263+ 80D8 00           	db 0x00
 264+ 80D9 3C           	db 0x3C
 265+ 80DA 60           	db 0x60
 266+ 80DB 7C           	db 0x7C
 267+ 80DC 66           	db 0x66
 268+ 80DD 66           	db 0x66
 269+ 80DE 3C           	db 0x3C
 270+ 80DF 00           	db 0x00
 271+ 80E0              ; Char "7"
 272+ 80E0 00           	db 0x00
 273+ 80E1 7E           	db 0x7E
 274+ 80E2 06           	db 0x06
 275+ 80E3 0C           	db 0x0C
 276+ 80E4 18           	db 0x18
 277+ 80E5 18           	db 0x18
 278+ 80E6 18           	db 0x18
 279+ 80E7 00           	db 0x00
 280+ 80E8              ; Char "8"
 281+ 80E8 00           	db 0x00
 282+ 80E9 3C           	db 0x3C
 283+ 80EA 66           	db 0x66
 284+ 80EB 3C           	db 0x3C
 285+ 80EC 66           	db 0x66
 286+ 80ED 66           	db 0x66
 287+ 80EE 3C           	db 0x3C
 288+ 80EF 00           	db 0x00
 289+ 80F0              ; Char "9"
 290+ 80F0 00           	db 0x00
 291+ 80F1 3C           	db 0x3C
 292+ 80F2 66           	db 0x66
 293+ 80F3 3E           	db 0x3E
 294+ 80F4 06           	db 0x06
 295+ 80F5 66           	db 0x66
 296+ 80F6 3C           	db 0x3C
 297+ 80F7 00           	db 0x00
 298+ 80F8              ; Char ":"
 299+ 80F8 00           	db 0x00
 300+ 80F9 00           	db 0x00
 301+ 80FA 30           	db 0x30
 302+ 80FB 30           	db 0x30
 303+ 80FC 00           	db 0x00
 304+ 80FD 30           	db 0x30
 305+ 80FE 30           	db 0x30
 306+ 80FF 00           	db 0x00
 307+ 8100              ; Char ";"
 308+ 8100 00           	db 0x00
 309+ 8101 00           	db 0x00
 310+ 8102 30           	db 0x30
 311+ 8103 30           	db 0x30
 312+ 8104 00           	db 0x00
 313+ 8105 30           	db 0x30
 314+ 8106 30           	db 0x30
 315+ 8107 10           	db 0x10
 316+ 8108              ; Char "<"
 317+ 8108 00           	db 0x00
 318+ 8109 0C           	db 0x0C
 319+ 810A 18           	db 0x18
 320+ 810B 30           	db 0x30
 321+ 810C 30           	db 0x30
 322+ 810D 18           	db 0x18
 323+ 810E 0C           	db 0x0C
 324+ 810F 00           	db 0x00
 325+ 8110              ; Char "="
 326+ 8110 00           	db 0x00
 327+ 8111 00           	db 0x00
 328+ 8112 00           	db 0x00
 329+ 8113 7E           	db 0x7E
 330+ 8114 00           	db 0x00
 331+ 8115 7E           	db 0x7E
 332+ 8116 00           	db 0x00
 333+ 8117 00           	db 0x00
 334+ 8118              ; Char ">"
 335+ 8118 00           	db 0x00
 336+ 8119 30           	db 0x30
 337+ 811A 18           	db 0x18
 338+ 811B 0C           	db 0x0C
 339+ 811C 0C           	db 0x0C
 340+ 811D 18           	db 0x18
 341+ 811E 30           	db 0x30
 342+ 811F 00           	db 0x00
 343+ 8120              ; Char "?"
 344+ 8120 00           	db 0x00
 345+ 8121 3C           	db 0x3C
 346+ 8122 66           	db 0x66
 347+ 8123 0E           	db 0x0E
 348+ 8124 18           	db 0x18
 349+ 8125 00           	db 0x00
 350+ 8126 18           	db 0x18
 351+ 8127 00           	db 0x00
 352+ 8128              ; Char "@"
 353+ 8128 00           	db 0x00
 354+ 8129 3C           	db 0x3C
 355+ 812A 66           	db 0x66
 356+ 812B 06           	db 0x06
 357+ 812C 36           	db 0x36
 358+ 812D 56           	db 0x56
 359+ 812E 3C           	db 0x3C
 360+ 812F 00           	db 0x00
 361+ 8130              ; Char "A"
 362+ 8130 00           	db 0x00
 363+ 8131 3C           	db 0x3C
 364+ 8132 66           	db 0x66
 365+ 8133 66           	db 0x66
 366+ 8134 7E           	db 0x7E
 367+ 8135 66           	db 0x66
 368+ 8136 66           	db 0x66
 369+ 8137 00           	db 0x00
 370+ 8138              ; Char "B"
 371+ 8138 00           	db 0x00
 372+ 8139 7C           	db 0x7C
 373+ 813A 66           	db 0x66
 374+ 813B 7C           	db 0x7C
 375+ 813C 66           	db 0x66
 376+ 813D 66           	db 0x66
 377+ 813E 7C           	db 0x7C
 378+ 813F 00           	db 0x00
 379+ 8140              ; Char "C"
 380+ 8140 00           	db 0x00
 381+ 8141 3C           	db 0x3C
 382+ 8142 66           	db 0x66
 383+ 8143 60           	db 0x60
 384+ 8144 60           	db 0x60
 385+ 8145 66           	db 0x66
 386+ 8146 3C           	db 0x3C
 387+ 8147 00           	db 0x00
 388+ 8148              ; Char "D"
 389+ 8148 00           	db 0x00
 390+ 8149 7C           	db 0x7C
 391+ 814A 66           	db 0x66
 392+ 814B 66           	db 0x66
 393+ 814C 66           	db 0x66
 394+ 814D 66           	db 0x66
 395+ 814E 7C           	db 0x7C
 396+ 814F 00           	db 0x00
 397+ 8150              ; Char "E"
 398+ 8150 00           	db 0x00
 399+ 8151 7E           	db 0x7E
 400+ 8152 60           	db 0x60
 401+ 8153 7C           	db 0x7C
 402+ 8154 60           	db 0x60
 403+ 8155 60           	db 0x60
 404+ 8156 7E           	db 0x7E
 405+ 8157 00           	db 0x00
 406+ 8158              ; Char "F"
 407+ 8158 00           	db 0x00
 408+ 8159 7E           	db 0x7E
 409+ 815A 60           	db 0x60
 410+ 815B 7C           	db 0x7C
 411+ 815C 60           	db 0x60
 412+ 815D 60           	db 0x60
 413+ 815E 60           	db 0x60
 414+ 815F 00           	db 0x00
 415+ 8160              ; Char "G"
 416+ 8160 00           	db 0x00
 417+ 8161 3C           	db 0x3C
 418+ 8162 66           	db 0x66
 419+ 8163 60           	db 0x60
 420+ 8164 6E           	db 0x6E
 421+ 8165 66           	db 0x66
 422+ 8166 3C           	db 0x3C
 423+ 8167 00           	db 0x00
 424+ 8168              ; Char "H"
 425+ 8168 00           	db 0x00
 426+ 8169 66           	db 0x66
 427+ 816A 66           	db 0x66
 428+ 816B 66           	db 0x66
 429+ 816C 7E           	db 0x7E
 430+ 816D 66           	db 0x66
 431+ 816E 66           	db 0x66
 432+ 816F 00           	db 0x00
 433+ 8170              ; Char "I"
 434+ 8170 00           	db 0x00
 435+ 8171 3C           	db 0x3C
 436+ 8172 18           	db 0x18
 437+ 8173 18           	db 0x18
 438+ 8174 18           	db 0x18
 439+ 8175 18           	db 0x18
 440+ 8176 3C           	db 0x3C
 441+ 8177 00           	db 0x00
 442+ 8178              ; Char "J"
 443+ 8178 00           	db 0x00
 444+ 8179 7E           	db 0x7E
 445+ 817A 18           	db 0x18
 446+ 817B 18           	db 0x18
 447+ 817C 18           	db 0x18
 448+ 817D 58           	db 0x58
 449+ 817E 30           	db 0x30
 450+ 817F 00           	db 0x00
 451+ 8180              ; Char "K"
 452+ 8180 00           	db 0x00
 453+ 8181 66           	db 0x66
 454+ 8182 6C           	db 0x6C
 455+ 8183 78           	db 0x78
 456+ 8184 78           	db 0x78
 457+ 8185 6C           	db 0x6C
 458+ 8186 66           	db 0x66
 459+ 8187 00           	db 0x00
 460+ 8188              ; Char "L"
 461+ 8188 00           	db 0x00
 462+ 8189 60           	db 0x60
 463+ 818A 60           	db 0x60
 464+ 818B 60           	db 0x60
 465+ 818C 60           	db 0x60
 466+ 818D 60           	db 0x60
 467+ 818E 7E           	db 0x7E
 468+ 818F 00           	db 0x00
 469+ 8190              ; Char "M"
 470+ 8190 00           	db 0x00
 471+ 8191 42           	db 0x42
 472+ 8192 66           	db 0x66
 473+ 8193 7E           	db 0x7E
 474+ 8194 66           	db 0x66
 475+ 8195 66           	db 0x66
 476+ 8196 66           	db 0x66
 477+ 8197 00           	db 0x00
 478+ 8198              ; Char "N"
 479+ 8198 00           	db 0x00
 480+ 8199 46           	db 0x46
 481+ 819A 66           	db 0x66
 482+ 819B 76           	db 0x76
 483+ 819C 6E           	db 0x6E
 484+ 819D 66           	db 0x66
 485+ 819E 62           	db 0x62
 486+ 819F 00           	db 0x00
 487+ 81A0              ; Char "O"
 488+ 81A0 00           	db 0x00
 489+ 81A1 3C           	db 0x3C
 490+ 81A2 66           	db 0x66
 491+ 81A3 66           	db 0x66
 492+ 81A4 66           	db 0x66
 493+ 81A5 66           	db 0x66
 494+ 81A6 3C           	db 0x3C
 495+ 81A7 00           	db 0x00
 496+ 81A8              ; Char "P"
 497+ 81A8 00           	db 0x00
 498+ 81A9 7C           	db 0x7C
 499+ 81AA 66           	db 0x66
 500+ 81AB 66           	db 0x66
 501+ 81AC 7C           	db 0x7C
 502+ 81AD 60           	db 0x60
 503+ 81AE 60           	db 0x60
 504+ 81AF 00           	db 0x00
 505+ 81B0              ; Char "Q"
 506+ 81B0 00           	db 0x00
 507+ 81B1 3C           	db 0x3C
 508+ 81B2 66           	db 0x66
 509+ 81B3 66           	db 0x66
 510+ 81B4 66           	db 0x66
 511+ 81B5 68           	db 0x68
 512+ 81B6 36           	db 0x36
 513+ 81B7 00           	db 0x00
 514+ 81B8              ; Char "R"
 515+ 81B8 00           	db 0x00
 516+ 81B9 7C           	db 0x7C
 517+ 81BA 66           	db 0x66
 518+ 81BB 7C           	db 0x7C
 519+ 81BC 66           	db 0x66
 520+ 81BD 66           	db 0x66
 521+ 81BE 66           	db 0x66
 522+ 81BF 00           	db 0x00
 523+ 81C0              ; Char "S"
 524+ 81C0 00           	db 0x00
 525+ 81C1 3C           	db 0x3C
 526+ 81C2 60           	db 0x60
 527+ 81C3 3C           	db 0x3C
 528+ 81C4 06           	db 0x06
 529+ 81C5 46           	db 0x46
 530+ 81C6 3C           	db 0x3C
 531+ 81C7 00           	db 0x00
 532+ 81C8              ; Char "T"
 533+ 81C8 00           	db 0x00
 534+ 81C9 7E           	db 0x7E
 535+ 81CA 18           	db 0x18
 536+ 81CB 18           	db 0x18
 537+ 81CC 18           	db 0x18
 538+ 81CD 18           	db 0x18
 539+ 81CE 18           	db 0x18
 540+ 81CF 00           	db 0x00
 541+ 81D0              ; Char "U"
 542+ 81D0 00           	db 0x00
 543+ 81D1 66           	db 0x66
 544+ 81D2 66           	db 0x66
 545+ 81D3 66           	db 0x66
 546+ 81D4 66           	db 0x66
 547+ 81D5 66           	db 0x66
 548+ 81D6 3C           	db 0x3C
 549+ 81D7 00           	db 0x00
 550+ 81D8              ; Char "V"
 551+ 81D8 00           	db 0x00
 552+ 81D9 66           	db 0x66
 553+ 81DA 66           	db 0x66
 554+ 81DB 66           	db 0x66
 555+ 81DC 3C           	db 0x3C
 556+ 81DD 3C           	db 0x3C
 557+ 81DE 18           	db 0x18
 558+ 81DF 00           	db 0x00
 559+ 81E0              ; Char "W"
 560+ 81E0 00           	db 0x00
 561+ 81E1 66           	db 0x66
 562+ 81E2 66           	db 0x66
 563+ 81E3 66           	db 0x66
 564+ 81E4 7E           	db 0x7E
 565+ 81E5 66           	db 0x66
 566+ 81E6 42           	db 0x42
 567+ 81E7 00           	db 0x00
 568+ 81E8              ; Char "X"
 569+ 81E8 00           	db 0x00
 570+ 81E9 66           	db 0x66
 571+ 81EA 76           	db 0x76
 572+ 81EB 1C           	db 0x1C
 573+ 81EC 38           	db 0x38
 574+ 81ED 6E           	db 0x6E
 575+ 81EE 66           	db 0x66
 576+ 81EF 00           	db 0x00
 577+ 81F0              ; Char "Y"
 578+ 81F0 00           	db 0x00
 579+ 81F1 66           	db 0x66
 580+ 81F2 66           	db 0x66
 581+ 81F3 3C           	db 0x3C
 582+ 81F4 18           	db 0x18
 583+ 81F5 18           	db 0x18
 584+ 81F6 18           	db 0x18
 585+ 81F7 00           	db 0x00
 586+ 81F8              ; Char "Z"
 587+ 81F8 00           	db 0x00
 588+ 81F9 7E           	db 0x7E
 589+ 81FA 06           	db 0x06
 590+ 81FB 1C           	db 0x1C
 591+ 81FC 30           	db 0x30
 592+ 81FD 60           	db 0x60
 593+ 81FE 7E           	db 0x7E
 594+ 81FF 00           	db 0x00
 595+ 8200              ; Char "["
 596+ 8200 00           	db 0x00
 597+ 8201 38           	db 0x38
 598+ 8202 30           	db 0x30
 599+ 8203 30           	db 0x30
 600+ 8204 30           	db 0x30
 601+ 8205 30           	db 0x30
 602+ 8206 38           	db 0x38
 603+ 8207 00           	db 0x00
 604+ 8208              ; Char "\"
 605+ 8208 00           	db 0x00
 606+ 8209 40           	db 0x40
 607+ 820A 60           	db 0x60
 608+ 820B 30           	db 0x30
 609+ 820C 18           	db 0x18
 610+ 820D 0C           	db 0x0C
 611+ 820E 06           	db 0x06
 612+ 820F 00           	db 0x00
 613+ 8210              ; Char "]"
 614+ 8210 00           	db 0x00
 615+ 8211 38           	db 0x38
 616+ 8212 18           	db 0x18
 617+ 8213 18           	db 0x18
 618+ 8214 18           	db 0x18
 619+ 8215 18           	db 0x18
 620+ 8216 38           	db 0x38
 621+ 8217 00           	db 0x00
 622+ 8218              ; Char "^"
 623+ 8218 00           	db 0x00
 624+ 8219 18           	db 0x18
 625+ 821A 3C           	db 0x3C
 626+ 821B 66           	db 0x66
 627+ 821C 00           	db 0x00
 628+ 821D 00           	db 0x00
 629+ 821E 00           	db 0x00
 630+ 821F 00           	db 0x00
 631+ 8220              ; Char "_"
 632+ 8220 00           	db 0x00
 633+ 8221 00           	db 0x00
 634+ 8222 00           	db 0x00
 635+ 8223 00           	db 0x00
 636+ 8224 00           	db 0x00
 637+ 8225 00           	db 0x00
 638+ 8226 7E           	db 0x7E
 639+ 8227 00           	db 0x00
 640+ 8228
# file closed: ./inc/TILES.asm
  11  8228                      INCLUDE "SCREEN.asm"
# file opened: ./inc/SCREEN.asm
   1+ 8228              ;------------------------------------------------------------------------
   2+ 8228              ; Set screen charater attribute
   3+ 8228              ; INPUT:
   4+ 8228              ;   A: Value
   5+ 8228              ;   D: Character Y position
   6+ 8228              ;   E: Character X position
   7+ 8228              ; OUTPUT: -
   8+ 8228              ; MODIFIES: HL
   9+ 8228              ;------------------------------------------------------------------------
  10+ 8228              SetAttributeAtDE:
  11+ 8228 D5                   PUSH    DE
  12+ 8229 E5                   PUSH    HL
  13+ 822A C5                   PUSH    BC
  14+ 822B F5                   PUSH    AF
  15+ 822C 7A                   LD      A, D    ; Load row in A
  16+ 822D                      ; Before keeping the bits of the third, we carry out the rotations
  17+ 822D 0F                   RRCA
  18+ 822E 0F                   RRCA         ; Passes the bits of the third to bits 0 and 1
  19+ 822F 0F                   RRCA         ; and those of the row to bits 5, 6 and 7
  20+ 8230 6F                   LD      L, A    ; Load the result in L
  21+ 8231 E6 03                AND     0x03     ; A = bits of the third
  22+ 8233 F6 58                OR      0x58     ; Adds the fixed bits of the high part of the address
  23+ 8235 67                   LD      H, A    ; H = 0101 10TT
  24+ 8236 7D                   LD      A, L   ; A = row in bits 5, 6 and 7 and third in bits 0 and 1
  25+ 8237 E6 E0                AND     0xE0     ; Keeps the bits of the line
  26+ 8239 B3                   OR      E       ; Adds the bits of the column
  27+ 823A 6F                   LD      L, A    ; L = RRRC CCCC
  28+ 823B F1                   POP     AF
  29+ 823C 77                   LD      (HL),A          ; Scrivi l'attributo
  30+ 823D FE FF                CP      0xFF
  31+ 823F 20 02                JR      NZ, SetAttributeAtDE_1
  32+ 8241
  33+ 8241 36 10                LD      (HL),COLOR_RED
  34+ 8243              SetAttributeAtDE_1:
  35+ 8243
  36+ 8243
  37+ 8243
  38+ 8243 C1                   POP     BC
  39+ 8244 E1                   POP     HL
  40+ 8245 D1                   POP     DE
  41+ 8246 C9                   RET
  42+ 8247              ;------------------------------------------------------------------------
  43+ 8247              ; Print string
  44+ 8247              ; INPUT:
  45+ 8247              ;  HL: String address
  46+ 8247              ;  D: Y position
  47+ 8247              ;  E: X position
  48+ 8247              ;  B: If equals to 1 use yellow character
  49+ 8247              ; OUTPUT: -
  50+ 8247              ; MODIFIES: DE, HL, BC
  51+ 8247              ;------------------------------------------------------------------------
  52+ 8247              Screen_PrintString:
  53+ 8247 0E 47                LD      C, 0x47
  54+ 8249 78                   LD      A, B
  55+ 824A 41                   LD      B, C
  56+ 824B FE 01                CP      1
  57+ 824D 20 02                JR      NZ, Screen_PrintStringContinue
  58+ 824F 06 46                LD      B, 0x46
  59+ 8251              Screen_PrintStringContinue:
  60+ 8251 7E                   LD      A, (HL)            ; Load address of current string position to A
  61+ 8252 B7                   OR      A                  ; Flag updating in base of A value
  62+ 8253 C8                   RET     Z
  63+ 8254 F5                   PUSH    AF
  64+ 8255 78                   LD      A, B
  65+ 8256 CD 28 82             CALL SetAttributeAtDE
  66+ 8259 F1                   POP     AF
  67+ 825A F5                   PUSH    AF
  68+ 825B D6 1B                SUB     27
  69+ 825D CD AD 82             CALL Screen_PrintRamChar
  70+ 8260 F1                   POP     AF
  71+ 8261 1C                   INC     E
  72+ 8262 23                   INC     HL                 ; Current string position address set to next element
  73+ 8263 18 EC                JR   Screen_PrintStringContinue        ; Loop repeat
  74+ 8265
  75+ 8265              ;-----------------------------------------------------
  76+ 8265              ; Print space character with a specified attribute
  77+ 8265              ; INPUT:
  78+ 8265              ;   A: Attribute
  79+ 8265              ;   D: Y position
  80+ 8265              ;   E: X position
  81+ 8265              ; OUTPUT: -
  82+ 8265              ; MODIFIES: AF
  83+ 8265              ;-----------------------------------------------------
  84+ 8265              Screen_PrintSpaceChar:
  85+ 8265 D9                   EXX
  86+ 8266
  87+ 8266                      ;EX      AF,AF'
  88+ 8266 D5                   PUSH    DE
  89+ 8267                      ;EX      AF,AF'
  90+ 8267 CD 28 82             CALL    SetAttributeAtDE
  91+ 826A D1                   POP     DE
  92+ 826B                      ;EX      AF,AF'
  93+ 826B 21 00 3D             LD      HL, ROM_CHAR_SET_ADDRESS
  94+ 826E 06 00                LD      B,0
  95+ 8270 0E 00                LD      C,0
  96+ 8272 09                   ADD     HL,BC
  97+ 8273 CD F9 82             CALL    Screen_GetCharAddress
  98+ 8276 06 08                LD      B,8
  99+ 8278              PrintLoop:
 100+ 8278 7E                   LD      A,(HL)
 101+ 8279 12                   LD      (DE),A
 102+ 827A 23                   INC     HL
 103+ 827B 14                   INC     D
 104+ 827C 10 FA                DJNZ    PrintLoop
 105+ 827E D9                   EXX
 106+ 827F C9                   RET
 107+ 8280              ;------------------------------------------------------------------------
 108+ 8280              ; Load 8x8 tiles into RAM
 109+ 8280              ; INPUT: -
 110+ 8280              ; OUTPUT: -
 111+ 8280              ; MODIFIES: DE, HL, BC
 112+ 8280              ;------------------------------------------------------------------------
 113+ 8280              Screen_LoadTiles:
 114+ 8280 F3                   DI                      ; Interrupts disabled
 115+ 8281 11 40 9C             LD      DE, RAM_CHAR_SET_ADDRESS
 116+ 8284 21 00 80             LD      HL, TILES_DEF
 117+ 8287 01 28 02             LD      BC, 552
 118+ 828A ED B0                LDIR
 119+ 828C FB                   EI                      ; Interrupts enabled
 120+ 828D C9                   RET
 121+ 828E
 122+ 828E              ;------------------------------------------------------------------------
 123+ 828E              ; Clear the screen and set attributes
 124+ 828E              ; INPUT: -
 125+ 828E              ; OUTPUT: -
 126+ 828E              ; MODIFIES: AF, DE, HL, BC
 127+ 828E              ;------------------------------------------------------------------------
 128+ 828E              Screen_Clear:
 129+ 828E 3E 00                LD   A, 0           ; 0 in the lower 3 bits = black
 130+ 8290 D3 FE                OUT  (254), A       ; Send A to port 0xFE
 131+ 8292
 132+ 8292                      ;----------------------------------------------------------
 133+ 8292                      ; Clear 6144 bytes of screen pixel area (0x4000..0x57FF)
 134+ 8292                      ;----------------------------------------------------------
 135+ 8292
 136+ 8292 21 00 40             LD   HL, 0x4000      ; Start address of pixel area
 137+ 8295 11 01 40             LD   DE, 0x4001      ; DE = HL + 1 for LDIR
 138+ 8298 01 00 18             LD   BC, 6144        ; Number of bytes to clear
 139+ 829B 36 00                LD   (HL), 0         ; Store 0 in the first byte
 140+ 829D ED B0                LDIR                 ; Repeats until BC = 0 (fills with 0)
 141+ 829F
 142+ 829F                      ;----------------------------------------------------------
 143+ 829F                      ; Fill 768 bytes of attributes area (0x5800..0x5AFF)
 144+ 829F                      ; with 0x07 (white on black)
 145+ 829F                      ;----------------------------------------------------------
 146+ 829F
 147+ 829F 21 00 58             LD   HL, 0x5800      ; Start address of attributes area
 148+ 82A2 11 01 58             LD   DE, 0x5801      ; DE = HL + 1 for LDIR
 149+ 82A5 01 00 03             LD   BC, 768         ; Number of attribute bytes
 150+ 82A8 36 07                LD   (HL), 0x07      ; Attribute = 0x07 (white on black)
 151+ 82AA ED B0                LDIR                 ; Fill the attribute area with 0x07
 152+ 82AC
 153+ 82AC C9                   RET
 154+ 82AD
 155+ 82AD              ;------------------------------------------------------------------------
 156+ 82AD              ; Print a single RAM character out to a screen address
 157+ 82AD              ; INPUT:
 158+ 82AD              ;   A: Character to print
 159+ 82AD              ;   D: Character Y position
 160+ 82AD              ;   E: Character X position
 161+ 82AD              ; OUTPUT: -
 162+ 82AD              ; MODIFIES: -
 163+ 82AD              ;------------------------------------------------------------------------
 164+ 82AD              Screen_PrintRamChar:
 165+ 82AD D5                   PUSH    DE
 166+ 82AE D9                   EXX                                 ; Backup registers BC, DE, HL
 167+ 82AF D1                   POP     DE
 168+ 82B0 F5                   PUSH    AF
 169+ 82B1 21 40 9C             LD      HL, RAM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
 170+ 82B4 06 00                LD      B,0                         ; BC = character code
 171+ 82B6 4F                   LD      C, A
 172+ 82B7 CB 21                SLA     C                           ; Multiply by 8 by shifting
 173+ 82B9 CB 10                RL      B
 174+ 82BB CB 21                SLA     C
 175+ 82BD CB 10                RL      B
 176+ 82BF CB 21                SLA     C
 177+ 82C1 CB 10                RL      B
 178+ 82C3 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
 179+ 82C4 CD F9 82             CALL    Screen_GetCharAddress       ; Get screen position in DE
 180+ 82C7 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
 181+ 82C9              PrintRamCharL1:
 182+ 82C9 7E           5       LD      A,(HL)                      ; Get the byte from the ROM into A
 183+ 82CA 12                   LD      (DE),A                      ; Stick A onto the screen
 184+ 82CB 23                   INC     HL                          ; Goto next byte of character
 185+ 82CC 14                   INC     D                           ; Goto next line on screen
 186+ 82CD 10 FA                DJNZ    PrintRamCharL1              ; Loop around whilst it is Not Zero (NZ)
 187+ 82CF D9                   EXX                                 ; Restore registers BC, DE, HL
 188+ 82D0 F1                   POP     AF
 189+ 82D1 C9                   RET
 190+ 82D2              ;------------------------------------------------------------------------
 191+ 82D2              ; Print a single ROM character out to a screen address
 192+ 82D2              ; INPUT:
 193+ 82D2              ;   A: Character to print
 194+ 82D2              ;   D: Character Y position
 195+ 82D2              ;   E: Character X position
 196+ 82D2              ; OUTPUT: -
 197+ 82D2              ; MODIFIES: -
 198+ 82D2              ;------------------------------------------------------------------------
 199+ 82D2              Screen_PrintRomChar:
 200+ 82D2 D5                   PUSH    DE
 201+ 82D3 D9                   EXX                                 ; Backup registers BC, DE, HL
 202+ 82D4 D1                   POP     DE
 203+ 82D5 F5                   PUSH    AF
 204+ 82D6 21 00 3D             LD      HL, ROM_CHAR_SET_ADDRESS    ; Character set bitmap data in ROM
 205+ 82D9 06 00                LD      B,0                         ; BC = character code
 206+ 82DB D6 20                SUB     32                          ; Adjust for the character set
 207+ 82DD 4F                   LD      C, A
 208+ 82DE CB 21                SLA     C                           ; Multiply by 8 by shifting
 209+ 82E0 CB 10                RL      B
 210+ 82E2 CB 21                SLA     C
 211+ 82E4 CB 10                RL      B
 212+ 82E6 CB 21                SLA     C
 213+ 82E8 CB 10                RL      B
 214+ 82EA 09                   ADD     HL, BC                      ; And add to HL to get first byte of character
 215+ 82EB CD F9 82             CALL    Screen_GetCharAddress       ; Get screen position in DE
 216+ 82EE 06 08                LD      B,8                         ; Loop counter - 8 bytes per character
 217+ 82F0              PrintRomCharL1:
 218+ 82F0 7E                   LD      A,(HL)                      ; Get the byte from the ROM into A
 219+ 82F1 12                   LD      (DE),A                      ; Stick A onto the screen
 220+ 82F2 23                   INC     HL                          ; Goto next byte of character
 221+ 82F3 14                   INC     D                           ; Goto next line on screen
 222+ 82F4 10 FA                DJNZ    PrintRomCharL1              ; Loop around whilst it is Not Zero (NZ)
 223+ 82F6 D9                   EXX                                 ; Restore registers BC, DE, HL
 224+ 82F7 F1                   POP     AF
 225+ 82F8 C9                   RET
 226+ 82F9              ;------------------------------------------------------------------------
 227+ 82F9              ; Get screen address from a character (X,Y) coordinate
 228+ 82F9              ; INPUT:
 229+ 82F9              ;   D: Y character position (0-23)
 230+ 82F9              ;   E: X character position (0-31)
 231+ 82F9              ; OUTPUT:
 232+ 82F9              ;   DE: screen address
 233+ 82F9              ; MODIFIES: A
 234+ 82F9              ;------------------------------------------------------------------------
 235+ 82F9              Screen_GetCharAddress:
 236+ 82F9 7A                   LD      A,D
 237+ 82FA E6 07                AND     %00000111
 238+ 82FC 1F                   RRA
 239+ 82FD 1F                   RRA
 240+ 82FE 1F                   RRA
 241+ 82FF 1F                   RRA
 242+ 8300 B3                   OR      E
 243+ 8301 5F                   LD      E,A
 244+ 8302 7A                   LD      A,D
 245+ 8303 E6 18                AND     %00011000
 246+ 8305 F6 40                OR      %01000000
 247+ 8307 57                   LD      D,A
 248+ 8308 C9                   RET
 249+ 8309              ;------------------------------------------------------------------------
 250+ 8309              ; Put a 16x16 tile on the screen
 251+ 8309              ; INPUT:
 252+ 8309              ;   A: Tile number (0-255)
 253+ 8309              ;   D: Y position (0-23)
 254+ 8309              ;   E: X position (0-31)
 255+ 8309              ; OUTPUT: -
 256+ 8309              ; MODIFIES: A
 257+ 8309              ;------------------------------------------------------------------------
 258+ 8309              Screen_Print16x16Tale:
 259+ 8309 D5                   PUSH    DE
 260+ 830A F5                   PUSH    AF
 261+ 830B 3E 07                LD      A, 0x07
 262+ 830D CD 28 82             CALL    SetAttributeAtDE
 263+ 8310 F1                   POP     AF
 264+ 8311 CD AD 82             CALL    Screen_PrintRamChar        ; Print the first 8x8 tile
 265+ 8314 14                   INC     D                       ; Move to the right for the second tile
 266+ 8315 3C                   INC     A                       ; Increment the tile number
 267+ 8316 F5                   PUSH    AF
 268+ 8317 3E 07                LD      A, 0x07
 269+ 8319 CD 28 82             CALL    SetAttributeAtDE
 270+ 831C F1                   POP     AF
 271+ 831D CD AD 82             CALL    Screen_PrintRamChar        ; Print the second 8x8 tile
 272+ 8320 1C                   INC     E                       ; Move back to the left for the first tile
 273+ 8321 15                   DEC     D                       ; Move down for the next row of tiles
 274+ 8322 3C                   INC     A                       ; Increment the tile number
 275+ 8323 F5                   PUSH    AF
 276+ 8324 3E 07                LD      A, 0x07
 277+ 8326 CD 28 82             CALL    SetAttributeAtDE
 278+ 8329 F1                   POP     AF
 279+ 832A CD AD 82             CALL    Screen_PrintRamChar        ; Print the third 8x8 tile
 280+ 832D 14                   INC     D                       ; Move to the right for the second tile
 281+ 832E 3C                   INC     A                       ; Increment the tile number
 282+ 832F F5                   PUSH    AF
 283+ 8330 3E 07                LD      A, 0x07
 284+ 8332 CD 28 82             CALL    SetAttributeAtDE
 285+ 8335 F1                   POP     AF
 286+ 8336 CD AD 82             CALL    Screen_PrintRamChar        ; print the fourth 8x8 tile
 287+ 8339 D1                   POP     DE
 288+ 833A C9                   RET
 289+ 833B
 290+ 833B
 291+ 833B              ;------------------------------------------------------------------------
 292+ 833B              ; Constants
 293+ 833B              ;------------------------------------------------------------------------
 294+ 833B              SCR_BASE                        EQU 0x4000      ; Base address of the Spectrum screen
 295+ 833B              ATTR_BASE                       EQU 0x5800      ; Start of the attribute area
 296+ 833B              ROM_CHAR_SET_ADDRESS            EQU 0x3D00      ; Start of the ROM character set
 297+ 833B              RAM_CHAR_SET_ADDRESS            EQU 0x9C40      ; Start of the RAM character set
 298+ 833B              COLOR_BLACK                     EQU 0x00
 299+ 833B              COLOR_BLUE                      EQU 0x08
 300+ 833B              COLOR_YELLOW                    EQU 0x30
 301+ 833B              COLOR_CYAN                      EQU 0x28
 302+ 833B              COLOR_GREEN                     EQU 0x20
 303+ 833B              COLOR_RED                       EQU 0x10
 304+ 833B              COLOR_MAGENTA                   EQU 0x18
 305+ 833B              COLOR_WHITE                     EQU 0x38
 306+ 833B              COLOR_WALL                      EQU 0x57
 307+ 833B              ;-------------------------------------------------------------------------
 308+ 833B              ; Variables
 309+ 833B              ;-------------------------------------------------------------------------
 310+ 833B
# file closed: ./inc/SCREEN.asm
  12  833B                      INCLUDE "INPUTS.asm"
# file opened: ./inc/INPUTS.asm
   1+ 833B              ; ===================================================================
   2+ 833B              ; Inputs
   3+ 833B              ; ===================================================================
   4+ 833B
   5+ 833B              ; -----------------------------------------------------------------------------
   6+ 833B              ; CheckInput
   7+ 833B              ; -----------------------------------------------------------------------------
   8+ 833B              ; Reads Kempston joystick (port #1F) and the keyboard (Q, A, O, P).
   9+ 833B              ; Returns in A one of these values:
  10+ 833B              ;   0..7 => direction pressed
  11+ 833B              ;   255 => no direction
  12+ 833B              ;
  13+ 833B              ; Kempston bits:
  14+ 833B              ;   bit0=right, bit1=left, bit2=down, bit3=up
  15+ 833B              ; We decode to 8 directions with possible diagonals.
  16+ 833B              ;
  17+ 833B              ; If no joystick direction, we scan the keys:
  18+ 833B              ;   Q => up,    A => down
  19+ 833B              ;   O => left,  P => right
  20+ 833B              ; Combinations => diagonals.
  21+ 833B              ;
  22+ 833B              ; The code is just an example. Adapt it as needed.
  23+ 833B              ; -----------------------------------------------------------------------------
  24+ 833B
  25+ 833B              CheckInput:
  26+ 833B
  27+ 833B                  ; 1) Read Kempston joystick
  28+ 833B                  ;IN    A,(#1F)      ; read port #1F into A
  29+ 833B                  ;AND   #0F          ; we only care about bits 0..3
  30+ 833B                  ;CP    0
  31+ 833B                  ;JR    NZ,DecodeJoystick
  32+ 833B
  33+ 833B                  ; if A=0 => no joystick direction => check keyboard
  34+ 833B C3 B4 94         JP    ReadKeyboard
  35+ 833E
  36+ 833E              ; -----------------------------------------------------------------------------
  37+ 833E              ; DecodeJoystick: bits 3..0 => up,down,left,right => produce a direction
  38+ 833E              ; -----------------------------------------------------------------------------
  39+ 833E              DecodeJoystick:
  40+ 833E 47               LD    B,A        ; keep a copy in B
  41+ 833F                  ; bit3=up=8, bit2=down=4, bit1=left=2, bit0=right=1
  42+ 833F
  43+ 833F                  ; We want to combine them for diagonals: up+left => 4, up+right => 5, etc.
  44+ 833F                  ; E.g. if bit3 & bit1 => up-left => direction=4
  45+ 833F                  ; We'll do a simple check approach:
  46+ 833F
  47+ 833F 3E FF            LD    A,#FF      ; default = none, we'll override
  48+ 8341                  ; check if up
  49+ 8341 CB 58            BIT   3,B
  50+ 8343 28 11            JR    Z,NoUp
  51+ 8345                  ; up=1
  52+ 8345                  ; check if left
  53+ 8345 CB 48            BIT   1,B
  54+ 8347 20 07            JR    NZ,UpLeft
  55+ 8349                  ; check if right
  56+ 8349 CB 40            BIT   0,B
  57+ 834B 20 06            JR    NZ,UpRight
  58+ 834D                  ; otherwise pure up
  59+ 834D 3E 02            LD    A,2
  60+ 834F C9               RET
  61+ 8350              UpLeft:
  62+ 8350 3E 04            LD    A,4
  63+ 8352 C9               RET
  64+ 8353              UpRight:
  65+ 8353 3E 05            LD    A,5
  66+ 8355 C9               RET
  67+ 8356              NoUp:
  68+ 8356                  ; check if down
  69+ 8356 CB 50            BIT   2,B
  70+ 8358 28 11            JR    Z,NoDown
  71+ 835A                  ; down=1
  72+ 835A                  ; check if left
  73+ 835A CB 48            BIT   1,B
  74+ 835C 20 07            JR    NZ,DownLeft
  75+ 835E                  ; check if right
  76+ 835E CB 40            BIT   0,B
  77+ 8360 20 06            JR    NZ,DownRight
  78+ 8362                  ; otherwise pure down
  79+ 8362 3E 03            LD    A,3
  80+ 8364 C9               RET
  81+ 8365              DownLeft:
  82+ 8365 3E 06            LD    A,6
  83+ 8367 C9               RET
  84+ 8368              DownRight:
  85+ 8368 3E 07            LD    A,7
  86+ 836A C9               RET
  87+ 836B              NoDown:
  88+ 836B                  ; no up, no down => check left or right
  89+ 836B CB 48            BIT   1,B
  90+ 836D 20 07            JR    NZ,JustLeft
  91+ 836F CB 40            BIT   0,B
  92+ 8371 20 06            JR    NZ,JustRight
  93+ 8373                  ; if we get here => something else, but we said bits 0..3 => must be 0 => not possible
  94+ 8373 3E FF            LD    A,#FF
  95+ 8375 C9               RET
  96+ 8376              JustLeft:
  97+ 8376 3E 00            LD    A,0
  98+ 8378 C9               RET
  99+ 8379              JustRight:
 100+ 8379 3E 01            LD    A,1
 101+ 837B C9               RET
 102+ 837C
# file closed: ./inc/INPUTS.asm
  13  837C                      INCLUDE "FP_UTILS.asm"
# file opened: ./inc/FP_UTILS.asm
   1+ 837C              ;**************************************************************************
   2+ 837C              ;* FP UTILITIES                                                           *
   3+ 837C              ;**************************************************************************
   4+ 837C
   5+ 837C
   6+ 837C              ;============================================================
   7+ 837C              ; STRING UTILITIES
   8+ 837C              ;============================================================
   9+ 837C
  10+ 837C              ;--------------------------------------------------------------------------
  11+ 837C              ; *** String_NumberToASCII ***
  12+ 837C              ; Convert a 16-bit unsigned number to a string of ASCII digits.
  13+ 837C              ;---------------------------------------------------------------------------
  14+ 837C              ; INPUT:
  15+ 837C              ;   HL = the 16-bit unsigned number to convert.
  16+ 837C              ; OUTPUT: -
  17+ 837C              ; MODIFY: HL, DE, BC, AF
  18+ 837C              ;--------------------------------------------------------------------------
  19+ 837C              String_NumberToASCII:
  20+ 837C 01 F0 D8        LD       BC,-10000
  21+ 837F CD 95 83        CALL     .Num1
  22+ 8382 01 18 FC        LD       BC,-1000
  23+ 8385 CD 95 83        CALL     .Num1
  24+ 8388 01 9C FF        LD       BC,-100
  25+ 838B CD 95 83        CALL     .Num1
  26+ 838E 0E F6           LD       C,-10
  27+ 8390 CD 95 83        CALL     .Num1
  28+ 8393 0E FF           LD       C,-1
  29+ 8395              .Num1:
  30+ 8395 3E 2F           LD       A,'0'-1
  31+ 8397              .Num2:
  32+ 8397 3C              INC      A
  33+ 8398 09              ADD      HL, BC
  34+ 8399 38 FC           JR       C, .Num2
  35+ 839B ED 42           SBC      HL, BC
  36+ 839D 12              LD       (DE), A
  37+ 839E 13              INC      DE
  38+ 839F C9              RET
  39+ 83A0
  40+ 83A0              ;---------------------------------------------------------------------
  41+ 83A0              ; *** String_RemoveLeadingZeros ***
  42+ 83A0              ; Remove leading zeros from the string
  43+ 83A0              ;----------------------------------------------------------------------
  44+ 83A0              ; INPUT:
  45+ 83A0              ;   HL: Pointer to the string
  46+ 83A0              ; OUTPUT: -
  47+ 83A0              ; MODIFY: HL, AF, BC
  48+ 83A0              ;---------------------------------------------------------------------
  49+ 83A0              String_RemoveLeadingZeros:
  50+ 83A0 CD B3 83         CALL    String_GetLength  ; Get the length of the string
  51+ 83A3 47               LD      B, A            ; Set B to the number of digits
  52+ 83A4              .Loop:
  53+ 83A4                  ; Check if we are at the last digit; if so, exit.
  54+ 83A4 78               LD      A, B
  55+ 83A5 FE 01            CP      1
  56+ 83A7 C8               RET     Z
  57+ 83A8                  ; Load the current character.
  58+ 83A8 7E               LD      A, (HL)
  59+ 83A9 FE 30            CP      '0'
  60+ 83AB C0               RET     NZ  ; If the character is not '0', we've reached the first
  61+ 83AC                                        ; nonzero digit; stop replacing.
  62+ 83AC                  ; Replace the '0' with a space.
  63+ 83AC 3E 20            LD       A, ' '
  64+ 83AE 77               LD      (HL), A
  65+ 83AF 23               INC     HL              ; Advance to the next character.
  66+ 83B0 05               DEC     B               ; Decrement the digit counter.
  67+ 83B1 18 F1            JR      .Loop
  68+ 83B3
  69+ 83B3
  70+ 83B3              ;---------------------------------------------------------------------
  71+ 83B3              ; *** String_GetLength ***
  72+ 83B3              ; Get the length of a string in bytes
  73+ 83B3              ;----------------------------------------------------------------------
  74+ 83B3              ; INPUT:
  75+ 83B3              ;   HL: Pointer to the string
  76+ 83B3              ; OUTPUT: -
  77+ 83B3              ; MODIFY: HL, AF, BC
  78+ 83B3              ;---------------------------------------------------------------------
  79+ 83B3              String_GetLength:
  80+ 83B3 E5               PUSH    HL          ; save HL
  81+ 83B4 AF               XOR     A           ; A = 0
  82+ 83B5 47               LD      B, A        ; B = 0 (length counter)
  83+ 83B6
  84+ 83B6              .Loop:
  85+ 83B6 7E               LD      A, (HL)     ; load byte
  86+ 83B7 B7               OR      A           ; set Z if it’s zero
  87+ 83B8 28 04            JR      Z, .Done
  88+ 83BA 04               INC     B           ; increment length
  89+ 83BB 23               INC     HL
  90+ 83BC 18 F8            JR      .Loop
  91+ 83BE
  92+ 83BE              .Done:
  93+ 83BE E1               POP     HL          ; restore HL
  94+ 83BF 78               LD      A, B        ; return length in A
  95+ 83C0 C9               RET
  96+ 83C1
  97+ 83C1              ;================================================================
  98+ 83C1              ; MATH UTILITIES
  99+ 83C1              ;================================================================
 100+ 83C1
 101+ 83C1
 102+ 83C1              ;-----------------------------------------------------------------------
 103+ 83C1              ; *** Math_AddAToHL ***
 104+ 83C1              ; Adds the 8‑bit value in A to HL
 105+ 83C1              ;-----------------------------------------------------------------------
 106+ 83C1              ; INPUT:
 107+ 83C1              ;   A:  Value to add
 108+ 83C1              ;   HL: Pointer to the variable
 109+ 83C1              ; OUTPUT:
 110+ 83C1              ;   HL: HL + A
 111+ 83C1              ; MODIFY: A, BC
 112+ 83C1              ;-----------------------------------------------------------------------
 113+ 83C1              Math_AddAToHL:
 114+ 83C1 06 00            LD    B, 0        ; B = 0
 115+ 83C3 4F               LD    C, A     ; C = A
 116+ 83C4 09               ADD   HL, BC   ; HL = HL + BC = HL + A
 117+ 83C5 C9               RET
 118+ 83C6
 119+ 83C6              ;--------------------------------------------------------------------------
 120+ 83C6              ; *** Math_CompareHLtoBC ***
 121+ 83C6              ; Compare the 16‑bit unsigned value in HL with the 16‑bit unsigned value in BC
 122+ 83C6              ;--------------------------------------------------------------------------
 123+ 83C6              ; INPUT:
 124+ 83C6              ;   HL: first 16‑bit value
 125+ 83C6              ;   BC: second 16‑bit value
 126+ 83C6              ;
 127+ 83C6              ; OUTPUT:
 128+ 83C6              ;   A: Comparison result (1->HL>BC, 2->HL<BC, 0->HL=BC)
 129+ 83C6              ; MODIFY: AF
 130+ 83C6              ;--------------------------------------------------------------------------
 131+ 83C6              Math_CompareHLtoBC:
 132+ 83C6 7C               LD   A, H               ; A ← high byte of HL
 133+ 83C7 B8               CP   B                  ; compare with high byte of BC
 134+ 83C8 28 05            JR   Z, .CompareLow      ; if H == B, compare low bytes
 135+ 83CA 38 0C            JR   C, .SetLess         ; if H < B, HL < BC
 136+ 83CC                  ; else H > B ⇒ HL > BC
 137+ 83CC 3E 01            LD   A, 1
 138+ 83CE C9               RET
 139+ 83CF
 140+ 83CF              .CompareLow:
 141+ 83CF 7D               LD   A, L               ; A ← low byte of HL
 142+ 83D0 B9               CP   C                  ; compare with low byte of BC
 143+ 83D1 28 08            JR   Z, .SetEqual        ; if L == C, HL == BC
 144+ 83D3 38 03            JR   C, .SetLess         ; if L < C, HL < BC
 145+ 83D5                  ; else L > C ⇒ HL > BC
 146+ 83D5 3E 01            LD   A, 1
 147+ 83D7 C9               RET
 148+ 83D8
 149+ 83D8              .SetLess:
 150+ 83D8 3E 02            LD   A, 2
 151+ 83DA C9               RET
 152+ 83DB
 153+ 83DB              .SetEqual:
 154+ 83DB AF               XOR  A                  ; A = 0
 155+ 83DC C9               RET
 156+ 83DD
 157+ 83DD              ;------------------------------------------------------------------------------
 158+ 83DD              ; *** Math_DivisibleCheck ***
 159+ 83DD              ; Checks whether the 8‑bit value in B is exactly divisible by the 8‑bit value in C
 160+ 83DD              ;--------------------------------------------------------------------------------
 161+ 83DD              ; INPUT:
 162+ 83DD              ;   B = dividend
 163+ 83DD              ;   C = divisor
 164+ 83DD              ; OUTPUT:
 165+ 83DD              ;   A: 1 if B is divisible by C else 0
 166+ 83DD              ;------------------------------------------------------------------------------
 167+ 83DD              Math_DivisibleCheck:
 168+ 83DD                  ; 1) If divisor C = 0, cannot divide → return A=0
 169+ 83DD 79               LD   A, C
 170+ 83DE B7               OR   A
 171+ 83DF 28 10            JR   Z, .NotDivisible
 172+ 83E1
 173+ 83E1                  ; 2) If dividend B = 0, 0 is divisible by any nonzero C → return A=1
 174+ 83E1 78               LD   A, B
 175+ 83E2 B7               OR   A
 176+ 83E3 28 09            JR   Z, .Divisible
 177+ 83E5
 178+ 83E5                  ; 3) Main loop: subtract C repeatedly from A until A < C
 179+ 83E5              .Loop:
 180+ 83E5 B9               CP   C               ; compare A (current remainder) with C
 181+ 83E6 38 09            JR   C, .NotDivisible; if A < C then remainder ≠ 0 → not divisible
 182+ 83E8 91               SUB  C               ; A = A - C
 183+ 83E9 B7               OR   A               ; set Z if A == 0
 184+ 83EA 28 02            JR   Z, .Divisible   ; if exact zero remainder, divisible
 185+ 83EC 18 F7            JR   .Loop           ; otherwise repeat
 186+ 83EE
 187+ 83EE              .Divisible:
 188+ 83EE 3E 01            LD   A, 1
 189+ 83F0 C9               RET
 190+ 83F1
 191+ 83F1              .NotDivisible:
 192+ 83F1 AF               XOR  A               ; A = 0
 193+ 83F2 C9               RET
 194+ 83F3
# file closed: ./inc/FP_UTILS.asm
  14  83F3                      INCLUDE "GAMESUBS.asm"
# file opened: ./inc/GAMESUBS.asm
   1+ 83F3              ; ===================================================================
   2+ 83F3              ; Game subroutines
   3+ 83F3              ; ===================================================================
   4+ 83F3
   5+ 83F3              ; --------------------------------------------------
   6+ 83F3              ; Play beep
   7+ 83F3              ; INPUT:
   8+ 83F3              ;   B: Number of toggles
   9+ 83F3              ;   C: Delay loop
  10+ 83F3              ; --------------------------------------------------
  11+ 83F3              PlayBeep:
  12+ 83F3 C5               PUSH BC
  13+ 83F4 3E 10            LD   A, 16          ; 0001 0000 → beeper ON
  14+ 83F6              .BeepLoop:
  15+ 83F6 D3 FE            OUT  (254), A       ; accendi
  16+ 83F8 CD 06 84         CALL DelayHalf
  17+ 83FB AF               XOR  A              ; A=0 → beeper OFF
  18+ 83FC D3 FE            OUT  (254), A       ; spegni
  19+ 83FE CD 06 84         CALL DelayHalf
  20+ 8401 05               DEC  B
  21+ 8402 20 F2            JR   NZ, .BeepLoop
  22+ 8404 C1               POP  BC
  23+ 8405 C9               RET
  24+ 8406
  25+ 8406              DelayHalf:
  26+ 8406 51               LD   D, C
  27+ 8407              .DH:
  28+ 8407 15               DEC  D
  29+ 8408 20 FD            JR   NZ, .DH
  30+ 840A C9               RET
  31+ 840B
  32+ 840B              ; --------------------------------------------------
  33+ 840B              ; Line completed sound
  34+ 840B              ; INPUT: -
  35+ 840B              ; OUTPUT: -
  36+ 840B              ; MODIFY: AF, DE, HL, BC
  37+ 840B              ; --------------------------------------------------
  38+ 840B              GameOverSound:
  39+ 840B                  ; Primo beep grave, lungo
  40+ 840B 06 50            ld   b, 80      ; durata: 80 toggles
  41+ 840D 0E A0            ld   c, 160     ; frequenza: delay lungo → tono molto grave
  42+ 840F CD F3 83         call PlayBeep
  43+ 8412
  44+ 8412                  ; Secondo beep medio, più corto
  45+ 8412 06 3C            ld   b, 60      ; durata: 60 toggles
  46+ 8414 0E 64            ld   c, 100     ; frequenza: delay medio → tono intermedio
  47+ 8416 CD F3 83         call PlayBeep
  48+ 8419
  49+ 8419                  ; Terzo beep acuto, breve
  50+ 8419 06 28            ld   b, 40      ; durata: 40 toggles
  51+ 841B 0E 28            ld   c,  40     ; frequenza: delay breve → tono acuto
  52+ 841D CD F3 83         call PlayBeep
  53+ 8420
  54+ 8420 C9               ret
  55+ 8421              ; --------------------------------------------------
  56+ 8421              ; Line completed sound
  57+ 8421              ; INPUT: -
  58+ 8421              ; OUTPUT: -
  59+ 8421              ; MODIFY: AF, DE, HL, BC
  60+ 8421              ; --------------------------------------------------
  61+ 8421              LineCompleteSound:
  62+ 8421 06 28            LD   B,  40         ; durata: 40 toggles
  63+ 8423 0E 0F            LD   C,  15         ; frequenza: delay breve → tono acuto
  64+ 8425 CD F3 83         CALL PlayBeep
  65+ 8428 C9               RET
  66+ 8429
  67+ 8429              ; --------------------------------------------------
  68+ 8429              ; Bkloc land sound
  69+ 8429              ; --------------------------------------------------
  70+ 8429              BlockLandSound:
  71+ 8429 06 3C            LD   b,  60         ; durata: 60 toggles
  72+ 842B 0E 78            LD   c, 120         ; frequenza: delay lungo → tono grave
  73+ 842D CD F3 83         CALL PlayBeep
  74+ 8430 C9               RET
  75+ 8431              ;--------------------------------------------------
  76+ 8431              ; Play menu music
  77+ 8431              ; INPUT: -
  78+ 8431              ; OUTPUT: -
  79+ 8431              ; MODIFY: AF, DE, HL, BC
  80+ 8431              ;--------------------------------------------------
  81+ 8431              PlayInGameMusic:
  82+ 8431                      ; The next section of code plays a note of the in-game music.
  83+ 8431
  84+ 8431 3A DE 99         LD A,(MusicNoteIndex)                    ; Increment the in-game music note index.
  85+ 8434 3C               INC A
  86+ 8435 32 DE 99         LD (MusicNoteIndex),A
  87+ 8438 E6 7E            AND 126
  88+ 843A 0F               RRCA
  89+ 843B 5F               LD E,A
  90+ 843C 16 00            LD D,$00
  91+ 843E 21 93 98         LD HL,InGameTuneData                     ; Point HL at the appropriate entry in the tune data table at
  92+ 8441 19               ADD HL,DE                                ; InGameTuneData.
  93+ 8442 3A 20 00         LD A,(0x20)                       ; Pick up the border colour for the current cavern.
  94+ 8445 5E               LD E,(HL)                                ; Initialise the pitch delay counter in E.
  95+ 8446 01 03 00         LD BC,$03                                ; Initialise the duration delay counters in B (0) and C (3).
  96+ 8449              PlayInGameMusic12:
  97+ 8449 D3 FE            OUT (254),A                              ; Produce a note of the in-game music.
  98+ 844B 1D               DEC E
  99+ 844C 20 03            JR NZ,PlayInGameMusic13
 100+ 844E 5E               LD E,(HL)
 101+ 844F EE 18            XOR 24
 102+ 8451              PlayInGameMusic13:
 103+ 8451 10 F6            DJNZ PlayInGameMusic12
 104+ 8453 0D               DEC C
 105+ 8454 20 F3            JR NZ,PlayInGameMusic12
 106+ 8456 C9               RET
 107+ 8457
 108+ 8457              ;---------------------------------------------------------------------
 109+ 8457              ; Fill score area
 110+ 8457              ; INPUT: -
 111+ 8457              ; OUTPUT: -
 112+ 8457              ; MODIFY: AF, DE, HL, BC
 113+ 8457              ;---------------------------------------------------------------------
 114+ 8457              FillScoreArea:
 115+ 8457 3A 7F 99         LD      A, (CurrentMatrixOrientation)
 116+ 845A FE 02            CP      ORIENT_EAST
 117+ 845C CA B3 84         JP      Z, FillScoreAreaEast
 118+ 845F FE 03            CP      ORIENT_WEST
 119+ 8461 CA 11 85         JP      Z, FillScoreAreaWest
 120+ 8464 FE 00            CP      ORIENT_NORTH
 121+ 8466 CA 6F 85         JP      Z, FillScoreAreaNorth
 122+ 8469              FillScoreAreaSouth:
 123+ 8469 21 FA 96         LD      HL, TEXT_SCORE
 124+ 846C 16 02            LD      D, 2
 125+ 846E 1E 1A            LD      E, 26
 126+ 8470 CD 47 82         CALL    Screen_PrintString
 127+ 8473
 128+ 8473 21 00 97         LD      HL, TEXT_HIGH_SCORE_1
 129+ 8476 16 06            LD      D, 6
 130+ 8478 1E 1A            LD      E, 26
 131+ 847A CD 47 82         CALL    Screen_PrintString
 132+ 847D 21 06 97         LD      HL, TEXT_HIGH_SCORE_2
 133+ 8480 16 07            LD      D, 7
 134+ 8482 1E 1A            LD      E, 26
 135+ 8484 CD 47 82         CALL    Screen_PrintString
 136+ 8487
 137+ 8487
 138+ 8487 21 33 97         LD      HL, TEXT_BLOCKS
 139+ 848A 16 0B            LD      D, 11
 140+ 848C 1E 1A            LD      E, 26
 141+ 848E CD 47 82         CALL    Screen_PrintString
 142+ 8491
 143+ 8491 21 39 97         LD      HL, TEXT_MAX_BLOCKS
 144+ 8494 16 0F            LD      D, 15
 145+ 8496 1E 1A            LD      E, 26
 146+ 8498 CD 47 82         CALL    Screen_PrintString
 147+ 849B 21 33 97         LD      HL, TEXT_BLOCKS
 148+ 849E 16 10            LD      D, 16
 149+ 84A0 1E 1A            LD      E, 26
 150+ 84A2 CD 47 82         CALL    Screen_PrintString
 151+ 84A5
 152+ 84A5 21 0C 97         LD      HL, TEXT_LEVEL
 153+ 84A8 16 14            LD      D, 20
 154+ 84AA 1E 1A            LD      E, 26
 155+ 84AC CD 47 82         CALL    Screen_PrintString
 156+ 84AF
 157+ 84AF CD CF 87         CALL    ScoreUpdate
 158+ 84B2 C9               RET
 159+ 84B3              FillScoreAreaEast:
 160+ 84B3 21 FA 96         LD      HL, TEXT_SCORE
 161+ 84B6 16 01            LD      D, 1
 162+ 84B8 1E 01            LD      E, 1
 163+ 84BA CD 47 82         CALL    Screen_PrintString
 164+ 84BD 21 F4 96         LD      HL, TEXT_EMPTY5
 165+ 84C0 16 02            LD      D, 2
 166+ 84C2 1E 01            LD      E, 1
 167+ 84C4 CD 47 82         CALL    Screen_PrintString
 168+ 84C7
 169+ 84C7
 170+ 84C7 21 00 97         LD      HL, TEXT_HIGH_SCORE_1
 171+ 84CA 16 01            LD      D, 1
 172+ 84CC 1E 0A            LD      E, 10
 173+ 84CE CD 47 82         CALL    Screen_PrintString
 174+ 84D1 21 06 97         LD      HL, TEXT_HIGH_SCORE_2
 175+ 84D4 16 02            LD      D, 2
 176+ 84D6 1E 0A            LD      E, 10
 177+ 84D8 CD 47 82         CALL    Screen_PrintString
 178+ 84DB
 179+ 84DB
 180+ 84DB 21 33 97         LD      HL, TEXT_BLOCKS
 181+ 84DE 16 01            LD      D, 1
 182+ 84E0 1E 12            LD      E, 18
 183+ 84E2 CD 47 82         CALL    Screen_PrintString
 184+ 84E5 21 F4 96         LD      HL, TEXT_EMPTY5
 185+ 84E8 16 02            LD      D, 2
 186+ 84EA 1E 12            LD      E, 18
 187+ 84EC CD 47 82         CALL    Screen_PrintString
 188+ 84EF
 189+ 84EF 21 39 97         LD      HL, TEXT_MAX_BLOCKS
 190+ 84F2 16 01            LD      D, 1
 191+ 84F4 1E 1A            LD      E, 26
 192+ 84F6 CD 47 82         CALL    Screen_PrintString
 193+ 84F9 21 33 97         LD      HL, TEXT_BLOCKS
 194+ 84FC 16 02            LD      D, 2
 195+ 84FE 1E 1A            LD      E, 26
 196+ 8500 CD 47 82         CALL    Screen_PrintString
 197+ 8503
 198+ 8503 21 0C 97         LD      HL, TEXT_LEVEL
 199+ 8506 16 15            LD      D, 21
 200+ 8508 1E 01            LD      E, 1
 201+ 850A CD 47 82         CALL    Screen_PrintString
 202+ 850D
 203+ 850D CD CF 87         CALL    ScoreUpdate
 204+ 8510 C9               RET
 205+ 8511              FillScoreAreaWest:
 206+ 8511 21 FA 96         LD      HL, TEXT_SCORE
 207+ 8514 16 14            LD      D, 20
 208+ 8516 1E 01            LD      E, 1
 209+ 8518 CD 47 82         CALL    Screen_PrintString
 210+ 851B 21 F4 96         LD      HL, TEXT_EMPTY5
 211+ 851E 16 15            LD      D, 21
 212+ 8520 1E 01            LD      E, 1
 213+ 8522 CD 47 82         CALL    Screen_PrintString
 214+ 8525
 215+ 8525
 216+ 8525 21 00 97         LD      HL, TEXT_HIGH_SCORE_1
 217+ 8528 16 14            LD      D, 20
 218+ 852A 1E 0A            LD      E, 10
 219+ 852C CD 47 82         CALL    Screen_PrintString
 220+ 852F 21 06 97         LD      HL, TEXT_HIGH_SCORE_2
 221+ 8532 16 15            LD      D, 21
 222+ 8534 1E 0A            LD      E, 10
 223+ 8536 CD 47 82         CALL    Screen_PrintString
 224+ 8539
 225+ 8539
 226+ 8539 21 33 97         LD      HL, TEXT_BLOCKS
 227+ 853C 16 14            LD      D, 20
 228+ 853E 1E 12            LD      E, 18
 229+ 8540 CD 47 82         CALL    Screen_PrintString
 230+ 8543 21 F4 96         LD      HL, TEXT_EMPTY5
 231+ 8546 16 15            LD      D, 21
 232+ 8548 1E 12            LD      E, 18
 233+ 854A CD 47 82         CALL    Screen_PrintString
 234+ 854D
 235+ 854D 21 39 97         LD      HL, TEXT_MAX_BLOCKS
 236+ 8550 16 14            LD      D, 20
 237+ 8552 1E 1A            LD      E, 26
 238+ 8554 CD 47 82         CALL    Screen_PrintString
 239+ 8557 21 33 97         LD      HL, TEXT_BLOCKS
 240+ 855A 16 15            LD      D, 21
 241+ 855C 1E 1A            LD      E, 26
 242+ 855E CD 47 82         CALL    Screen_PrintString
 243+ 8561
 244+ 8561 21 0C 97         LD      HL, TEXT_LEVEL
 245+ 8564 16 01            LD      D, 1
 246+ 8566 1E 1A            LD      E, 26
 247+ 8568 CD 47 82         CALL    Screen_PrintString
 248+ 856B
 249+ 856B CD CF 87         CALL    ScoreUpdate
 250+ 856E C9               RET
 251+ 856F              FillScoreAreaNorth:
 252+ 856F 21 FA 96         LD      HL, TEXT_SCORE
 253+ 8572 16 02            LD      D, 2
 254+ 8574 1E 01            LD      E, 1
 255+ 8576 CD 47 82         CALL    Screen_PrintString
 256+ 8579
 257+ 8579 21 00 97         LD      HL, TEXT_HIGH_SCORE_1
 258+ 857C 16 06            LD      D, 6
 259+ 857E 1E 01            LD      E, 1
 260+ 8580 CD 47 82         CALL    Screen_PrintString
 261+ 8583 21 06 97         LD      HL, TEXT_HIGH_SCORE_2
 262+ 8586 16 07            LD      D, 7
 263+ 8588 1E 01            LD      E, 1
 264+ 858A CD 47 82         CALL    Screen_PrintString
 265+ 858D
 266+ 858D
 267+ 858D 21 33 97         LD      HL, TEXT_BLOCKS
 268+ 8590 16 0B            LD      D, 11
 269+ 8592 1E 01            LD      E, 1
 270+ 8594 CD 47 82         CALL    Screen_PrintString
 271+ 8597
 272+ 8597 21 39 97         LD      HL, TEXT_MAX_BLOCKS
 273+ 859A 16 0F            LD      D, 15
 274+ 859C 1E 01            LD      E, 1
 275+ 859E CD 47 82         CALL    Screen_PrintString
 276+ 85A1 21 33 97         LD      HL, TEXT_BLOCKS
 277+ 85A4 16 10            LD      D, 16
 278+ 85A6 1E 01            LD      E, 1
 279+ 85A8 CD 47 82         CALL    Screen_PrintString
 280+ 85AB
 281+ 85AB 21 0C 97         LD      HL, TEXT_LEVEL
 282+ 85AE 16 14            LD      D, 20
 283+ 85B0 1E 01            LD      E, 1
 284+ 85B2 CD 47 82         CALL    Screen_PrintString
 285+ 85B5
 286+ 85B5 CD CF 87         CALL    ScoreUpdate
 287+ 85B8 C9               RET
 288+ 85B9
 289+ 85B9              ;---------------------------------------------------------------------
 290+ 85B9              ; Display score update
 291+ 85B9              ; INPUT: -
 292+ 85B9              ; OUTPUT: -
 293+ 85B9              ; MODIFY: AF, DE, HL, BC
 294+ 85B9              ;---------------------------------------------------------------------
 295+ 85B9              DisplayScoreUpdate:
 296+ 85B9 3A 7F 99         LD      A, (CurrentMatrixOrientation)
 297+ 85BC FE 02            CP      ORIENT_EAST
 298+ 85BE CA CD 86         JP      Z, DisplayScoreUpdateEast
 299+ 85C1 FE 03            CP      ORIENT_WEST
 300+ 85C3 CA 4E 87         JP      Z, DisplayScoreUpdateWest
 301+ 85C6 FE 00            CP      ORIENT_NORTH
 302+ 85C8 CA 4C 86         JP      Z, DisplayScoreUpdateNorth
 303+ 85CB
 304+ 85CB              DisplayScoreUpdateSouth:
 305+ 85CB 2A A0 99         LD      HL, (Score)
 306+ 85CE 11 D1 99         LD      DE, NumberValue
 307+ 85D1 CD 7C 83         CALL    String_NumberToASCII
 308+ 85D4 21 D1 99         LD      HL, NumberValue
 309+ 85D7 CD A0 83         CALL    String_RemoveLeadingZeros
 310+ 85DA 21 D1 99         LD      HL, NumberValue
 311+ 85DD 16 03            LD      D, 3
 312+ 85DF 1E 1A            LD      E, 26
 313+ 85E1 CD 47 82         CALL    Screen_PrintString
 314+ 85E4
 315+ 85E4 2A A2 99         LD      HL, (HighScore)
 316+ 85E7 11 D1 99         LD      DE, NumberValue
 317+ 85EA CD 7C 83         CALL    String_NumberToASCII
 318+ 85ED 21 D1 99         LD      HL, NumberValue
 319+ 85F0 CD A0 83         CALL    String_RemoveLeadingZeros
 320+ 85F3 21 D1 99         LD      HL, NumberValue
 321+ 85F6 16 08            LD      D, 8
 322+ 85F8 1E 1A            LD      E, 26
 323+ 85FA CD 47 82         CALL    Screen_PrintString
 324+ 85FD
 325+ 85FD
 326+ 85FD 2A CD 99         LD      HL, (PlacedBlocks)
 327+ 8600 11 D1 99         LD      DE, NumberValue
 328+ 8603 CD 7C 83         CALL    String_NumberToASCII
 329+ 8606 21 D1 99         LD      HL, NumberValue
 330+ 8609 CD A0 83         CALL    String_RemoveLeadingZeros
 331+ 860C 21 D1 99         LD      HL, NumberValue
 332+ 860F 16 0C            LD      D, 12
 333+ 8611 1E 1A            LD      E, 26
 334+ 8613 CD 47 82         CALL    Screen_PrintString
 335+ 8616
 336+ 8616 2A CF 99         LD      HL, (MaxPlacedBlocks)
 337+ 8619 11 D1 99         LD      DE, NumberValue
 338+ 861C CD 7C 83         CALL    String_NumberToASCII
 339+ 861F 21 D1 99         LD      HL, NumberValue
 340+ 8622 CD A0 83         CALL    String_RemoveLeadingZeros
 341+ 8625 21 D1 99         LD      HL, NumberValue
 342+ 8628 16 01            LD      D, 1
 343+ 862A 1E 1A            LD      E, 26
 344+ 862C CD 47 82         CALL    Screen_PrintString
 345+ 862F
 346+ 862F 3A A4 99         LD      A, (Level)
 347+ 8632 26 00            LD      H, 0
 348+ 8634 6F               LD      L, A
 349+ 8635 11 D1 99         LD      DE, NumberValue
 350+ 8638 CD 7C 83         CALL    String_NumberToASCII
 351+ 863B 21 D1 99         LD      HL, NumberValue
 352+ 863E CD A0 83         CALL    String_RemoveLeadingZeros
 353+ 8641 21 D1 99         LD      HL, NumberValue
 354+ 8644 16 15            LD      D, 21
 355+ 8646 1E 1A            LD      E, 26
 356+ 8648 CD 47 82         CALL    Screen_PrintString
 357+ 864B C9               RET
 358+ 864C              DisplayScoreUpdateNorth:
 359+ 864C 2A A0 99         LD      HL, (Score)
 360+ 864F 11 D1 99         LD      DE, NumberValue
 361+ 8652 CD 7C 83         CALL    String_NumberToASCII
 362+ 8655 21 D1 99         LD      HL, NumberValue
 363+ 8658 CD A0 83         CALL    String_RemoveLeadingZeros
 364+ 865B 21 D1 99         LD      HL, NumberValue
 365+ 865E 16 03            LD      D, 3
 366+ 8660 1E 01            LD      E, 1
 367+ 8662 CD 47 82         CALL    Screen_PrintString
 368+ 8665
 369+ 8665 2A A2 99         LD      HL, (HighScore)
 370+ 8668 11 D1 99         LD      DE, NumberValue
 371+ 866B CD 7C 83         CALL    String_NumberToASCII
 372+ 866E 21 D1 99         LD      HL, NumberValue
 373+ 8671 CD A0 83         CALL    String_RemoveLeadingZeros
 374+ 8674 21 D1 99         LD      HL, NumberValue
 375+ 8677 16 08            LD      D, 8
 376+ 8679 1E 01            LD      E, 1
 377+ 867B CD 47 82         CALL    Screen_PrintString
 378+ 867E
 379+ 867E
 380+ 867E 2A CD 99         LD      HL, (PlacedBlocks)
 381+ 8681 11 D1 99         LD      DE, NumberValue
 382+ 8684 CD 7C 83         CALL    String_NumberToASCII
 383+ 8687 21 D1 99         LD      HL, NumberValue
 384+ 868A CD A0 83         CALL    String_RemoveLeadingZeros
 385+ 868D 21 D1 99         LD      HL, NumberValue
 386+ 8690 16 0C            LD      D, 12
 387+ 8692 1E 01            LD      E, 1
 388+ 8694 CD 47 82         CALL    Screen_PrintString
 389+ 8697
 390+ 8697 2A CF 99         LD      HL, (MaxPlacedBlocks)
 391+ 869A 11 D1 99         LD      DE, NumberValue
 392+ 869D CD 7C 83         CALL    String_NumberToASCII
 393+ 86A0 21 D1 99         LD      HL, NumberValue
 394+ 86A3 CD A0 83         CALL    String_RemoveLeadingZeros
 395+ 86A6 21 D1 99         LD      HL, NumberValue
 396+ 86A9 16 11            LD      D, 17
 397+ 86AB 1E 01            LD      E, 1
 398+ 86AD CD 47 82         CALL    Screen_PrintString
 399+ 86B0
 400+ 86B0 3A A4 99         LD      A, (Level)
 401+ 86B3 26 00            LD      H, 0
 402+ 86B5 6F               LD      L, A
 403+ 86B6 11 D1 99         LD      DE, NumberValue
 404+ 86B9 CD 7C 83         CALL    String_NumberToASCII
 405+ 86BC 21 D1 99         LD      HL, NumberValue
 406+ 86BF CD A0 83         CALL    String_RemoveLeadingZeros
 407+ 86C2 21 D1 99         LD      HL, NumberValue
 408+ 86C5 16 15            LD      D, 21
 409+ 86C7 1E 01            LD      E, 1
 410+ 86C9 CD 47 82         CALL    Screen_PrintString
 411+ 86CC
 412+ 86CC C9               RET
 413+ 86CD              DisplayScoreUpdateEast:
 414+ 86CD 2A A0 99         LD      HL, (Score)
 415+ 86D0 11 D1 99         LD      DE, NumberValue
 416+ 86D3 CD 7C 83         CALL    String_NumberToASCII
 417+ 86D6 21 D1 99         LD      HL, NumberValue
 418+ 86D9 CD A0 83         CALL    String_RemoveLeadingZeros
 419+ 86DC 21 D1 99         LD      HL, NumberValue
 420+ 86DF 16 03            LD      D, 3
 421+ 86E1 1E 01            LD      E, 1
 422+ 86E3 CD 47 82         CALL    Screen_PrintString
 423+ 86E6
 424+ 86E6 2A A2 99         LD      HL, (HighScore)
 425+ 86E9 11 D1 99         LD      DE, NumberValue
 426+ 86EC CD 7C 83         CALL    String_NumberToASCII
 427+ 86EF 21 D1 99         LD      HL, NumberValue
 428+ 86F2 CD A0 83         CALL    String_RemoveLeadingZeros
 429+ 86F5 21 D1 99         LD      HL, NumberValue
 430+ 86F8 16 03            LD      D, 3
 431+ 86FA 1E 0A            LD      E, 10
 432+ 86FC CD 47 82         CALL    Screen_PrintString
 433+ 86FF
 434+ 86FF
 435+ 86FF 2A CD 99         LD      HL, (PlacedBlocks)
 436+ 8702 11 D1 99         LD      DE, NumberValue
 437+ 8705 CD 7C 83         CALL    String_NumberToASCII
 438+ 8708 21 D1 99         LD      HL, NumberValue
 439+ 870B CD A0 83         CALL    String_RemoveLeadingZeros
 440+ 870E 21 D1 99         LD      HL, NumberValue
 441+ 8711 16 03            LD      D, 3
 442+ 8713 1E 12            LD      E, 18
 443+ 8715 CD 47 82         CALL    Screen_PrintString
 444+ 8718
 445+ 8718 2A CF 99         LD      HL, (MaxPlacedBlocks)
 446+ 871B 11 D1 99         LD      DE, NumberValue
 447+ 871E CD 7C 83         CALL    String_NumberToASCII
 448+ 8721 21 D1 99         LD      HL, NumberValue
 449+ 8724 CD A0 83         CALL    String_RemoveLeadingZeros
 450+ 8727 21 D1 99         LD      HL, NumberValue
 451+ 872A 16 03            LD      D, 3
 452+ 872C 1E 1A            LD      E, 26
 453+ 872E CD 47 82         CALL    Screen_PrintString
 454+ 8731
 455+ 8731 3A A4 99         LD      A, (Level)
 456+ 8734 26 00            LD      H, 0
 457+ 8736 6F               LD      L, A
 458+ 8737 11 D1 99         LD      DE, NumberValue
 459+ 873A CD 7C 83         CALL    String_NumberToASCII
 460+ 873D 21 D1 99         LD      HL, NumberValue
 461+ 8740 CD A0 83         CALL    String_RemoveLeadingZeros
 462+ 8743 21 D1 99         LD      HL, NumberValue
 463+ 8746 16 16            LD      D, 22
 464+ 8748 1E 01            LD      E, 1
 465+ 874A CD 47 82         CALL    Screen_PrintString
 466+ 874D C9               RET
 467+ 874E              DisplayScoreUpdateWest:
 468+ 874E 2A A0 99         LD      HL, (Score)
 469+ 8751 11 D1 99         LD      DE, NumberValue
 470+ 8754 CD 7C 83         CALL    String_NumberToASCII
 471+ 8757 21 D1 99         LD      HL, NumberValue
 472+ 875A CD A0 83         CALL    String_RemoveLeadingZeros
 473+ 875D 21 D1 99         LD      HL, NumberValue
 474+ 8760 16 16            LD      D, 22
 475+ 8762 1E 01            LD      E, 1
 476+ 8764 CD 47 82         CALL    Screen_PrintString
 477+ 8767
 478+ 8767 2A A2 99         LD      HL, (HighScore)
 479+ 876A 11 D1 99         LD      DE, NumberValue
 480+ 876D CD 7C 83         CALL    String_NumberToASCII
 481+ 8770 21 D1 99         LD      HL, NumberValue
 482+ 8773 CD A0 83         CALL    String_RemoveLeadingZeros
 483+ 8776 21 D1 99         LD      HL, NumberValue
 484+ 8779 16 16            LD      D, 22
 485+ 877B 1E 0A            LD      E, 10
 486+ 877D CD 47 82         CALL    Screen_PrintString
 487+ 8780
 488+ 8780
 489+ 8780 2A CD 99         LD      HL, (PlacedBlocks)
 490+ 8783 11 D1 99         LD      DE, NumberValue
 491+ 8786 CD 7C 83         CALL    String_NumberToASCII
 492+ 8789 21 D1 99         LD      HL, NumberValue
 493+ 878C CD A0 83         CALL    String_RemoveLeadingZeros
 494+ 878F 21 D1 99         LD      HL, NumberValue
 495+ 8792 16 16            LD      D, 22
 496+ 8794 1E 12            LD      E, 18
 497+ 8796 CD 47 82         CALL    Screen_PrintString
 498+ 8799
 499+ 8799 2A CF 99         LD      HL, (MaxPlacedBlocks)
 500+ 879C 11 D1 99         LD      DE, NumberValue
 501+ 879F CD 7C 83         CALL    String_NumberToASCII
 502+ 87A2 21 D1 99         LD      HL, NumberValue
 503+ 87A5 CD A0 83         CALL    String_RemoveLeadingZeros
 504+ 87A8 21 D1 99         LD      HL, NumberValue
 505+ 87AB 16 16            LD      D, 22
 506+ 87AD 1E 1A            LD      E, 26
 507+ 87AF CD 47 82         CALL    Screen_PrintString
 508+ 87B2
 509+ 87B2 3A A4 99         LD      A, (Level)
 510+ 87B5 26 00            LD      H, 0
 511+ 87B7 6F               LD      L, A
 512+ 87B8 11 D1 99         LD      DE, NumberValue
 513+ 87BB CD 7C 83         CALL    String_NumberToASCII
 514+ 87BE 21 D1 99         LD      HL, NumberValue
 515+ 87C1 CD A0 83         CALL    String_RemoveLeadingZeros
 516+ 87C4 21 D1 99         LD      HL, NumberValue
 517+ 87C7 16 02            LD      D, 2
 518+ 87C9 1E 1A            LD      E, 26
 519+ 87CB CD 47 82         CALL    Screen_PrintString
 520+ 87CE
 521+ 87CE C9               RET
 522+ 87CF
 523+ 87CF              ;---------------------------------------------------------------------
 524+ 87CF              ; Score update
 525+ 87CF              ; INPUT:
 526+ 87CF              ;   A: Amount of completed rows
 527+ 87CF              ; OUTPUT: -
 528+ 87CF              ; MODIFY: AF, DE, HL, BC
 529+ 87CF              ;---------------------------------------------------------------------
 530+ 87CF              ScoreUpdate:
 531+ 87CF FE 00            CP      0
 532+ 87D1 C8               RET     Z
 533+ 87D2 CD 21 84         CALL    LineCompleteSound
 534+ 87D5 0E 00            LD      C, 0    ; Score to add
 535+ 87D7 47               LD      B, A    ; B = number of completed rows
 536+ 87D8 FE 01            CP      1
 537+ 87DA 20 04            JR      NZ, .Continue1
 538+ 87DC 0E 0A            LD      C, 10
 539+ 87DE 18 12            JR      .Continue4
 540+ 87E0              .Continue1:
 541+ 87E0 FE 02            CP      2
 542+ 87E2 20 04            JR      NZ, .Continue2
 543+ 87E4 0E 16            LD      C, 22
 544+ 87E6 18 0A            JR      .Continue4
 545+ 87E8              .Continue2:
 546+ 87E8 FE 03            CP      3
 547+ 87EA 20 04            JR      NZ, .Continue3
 548+ 87EC 0E 23            LD      C, 35
 549+ 87EE 18 02            JR      .Continue4
 550+ 87F0              .Continue3:
 551+ 87F0 0E 32            LD      C, 50
 552+ 87F2              .Continue4:
 553+ 87F2 2A A0 99         LD      HL, (Score)
 554+ 87F5 79               LD      A, C
 555+ 87F6 CD C1 83         CALL    Math_AddAToHL
 556+ 87F9 22 A0 99         LD      (Score), HL
 557+ 87FC
 558+ 87FC
 559+ 87FC 2A A0 99         LD      HL, (Score)
 560+ 87FF ED 4B A2 99      LD      BC, (HighScore)
 561+ 8803 CD C6 83         CALL    Math_CompareHLtoBC
 562+ 8806 FE 01            CP      1
 563+ 8808 C0               RET     NZ
 564+ 8809 22 A2 99         LD      (HighScore), HL  ; Set the maximum number of blocks to the current number of blocks
 565+ 880C C9               RET
 566+ 880D
 567+ 880D              ;--------------------------------------------------------------------------
 568+ 880D              ; Compare and update DE and HL (Update HL if DE > HL)
 569+ 880D              ; INPUT:
 570+ 880D              ;   DE: First number (16-bit)
 571+ 880D              ;   HL: Second number (16-bit)
 572+ 880D              ; OUTPUT: -
 573+ 880D              ; MODIFY: AF, DE, HL, BC
 574+ 880D              ;--------------------------------------------------------------------------
 575+ 880D              CompareAndUpdateHLAndDE:
 576+ 880D 7A               LD   A, D            ; Load the high byte of DE into A.
 577+ 880E BC               CP   H               ; Compare A with the high byte of HL.
 578+ 880F 28 04            JR   Z, CompareLow   ; If equal, move to compare the low bytes.
 579+ 8811 38 08            JR   C, SkipUpdate   ; If A < H (i.e. D < H), then DE < HL; do not update.
 580+ 8813                  ; If we reach here, D > H, so DE > HL.
 581+ 8813              UpdateHL:
 582+ 8813 EB               EX   DE, HL         ; Swap DE and HL so that HL becomes DE.
 583+ 8814 C9               RET
 584+ 8815
 585+ 8815              CompareLow:
 586+ 8815 7B               LD   A, E           ; Load the low byte of DE into A.
 587+ 8816 BD               CP   L              ; Compare A with the low byte of HL.
 588+ 8817 30 02            JR   NC, SkipUpdate  ; If A <= L then DE <= HL; no update.
 589+ 8819 18 F8            JR   UpdateHL       ; Otherwise (A > L), update HL = DE.
 590+ 881B
 591+ 881B              SkipUpdate:
 592+ 881B C9               RET
 593+ 881C
 594+ 881C
 595+ 881C
 596+ 881C              ;------------------------------------------------------------------------
 597+ 881C              ; Reset next block position
 598+ 881C              ; INPUT: -
 599+ 881C              ; OUTPUT: -
 600+ 881C              ; MODIFY: AF, DE, HL, BC
 601+ 881C              ;------------------------------------------------------------------------
 602+ 881C              SetNextBoxPosition:
 603+ 881C 3A B3 99         LD      A, (Bug)
 604+ 881F 3A 7F 99         LD      A, (CurrentMatrixOrientation)
 605+ 8822 FE 00            CP      ORIENT_NORTH
 606+ 8824 CA 54 88         JP      Z, SetNextBoxPositionNorth
 607+ 8827 FE 01            CP      ORIENT_SOUTH
 608+ 8829 CA 5F 88         JP      Z, SetNextBoxPositionSouth
 609+ 882C FE 02            CP      ORIENT_EAST
 610+ 882E CA 88 88         JP      Z, SetNextBoxPositionEast
 611+ 8831
 612+ 8831              SetNextBoxPositionWest:
 613+ 8831 3E 02            LD      A, 2
 614+ 8833 32 B2 99         LD      (NextBlockYPosition), A
 615+ 8836 3A B0 99         LD      A, (NextBlock)
 616+ 8839 FE 01            CP      BLOCK_O
 617+ 883B 20 05            JR      NZ, SetNextBoxPositionWestContinue1
 618+ 883D 3E 03            LD      A, 3
 619+ 883F 32 B2 99         LD      (NextBlockYPosition), A
 620+ 8842              SetNextBoxPositionWestContinue1:
 621+ 8842 3A B0 99         LD      A, (NextBlock)
 622+ 8845 FE 00            CP      BLOCK_I
 623+ 8847 20 05            JR      NZ, SetNextBoxPositionWestContinue2
 624+ 8849 3E 01            LD      A, 1
 625+ 884B 32 B2 99         LD      (NextBlockYPosition), A
 626+ 884E              SetNextBoxPositionWestContinue2:
 627+ 884E 3E 07            LD      A, 7
 628+ 8850 32 B1 99         LD      (NextBlockXPosition), A
 629+ 8853 C9               RET
 630+ 8854              SetNextBoxPositionNorth:
 631+ 8854 3E 17            LD      A, 23
 632+ 8856 32 B1 99         LD      (NextBlockXPosition), A
 633+ 8859 3E 03            LD      A, 3
 634+ 885B 32 B2 99         LD      (NextBlockYPosition), A
 635+ 885E C9               RET
 636+ 885F              SetNextBoxPositionSouth:
 637+ 885F 3E 06            LD      A, 6
 638+ 8861 32 B1 99         LD      (NextBlockXPosition), A
 639+ 8864 3A B0 99         LD      A, (NextBlock)
 640+ 8867 FE 01            CP      BLOCK_O
 641+ 8869 20 05            JR      NZ, SetNextBoxPositionSouthContinue1
 642+ 886B 3E 07            LD      A, 7
 643+ 886D 32 B1 99         LD      (NextBlockXPosition), A
 644+ 8870              SetNextBoxPositionSouthContinue1:
 645+ 8870 3A B0 99         LD      A, (NextBlock)
 646+ 8873 FE 00            CP      BLOCK_I
 647+ 8875 20 0B            JR      NZ, SetNextBoxPositionSouthContinue2
 648+ 8877 3E 05            LD      A, 5
 649+ 8879 32 B1 99         LD      (NextBlockXPosition), A
 650+ 887C 3E 14            LD      A, 20
 651+ 887E 32 B2 99         LD      (NextBlockYPosition), A
 652+ 8881 C9               RET
 653+ 8882              SetNextBoxPositionSouthContinue2:
 654+ 8882 3E 13            LD      A, 19
 655+ 8884 32 B2 99         LD      (NextBlockYPosition), A
 656+ 8887 C9               RET
 657+ 8888              SetNextBoxPositionEast:
 658+ 8888 3E 17            LD      A, 23
 659+ 888A 32 B1 99         LD      (NextBlockXPosition), A
 660+ 888D 3A B0 99         LD      A, (NextBlock)
 661+ 8890 FE 00            CP      BLOCK_I
 662+ 8892 20 05            JR      NZ, SetNextBoxPositionEastContinue
 663+ 8894 3E 18            LD      A, 24
 664+ 8896 32 B1 99         LD      (NextBlockXPosition), A
 665+ 8899              SetNextBoxPositionEastContinue:
 666+ 8899
 667+ 8899 3E 13            LD      A, 19
 668+ 889B 32 B2 99         LD      (NextBlockYPosition), A
 669+ 889E C9               RET
 670+ 889F
 671+ 889F              ;------------------------------------------------------------------------
 672+ 889F              ; Update next block info
 673+ 889F              ; INPUT: -
 674+ 889F              ; OUTPUT: -
 675+ 889F              ; MODIFY: AF, DE, HL, BC
 676+ 889F              ;------------------------------------------------------------------------
 677+ 889F              UpdateNextBlockInfo:
 678+ 889F 3A 7F 99         LD      A, (CurrentMatrixOrientation)
 679+ 88A2 FE 00            CP      ORIENT_NORTH
 680+ 88A4 CA B6 88         JP      Z, UpdateNextBlockInfoNorth
 681+ 88A7 FE 01            CP      ORIENT_SOUTH
 682+ 88A9 CA BC 88         JP      Z, UpdateNextBlockInfoSouth
 683+ 88AC FE 02            CP      ORIENT_EAST
 684+ 88AE CA C3 88         JP      Z, UpdateNextBlockInfoEast
 685+ 88B1 FE 03            CP      ORIENT_WEST
 686+ 88B3 CA CA 88         JP      Z, UpdateNextBlockInfoWest
 687+ 88B6              UpdateNextBlockInfoNorth:
 688+ 88B6 AF               XOR     A
 689+ 88B7 32 87 99         LD      (CurrentBlockRotation), A
 690+ 88BA 18 13            JR      UpdateNextBlockInfoContinue
 691+ 88BC              UpdateNextBlockInfoSouth:
 692+ 88BC 3E 02            LD      A, 2
 693+ 88BE 32 87 99         LD      (CurrentBlockRotation), A
 694+ 88C1 18 0C            JR      UpdateNextBlockInfoContinue
 695+ 88C3              UpdateNextBlockInfoEast:
 696+ 88C3 3E 01            LD      A, 1
 697+ 88C5 32 87 99         LD      (CurrentBlockRotation), A
 698+ 88C8 18 05            JR      UpdateNextBlockInfoContinue
 699+ 88CA              UpdateNextBlockInfoWest:
 700+ 88CA 3E 03            LD      A, 3
 701+ 88CC 32 87 99         LD      (CurrentBlockRotation), A
 702+ 88CF              UpdateNextBlockInfoContinue:
 703+ 88CF 3A B0 99         LD      A, (NextBlock)
 704+ 88D2 4F               LD      C, A
 705+ 88D3 3A 88 99         LD      A, (CurrentBlock)
 706+ 88D6 47               LD      B, A
 707+ 88D7 79               LD      A, C
 708+ 88D8 32 88 99         LD      (CurrentBlock), A
 709+ 88DB 3A 82 99         LD      A, (ColorOfBlock)
 710+ 88DE 5F               LD      E, A
 711+ 88DF D5               PUSH    DE
 712+ 88E0 C5               PUSH    BC
 713+ 88E1
 714+ 88E1 CD A5 8E         CALL    UpdateCurrentBlockTable
 715+ 88E4
 716+ 88E4 3A 82 99         LD      A, (ColorOfBlock)
 717+ 88E7 32 C5 99         LD      (NextBlockColor), A
 718+ 88EA 22 C6 99         LD      (NextBlockTable), HL
 719+ 88ED
 720+ 88ED C1               POP     BC
 721+ 88EE D1               POP     DE
 722+ 88EF 7B               LD      A, E
 723+ 88F0 32 82 99         LD      (ColorOfBlock), A
 724+ 88F3 79               LD      A, C
 725+ 88F4 32 B0 99         LD      (NextBlock), A
 726+ 88F7 78               LD      A, B
 727+ 88F8 32 88 99         LD      (CurrentBlock), A
 728+ 88FB C9               RET
 729+ 88FC              ;------------------------------------------------------------------------
 730+ 88FC              ; Show next block
 731+ 88FC              ; INPUT: -
 732+ 88FC              ; OUTPUT: -
 733+ 88FC              ; MODIFY: AF, DE, HL, BC
 734+ 88FC              ;------------------------------------------------------------------------
 735+ 88FC              ShowNextBlockOnBox:
 736+ 88FC CD C7 8C         CALL    ClearNextBlockArea
 737+ 88FF 2A C6 99         LD      HL, (NextBlockTable)
 738+ 8902              ShowNextBlockLoop:
 739+ 8902 7E               LD      A, (HL)
 740+ 8903 FE FF            CP      0xFF
 741+ 8905 28 20            JR      Z, ShowNextBlockEnd
 742+ 8907 3A B2 99         LD      A, (NextBlockYPosition)
 743+ 890A 47               LD      B, A
 744+ 890B 7E               LD      A, (HL)
 745+ 890C 80               ADD     B
 746+ 890D 57               LD      D, A
 747+ 890E 23               INC     HL
 748+ 890F 3A B1 99         LD      A, (NextBlockXPosition)
 749+ 8912 47               LD      B, A
 750+ 8913 7E               LD      A, (HL)
 751+ 8914 80               ADD     B
 752+ 8915 5F               LD      E, A
 753+ 8916 E5               PUSH    HL
 754+ 8917 21 C5 99         LD      HL, NextBlockColor
 755+ 891A 7E               LD      A, (HL)
 756+ 891B CD 28 82         CALL    SetAttributeAtDE
 757+ 891E 3E 01            LD      A, TILE_BLOCK
 758+ 8920 CD AD 82         CALL    Screen_PrintRamChar
 759+ 8923 E1               POP     HL
 760+ 8924 23               INC     HL
 761+ 8925 18 DB            JR      ShowNextBlockLoop
 762+ 8927              ShowNextBlockEnd:
 763+ 8927 C9               RET
 764+ 8928              ;------------------------------------------------------------------------
 765+ 8928              ; Draw menu title
 766+ 8928              ; INPUT: -
 767+ 8928              ; OUTPUT: -
 768+ 8928              ; MODIFY: AF, DE, HL, BC
 769+ 8928              ;------------------------------------------------------------------------
 770+ 8928              DrawMenuTitle:
 771+ 8928 21 DD 97         LD   HL, ZXETRISMATRIX  ; Punto di partenza della matrice
 772+ 892B 16 01            LD   D, 1               ; Riga = 0
 773+ 892D
 774+ 892D              NextRow:
 775+ 892D 1E 03            LD   E, 3               ; Colonna = 0
 776+ 892F
 777+ 892F              NextColumn:
 778+ 892F 7E               LD   A, (HL)            ; Legge il byte corrente
 779+ 8930 FE 00            CP   0
 780+ 8932 28 05            JR   Z, SkipSet         ; Se zero, non chiamare SetAttributeAtDE
 781+ 8934
 782+ 8934                  ; Valore ≠ 0: esegue la subroutine
 783+ 8934 E5               PUSH HL                 ; Salva HL prima della chiamata
 784+ 8935 CD 28 82         CALL SetAttributeAtDE   ; A = valore, D = riga, E = colonna
 785+ 8938 E1               POP  HL                 ; Ripristina HL
 786+ 8939
 787+ 8939              SkipSet:
 788+ 8939 23               INC  HL                 ; Prossimo byte
 789+ 893A 1C               INC  E                  ; Prossima colonna
 790+ 893B 7B               LD   A, E
 791+ 893C FE 1C            CP   28
 792+ 893E 20 EF            JR   NZ, NextColumn     ; Continua finché E < 25
 793+ 8940
 794+ 8940 14               INC  D                  ; Riga successiva
 795+ 8941 7A               LD   A, D
 796+ 8942 FE 08            CP   8
 797+ 8944 20 E7            JR   NZ, NextRow        ; Continua finché D < 7
 798+ 8946
 799+ 8946 C9               RET
 800+ 8947              ;------------------------------------------------------------------------
 801+ 8947              ; Initialize matrix
 802+ 8947              ; INPUT: -
 803+ 8947              ; OUTPUT: -
 804+ 8947              ; MODIFY: AF, DE, HL, BC
 805+ 8947              ;------------------------------------------------------------------------
 806+ 8947              MatrixInit:
 807+ 8947 21 B7 98         LD      HL,Matrix       ; HL -> start of the area to fill
 808+ 894A 11 C8 00         LD      DE,200          ; number of bytes to fill
 809+ 894D              MatrixInitLoop:
 810+ 894D 36 00            LD      (HL),COLOR_BLACK          ; store A into (HL)
 811+ 894F 23               INC     HL              ; move to next byte
 812+ 8950 1B               DEC     DE              ; decrement counter
 813+ 8951 7A               LD      A,D             ; check if DE = 0
 814+ 8952 B3               OR      E
 815+ 8953 C2 4D 89         JP      NZ,MatrixInitLoop
 816+ 8956 3E 01            LD      A,1
 817+ 8958 32 AC 99         LD      (ForcePrintMatrixRepaintAll), A
 818+ 895B C9               RET
 819+ 895C
 820+ 895C              ;------------------------------------------------------------------------
 821+ 895C              ; Show game menu
 822+ 895C              ; INPUT: -
 823+ 895C              ; OUTPUT: -
 824+ 895C              ; MODIFY: AF, DE, HL, BC
 825+ 895C              ;------------------------------------------------------------------------
 826+ 895C              ShowMenu:
 827+ 895C CD 47 89         CALL    MatrixInit
 828+ 895F AF               XOR     A
 829+ 8960 32 DF 99         LD      (InGame), A
 830+ 8963 F3               DI                                      ; Disable interrupts
 831+ 8964 ED 5E            IM      2                               ; Set the interrupt mode
 832+ 8966 FB               EI                                      ; Enable interrupts
 833+ 8967 CD 8E 82         CALL    Screen_Clear            ; Clear screen
 834+ 896A 3E 00            LD      A, TILE_VERTICAL_WALL
 835+ 896C 32 CC 99         LD      (CurrentWallTile), A
 836+ 896F CD 5C 8C         CALL    FillWallArea
 837+ 8972 CD CC 8B         CALL    FillOptionsArea
 838+ 8975 3E 0A            LD      A, 10
 839+ 8977 32 DB 99         LD      (SelectedOption), A
 840+ 897A CD 9F 8A         CALL    UpdateOptions
 841+ 897D 21 8B 97         LD      HL, TEXT_COPYRIGHT
 842+ 8980 16 16            LD      D, 22
 843+ 8982 1E 07            LD      E, 7
 844+ 8984 CD 47 82         CALL    Screen_PrintString
 845+ 8987 21 9E 97         LD      HL, TEXT_COMMANDS
 846+ 898A 16 11            LD      D, 17
 847+ 898C 1E 03            LD      E, 3
 848+ 898E CD 47 82         CALL    Screen_PrintString
 849+ 8991 21 B8 97         LD      HL, TEXT_COMMANDS_SPACE
 850+ 8994 16 12            LD      D, 18
 851+ 8996 1E 08            LD      E, 8
 852+ 8998 CD 47 82         CALL    Screen_PrintString
 853+ 899B 21 C8 97         LD      HL, TEXT_COMMANDS_SPACE_TO_START
 854+ 899E 16 14            LD      D, 20
 855+ 89A0 1E 06            LD      E, 6
 856+ 89A2 CD 47 82         CALL    Screen_PrintString
 857+ 89A5 3E 06            LD      A, 6
 858+ 89A7 16 14            LD      D, 20
 859+ 89A9 06 C7            LD      B, 0xC7
 860+ 89AB              ShowMenuBlinkingLoop:
 861+ 89AB FE 1A            CP      26
 862+ 89AD 28 0A            JR      Z, ShowMenuKeyboardLoop
 863+ 89AF F5               PUSH    AF
 864+ 89B0 5F               LD      E, A
 865+ 89B1 78               LD      A, B
 866+ 89B2 CD 28 82         CALL    SetAttributeAtDE
 867+ 89B5 F1               POP     AF
 868+ 89B6 3C               INC     A
 869+ 89B7 18 F2            JR      ShowMenuBlinkingLoop
 870+ 89B9              ShowMenuKeyboardLoop:
 871+ 89B9 3A DC 99         LD      A, (TitleTimer)
 872+ 89BC FE FA            CP      250
 873+ 89BE 20 0A            JR      NZ, ShowMenuKeyboardLoopContinue
 874+ 89C0 CD 4C 93         CALL    RandomizeMatrixBlocks
 875+ 89C3 CD 28 89         CALL    DrawMenuTitle
 876+ 89C6 AF               XOR     A
 877+ 89C7 32 DC 99         LD      (TitleTimer), A
 878+ 89CA              ShowMenuKeyboardLoopContinue:
 879+ 89CA 3A DC 99         LD      A, (TitleTimer)
 880+ 89CD 3C               INC     A
 881+ 89CE 32 DC 99         LD      (TitleTimer), A
 882+ 89D1 CD B4 94         CALL    ReadKeyboard
 883+ 89D4 3A AB 99         LD      A, (KeyPressed)
 884+ 89D7 FE 20            CP      32
 885+ 89D9 CA F9 89         JP      Z, ShowMenuExit
 886+ 89DC FE 34            CP      52
 887+ 89DE CA FE 89         JP      Z, ChangeCurrentOptionValueLeft
 888+ 89E1 FE 35            CP      53
 889+ 89E3 CA 81 8A         JP      Z, ShowMenuKeyboardChangeSelectedOption
 890+ 89E6 FE 36            CP      54
 891+ 89E8 CA 3F 8A         JP      Z, ChangeCurrentOptionValueRight
 892+ 89EB 3A 9C 99         LD      A, (Seed)
 893+ 89EE FE FF            CP      255
 894+ 89F0 20 01            JR      NZ, ShowMenuKeyboardLoopSeed
 895+ 89F2 AF               XOR     A
 896+ 89F3              ShowMenuKeyboardLoopSeed:
 897+ 89F3 3C               INC     A
 898+ 89F4 32 9C 99         LD      (Seed), A
 899+ 89F7 18 C0            JR      ShowMenuKeyboardLoop
 900+ 89F9              ShowMenuExit:
 901+ 89F9 F3               DI                                      ; Disable interrupts
 902+ 89FA ED 56            IM      1                               ; Set the interrupt mode
 903+ 89FC FB               EI                                      ; Enable interrupts
 904+ 89FD C9               RET
 905+ 89FE              ChangeCurrentOptionValueLeft:
 906+ 89FE AF               XOR     A
 907+ 89FF 32 AB 99         LD      (KeyPressed), A
 908+ 8A02 3A DB 99         LD      A, (SelectedOption)
 909+ 8A05 FE 0A            CP      10
 910+ 8A07 28 08            JR      Z, ChangeCurrentOptionValueLeftLevel
 911+ 8A09 FE 0C            CP      12
 912+ 8A0B 28 16            JR      Z, ChangeCurrentOptionValueLeftCanGrow
 913+ 8A0D FE 0E            CP      14
 914+ 8A0F 28 1C            JR      Z, ChangeCurrentOptionValueLeftOrientation
 915+ 8A11              ChangeCurrentOptionValueLeftLevel:
 916+ 8A11 3A D8 99         LD      A, (SelectedLevel)
 917+ 8A14 3D               DEC     A
 918+ 8A15 FE 00            CP      0
 919+ 8A17 CA B9 89         JP      Z, ShowMenuKeyboardLoop
 920+ 8A1A 32 D8 99         LD      (SelectedLevel), A
 921+ 8A1D CD 9F 8A         CALL    UpdateOptions
 922+ 8A20 C3 B9 89         JP      ShowMenuKeyboardLoop
 923+ 8A23
 924+ 8A23              ChangeCurrentOptionValueLeftCanGrow:
 925+ 8A23 AF               XOR     A
 926+ 8A24 32 DA 99         LD      (SelectedCanGrow), A
 927+ 8A27 CD 9F 8A         CALL    UpdateOptions
 928+ 8A2A C3 B9 89         JP      ShowMenuKeyboardLoop
 929+ 8A2D              ChangeCurrentOptionValueLeftOrientation:
 930+ 8A2D 3A D9 99         LD      A, (SelectedOrientation)
 931+ 8A30 FE 00            CP      0
 932+ 8A32 CA B9 89         JP      Z, ShowMenuKeyboardLoop
 933+ 8A35 3D               DEC     A
 934+ 8A36 32 D9 99         LD      (SelectedOrientation), A
 935+ 8A39 CD 9F 8A         CALL    UpdateOptions
 936+ 8A3C C3 B9 89         JP      ShowMenuKeyboardLoop
 937+ 8A3F
 938+ 8A3F
 939+ 8A3F
 940+ 8A3F
 941+ 8A3F              ChangeCurrentOptionValueRight:
 942+ 8A3F AF               XOR     A
 943+ 8A40 32 AB 99         LD      (KeyPressed), A
 944+ 8A43 3A DB 99         LD      A, (SelectedOption)
 945+ 8A46 FE 0A            CP      10
 946+ 8A48 28 08            JR      Z, ChangeCurrentOptionValueRightLevel
 947+ 8A4A FE 0C            CP      12
 948+ 8A4C 28 16            JR      Z, ChangeCurrentOptionValueRightCanGrow
 949+ 8A4E FE 0E            CP      14
 950+ 8A50 28 1D            JR      Z, ChangeCurrentOptionValueRightOrientation
 951+ 8A52              ChangeCurrentOptionValueRightLevel:
 952+ 8A52 3A D8 99         LD      A, (SelectedLevel)
 953+ 8A55 3C               INC     A
 954+ 8A56 FE 0B            CP      11
 955+ 8A58 CA B9 89         JP      Z, ShowMenuKeyboardLoop
 956+ 8A5B 32 D8 99         LD      (SelectedLevel), A
 957+ 8A5E CD 9F 8A         CALL    UpdateOptions
 958+ 8A61 C3 B9 89         JP      ShowMenuKeyboardLoop
 959+ 8A64
 960+ 8A64              ChangeCurrentOptionValueRightCanGrow:
 961+ 8A64 3E 01            LD      A, 1
 962+ 8A66 32 DA 99         LD      (SelectedCanGrow), A
 963+ 8A69 CD 9F 8A         CALL    UpdateOptions
 964+ 8A6C C3 B9 89         JP      ShowMenuKeyboardLoop
 965+ 8A6F              ChangeCurrentOptionValueRightOrientation:
 966+ 8A6F 3A D9 99         LD      A, (SelectedOrientation)
 967+ 8A72 3C               INC     A
 968+ 8A73 FE 05            CP      5
 969+ 8A75 CA B9 89         JP      Z, ShowMenuKeyboardLoop
 970+ 8A78 32 D9 99         LD      (SelectedOrientation), A
 971+ 8A7B CD 9F 8A         CALL    UpdateOptions
 972+ 8A7E C3 B9 89         JP      ShowMenuKeyboardLoop
 973+ 8A81
 974+ 8A81              ShowMenuKeyboardChangeSelectedOption:
 975+ 8A81 AF               XOR     A
 976+ 8A82 32 AB 99         LD      (KeyPressed), A
 977+ 8A85 3A DB 99         LD      A, (SelectedOption)
 978+ 8A88 3C               INC     A
 979+ 8A89 3C               INC     A
 980+ 8A8A FE 10            CP      16
 981+ 8A8C 20 02            JR      NZ, ShowMenuKeyboardChangeRefreshScreen
 982+ 8A8E 3E 0A            LD      A, 10
 983+ 8A90              ShowMenuKeyboardChangeRefreshScreen:
 984+ 8A90 32 DB 99         LD      (SelectedOption), A
 985+ 8A93 CD 9F 8A         CALL    UpdateOptions
 986+ 8A96 C3 B9 89         JP      ShowMenuKeyboardLoop
 987+ 8A99              ShowMenuGameStart:
 988+ 8A99 3E 00            LD      A, ORIENT_NORTH  ; ****************  DIRECTION  ****************
 989+ 8A9B 32 7F 99         LD      (CurrentMatrixOrientation), A  ; Set the orientation to North
 990+ 8A9E
 991+ 8A9E C9               RET
 992+ 8A9F              ;----------------------------------------------------------------------
 993+ 8A9F              ; Update options
 994+ 8A9F              ; INPUT: -
 995+ 8A9F              ; OUTPUT: -
 996+ 8A9F              ; MODIFY: AF, DE, HL, BC
 997+ 8A9F              ;----------------------------------------------------------------------
 998+ 8A9F              UpdateOptions:
 999+ 8A9F 16 0A            LD      D, 10
1000+ 8AA1 1E 17            LD      E, 23
1001+ 8AA3 21 89 97         LD      HL, TEXT_SPACE
1002+ 8AA6 CD 47 82         CALL    Screen_PrintString
1003+ 8AA9 3A D8 99         LD      A, (SelectedLevel)
1004+ 8AAC 26 00            LD      H, 0
1005+ 8AAE 6F               LD      L, A
1006+ 8AAF 11 D1 99         LD      DE, NumberValue
1007+ 8AB2 CD 7C 83         CALL    String_NumberToASCII
1008+ 8AB5 21 D1 99         LD      HL, NumberValue
1009+ 8AB8 CD A0 83         CALL    String_RemoveLeadingZeros
1010+ 8ABB 16 0A            LD      D, 10
1011+ 8ABD 1E 18            LD      E, 24
1012+ 8ABF 06 00            LD      B, 0
1013+ 8AC1 3A DB 99         LD      A, (SelectedOption)
1014+ 8AC4 FE 0A            CP      10
1015+ 8AC6 20 02            JR      NZ, UpdateOptionsNoYello1
1016+ 8AC8 06 01            LD      B, 1
1017+ 8ACA              UpdateOptionsNoYello1:
1018+ 8ACA
1019+ 8ACA 3A D8 99         LD      A, (SelectedLevel)
1020+ 8ACD FE 0A            CP      10
1021+ 8ACF 20 02            JR      NZ, UpdateOptionsNoYello1_1
1022+ 8AD1 1E 17            LD      E, 23
1023+ 8AD3              UpdateOptionsNoYello1_1:
1024+ 8AD3 CD 47 82         CALL    Screen_PrintString
1025+ 8AD6 21 63 97         LD      HL, TEXT_YES
1026+ 8AD9 3A DA 99         LD      A, (SelectedCanGrow)
1027+ 8ADC FE 01            CP      1
1028+ 8ADE 28 03            JR      Z, UpdateOptionsContinue1
1029+ 8AE0 21 67 97         LD      HL, TEXT_NO
1030+ 8AE3
1031+ 8AE3              UpdateOptionsContinue1:
1032+ 8AE3 16 0C            LD      D, 12
1033+ 8AE5 1E 16            LD      E, 22
1034+ 8AE7 06 00            LD      B, 0
1035+ 8AE9 3A DB 99         LD      A, (SelectedOption)
1036+ 8AEC FE 0C            CP      12
1037+ 8AEE 20 02            JR      NZ, UpdateOptionsNoYello2
1038+ 8AF0 06 01            LD      B, 1
1039+ 8AF2              UpdateOptionsNoYello2:
1040+ 8AF2 CD 47 82         CALL    Screen_PrintString
1041+ 8AF5 3A D9 99         LD      A, (SelectedOrientation)
1042+ 8AF8 FE 00            CP      ORIENT_NORTH
1043+ 8AFA 28 11            JR      Z, UpdateOptionsContinueNorth
1044+ 8AFC FE 01            CP      ORIENT_SOUTH
1045+ 8AFE 28 12            JR      Z, UpdateOptionsContinueSouth
1046+ 8B00 FE 02            CP      ORIENT_EAST
1047+ 8B02 28 13            JR      Z, UpdateOptionsContinueEast
1048+ 8B04 FE 03            CP      ORIENT_WEST
1049+ 8B06 28 14            JR      Z, UpdateOptionsContinueWest
1050+ 8B08 21 83 97         LD      HL, TEXT_CHAOS
1051+ 8B0B 18 14            JR      UpdateOptionsContinue2
1051+ 8B0D
1052+ 8B0D              UpdateOptionsContinueNorth:
1053+ 8B0D 21 6B 97         LD      HL, TEXT_NORTH
1054+ 8B10 18 0F            JR      UpdateOptionsContinue2
1055+ 8B12              UpdateOptionsContinueSouth:
1056+ 8B12 21 71 97         LD      HL, TEXT_SOUTH
1057+ 8B15 18 0A            JR      UpdateOptionsContinue2
1058+ 8B17              UpdateOptionsContinueEast:
1059+ 8B17 21 77 97         LD      HL, TEXT_EAST
1060+ 8B1A 18 05            JR      UpdateOptionsContinue2
1061+ 8B1C              UpdateOptionsContinueWest:
1062+ 8B1C 21 7D 97         LD      HL, TEXT_WEST
1063+ 8B1F 18 00            JR      UpdateOptionsContinue2
1064+ 8B21              UpdateOptionsContinue2:
1065+ 8B21 16 0E            LD      D, 14
1066+ 8B23 1E 14            LD      E, 20
1067+ 8B25 06 00            LD      B, 0
1068+ 8B27 3A DB 99         LD      A, (SelectedOption)
1069+ 8B2A FE 0E            CP      14
1070+ 8B2C 20 02            JR      NZ, UpdateOptionsNoYello3
1071+ 8B2E 06 01            LD      B, 1
1072+ 8B30              UpdateOptionsNoYello3:
1073+ 8B30 CD 47 82         CALL    Screen_PrintString
1074+ 8B33 C9               RET
1075+ 8B34              ;----------------------------------------------------------------------
1076+ 8B34              ; Wait for enter key press
1077+ 8B34              ; INPUT: -
1078+ 8B34              ; OUTPUT: -
1079+ 8B34              ; MODIFY: AF, DE, HL, BC
1080+ 8B34              ;----------------------------------------------------------------------
1081+ 8B34              WaitForSpaceKey:
1082+ 8B34 CD B4 94         CALL    ReadKeyboard
1083+ 8B37 3A AB 99         LD      A, (KeyPressed)
1084+ 8B3A FE 20            CP      32
1085+ 8B3C 20 F6            JR      NZ, WaitForSpaceKey
1086+ 8B3E 3E 00            LD      A, 0
1087+ 8B40 32 AB 99         LD      (KeyPressed), A
1088+ 8B43 C9               RET
1089+ 8B44              ;------------------------------------------------------------------------
1090+ 8B44              ; Fill next block area (Bottom Right)
1091+ 8B44              ; INPUT: -
1092+ 8B44              ; OUTPUT: -
1093+ 8B44              ; MODIFY: AF, DE, HL, BC
1094+ 8B44              ;-------------------------------------------------------------------------
1095+ 8B44              FillNextBlockAreaBottomRight:
1096+ 8B44 3E 12            LD      A, 18
1097+ 8B46              FillNextBlockAreaBottomRightRowLoop:
1098+ 8B46 FE 17            CP      23
1099+ 8B48 C8               RET     Z
1100+ 8B49 F5               PUSH    AF
1101+ 8B4A 57               LD      D, A
1102+ 8B4B 3E 16            LD      A, 22
1103+ 8B4D              FillNextBlockAreaBottomRightColLoop:
1104+ 8B4D FE 1A            CP      26
1105+ 8B4F 28 10            JR      Z, FillNextBlockAreaBottomRightRowLoopContinue
1106+ 8B51 F5               PUSH    AF
1107+ 8B52 5F               LD      E, A
1108+ 8B53
1109+ 8B53 3E 00            LD      A, COLOR_BLACK
1110+ 8B55 CD 28 82         CALL    SetAttributeAtDE
1111+ 8B58 3E 03            LD      A, TILE_BLOCK_EMPTY
1112+ 8B5A CD AD 82         CALL    Screen_PrintRamChar
1113+ 8B5D
1114+ 8B5D F1               POP     AF
1115+ 8B5E 3C               INC     A
1116+ 8B5F 18 EC            JR      FillNextBlockAreaBottomRightColLoop
1117+ 8B61              FillNextBlockAreaBottomRightRowLoopContinue:
1118+ 8B61 F1               POP     AF
1119+ 8B62 3C               INC     A
1120+ 8B63 C3 46 8B         JP      FillNextBlockAreaBottomRightRowLoop
1121+ 8B66
1122+ 8B66
1123+ 8B66
1124+ 8B66
1125+ 8B66              ;------------------------------------------------------------------------
1126+ 8B66              ; Fill next block area (Top Left)
1127+ 8B66              ; INPUT: -
1128+ 8B66              ; OUTPUT: -
1129+ 8B66              ; MODIFY: AF, DE, HL, BC
1130+ 8B66              ;-------------------------------------------------------------------------
1131+ 8B66              FillNextBlockAreaTopLeft:
1132+ 8B66 3E 01            LD      A, 1
1133+ 8B68              FillNextBlockAreaTopLeftRowLoop:
1134+ 8B68 FE 06            CP      6
1135+ 8B6A C8               RET     Z
1136+ 8B6B F5               PUSH    AF
1137+ 8B6C 57               LD      D, A
1138+ 8B6D 3E 06            LD      A, 6
1139+ 8B6F              FillNextBlockAreaTopLeftColLoop:
1140+ 8B6F FE 0A            CP      10
1141+ 8B71 28 10            JR      Z, FillNextBlockAreaTopLeftRowLoopContinue
1142+ 8B73 F5               PUSH    AF
1143+ 8B74 5F               LD      E, A
1144+ 8B75
1145+ 8B75 3E 00            LD      A, COLOR_BLACK
1146+ 8B77 CD 28 82         CALL    SetAttributeAtDE
1147+ 8B7A 3E 03            LD      A, TILE_BLOCK_EMPTY
1148+ 8B7C CD AD 82         CALL    Screen_PrintRamChar
1149+ 8B7F
1150+ 8B7F F1               POP     AF
1151+ 8B80 3C               INC     A
1152+ 8B81 18 EC            JR      FillNextBlockAreaTopLeftColLoop
1153+ 8B83              FillNextBlockAreaTopLeftRowLoopContinue:
1154+ 8B83 F1               POP     AF
1155+ 8B84 3C               INC     A
1156+ 8B85 C3 68 8B         JP      FillNextBlockAreaTopLeftRowLoop
1157+ 8B88
1158+ 8B88
1159+ 8B88              ;------------------------------------------------------------------------
1160+ 8B88              ; Fill next block area (Top Right)
1161+ 8B88              ; INPUT: -
1162+ 8B88              ; OUTPUT: -
1163+ 8B88              ; MODIFY: AF, DE, HL, BC
1164+ 8B88              ;-------------------------------------------------------------------------
1165+ 8B88              FillNextBlockAreaTopRight:
1166+ 8B88 3E 02            LD      A, 2
1167+ 8B8A              FillNextBlockAreaTopRightRowLoop:
1168+ 8B8A FE 06            CP      6
1169+ 8B8C C8               RET     Z
1170+ 8B8D F5               PUSH    AF
1171+ 8B8E 57               LD      D, A
1172+ 8B8F 3E 16            LD      A, 22
1173+ 8B91              FillNextBlockAreaTopRightColLoop:
1174+ 8B91 FE 1B            CP      27
1175+ 8B93 28 10            JR      Z, FillNextBlockAreaTopRightRowLoopContinue
1176+ 8B95 F5               PUSH    AF
1177+ 8B96 5F               LD      E, A
1178+ 8B97
1179+ 8B97 3E 00            LD      A, COLOR_BLACK
1180+ 8B99 CD 28 82         CALL    SetAttributeAtDE
1181+ 8B9C 3E 03            LD      A, TILE_BLOCK_EMPTY
1182+ 8B9E CD AD 82         CALL    Screen_PrintRamChar
1183+ 8BA1
1184+ 8BA1 F1               POP     AF
1185+ 8BA2 3C               INC     A
1186+ 8BA3 18 EC            JR      FillNextBlockAreaTopRightColLoop
1187+ 8BA5              FillNextBlockAreaTopRightRowLoopContinue:
1188+ 8BA5 F1               POP     AF
1189+ 8BA6 3C               INC     A
1190+ 8BA7 C3 8A 8B         JP      FillNextBlockAreaTopRightRowLoop
1191+ 8BAA              ;------------------------------------------------------------------------
1192+ 8BAA              ; Fill next block area (Bottom Left)
1193+ 8BAA              ; INPUT: -
1194+ 8BAA              ; OUTPUT: -
1195+ 8BAA              ; MODIFY: AF, DE, HL, BC
1196+ 8BAA              ;-------------------------------------------------------------------------
1197+ 8BAA              FillNextBlockAreaBottomLeft:
1198+ 8BAA 3E 12            LD      A, 18
1199+ 8BAC              FillNextBlockAreaBottomLeftRowLoop:
1200+ 8BAC FE 16            CP      22
1201+ 8BAE C8               RET     Z
1202+ 8BAF F5               PUSH    AF
1203+ 8BB0 57               LD      D, A
1204+ 8BB1 3E 05            LD      A, 5
1205+ 8BB3              FillNextBlockAreaBottomLeftColLoop:
1206+ 8BB3 FE 0A            CP      10
1207+ 8BB5 CA C8 8B         JP      Z, FillNextBlockAreaBottomLeftRowLoopContinue
1208+ 8BB8 F5               PUSH    AF
1209+ 8BB9 5F               LD      E, A
1210+ 8BBA
1211+ 8BBA 3E 00            LD      A, COLOR_BLACK
1212+ 8BBC CD 28 82         CALL    SetAttributeAtDE
1213+ 8BBF 3E 03            LD      A, TILE_BLOCK_EMPTY
1214+ 8BC1 CD AD 82         CALL    Screen_PrintRamChar
1215+ 8BC4
1216+ 8BC4 F1               POP     AF
1217+ 8BC5 3C               INC     A
1218+ 8BC6 18 EB            JR      FillNextBlockAreaBottomLeftColLoop
1219+ 8BC8              FillNextBlockAreaBottomLeftRowLoopContinue:
1220+ 8BC8 F1               POP     AF
1221+ 8BC9 3C               INC     A
1222+ 8BCA 18 E0            JR      FillNextBlockAreaBottomLeftRowLoop
1223+ 8BCC
1224+ 8BCC
1225+ 8BCC
1226+ 8BCC
1227+ 8BCC
1228+ 8BCC              ;------------------------------------------------------------------------
1229+ 8BCC              ; Fill options area
1230+ 8BCC              ; INPUT: -
1231+ 8BCC              ; OUTPUT: -
1232+ 8BCC              ; MODIFY: AF, DE, HL, BC
1233+ 8BCC              ;-------------------------------------------------------------------------
1234+ 8BCC              FillOptionsArea:
1235+ 8BCC 1E 00            LD      E, 0
1236+ 8BCE 16 00            LD      D, 0
1237+ 8BD0 3E 09            LD      A, 9
1238+ 8BD2              FillOptionsAreaRowLoop:
1239+ 8BD2 FE 10            CP      16
1240+ 8BD4 CA F3 8B         JP      Z, FillOptionsAreaContinue
1241+ 8BD7 F5               PUSH    AF
1242+ 8BD8 57               LD      D, A
1243+ 8BD9 3E 05            LD      A, 5
1244+ 8BDB              FillOptionsAreaColLoop:
1245+ 8BDB FE 1A            CP      26
1246+ 8BDD 28 10            JR      Z, FillOptionsAreaRowLoopContinue
1247+ 8BDF F5               PUSH    AF
1248+ 8BE0 5F               LD      E, A
1249+ 8BE1
1250+ 8BE1
1251+ 8BE1 3E 00            LD      A, COLOR_BLACK
1252+ 8BE3 CD 28 82         CALL    SetAttributeAtDE
1253+ 8BE6 3E 03            LD      A, TILE_BLOCK_EMPTY
1254+ 8BE8 CD AD 82         CALL    Screen_PrintRamChar
1255+ 8BEB
1256+ 8BEB
1257+ 8BEB F1               POP     AF
1258+ 8BEC 3C               INC     A
1259+ 8BED 18 EC            JR      FillOptionsAreaColLoop
1260+ 8BEF              FillOptionsAreaRowLoopContinue:
1261+ 8BEF F1               POP     AF
1262+ 8BF0 3C               INC     A
1263+ 8BF1 18 DF            JR      FillOptionsAreaRowLoop
1264+ 8BF3              FillOptionsAreaContinue:
1265+ 8BF3 21 3F 97         LD      HL, TEXT_START_LEVEL
1266+ 8BF6 16 0A            LD      D, 10
1267+ 8BF8 1E 06            LD      E, 6
1268+ 8BFA CD 47 82         CALL    Screen_PrintString
1269+ 8BFD
1270+ 8BFD 21 55 97         LD      HL, TEXT_LEVEL_GROWING
1271+ 8C00 16 0C            LD      D, 12
1272+ 8C02 1E 06            LD      E, 6
1273+ 8C04 CD 47 82         CALL    Screen_PrintString
1274+ 8C07
1275+ 8C07 21 4B 97         LD      HL, TEXT_ORIENTATION
1276+ 8C0A 16 0E            LD      D, 14
1277+ 8C0C 1E 06            LD      E, 6
1278+ 8C0E CD 47 82         CALL    Screen_PrintString
1279+ 8C11 C9               RET
1280+ 8C12
1281+ 8C12              ;------------------------------------------------------------------------
1282+ 8C12              ; Fill game area (Horizontal)
1283+ 8C12              ; INPUT: -
1284+ 8C12              ; OUTPUT: -
1285+ 8C12              ; MODIFY: AF, DE, HL, BC
1286+ 8C12              ;-------------------------------------------------------------------------
1287+ 8C12              FillGameAreaH:
1288+ 8C12 1E 00            LD      E, 0
1289+ 8C14 16 00            LD      D, 0
1290+ 8C16 3E 07            LD      A, 7
1291+ 8C18              FillGameAreaHRowLoop:
1292+ 8C18 FE 11            CP      17
1293+ 8C1A C8               RET     Z
1294+ 8C1B F5               PUSH    AF
1295+ 8C1C 57               LD      D, A
1296+ 8C1D 3E 06            LD      A, 6
1297+ 8C1F              FillGameAreaHColLoop:
1298+ 8C1F FE 1A            CP      26
1299+ 8C21 28 10            JR      Z, FillGameAreaHRowLoopContinue
1300+ 8C23 F5               PUSH    AF
1301+ 8C24 5F               LD      E, A
1302+ 8C25
1303+ 8C25
1304+ 8C25 3E 00            LD      A, COLOR_BLACK
1305+ 8C27 CD 28 82         CALL    SetAttributeAtDE
1306+ 8C2A 3E 03            LD      A, TILE_BLOCK_EMPTY
1307+ 8C2C CD AD 82         CALL    Screen_PrintRamChar
1308+ 8C2F
1309+ 8C2F
1310+ 8C2F F1               POP     AF
1311+ 8C30 3C               INC     A
1312+ 8C31 18 EC            JR      FillGameAreaHColLoop
1313+ 8C33              FillGameAreaHRowLoopContinue:
1314+ 8C33 F1               POP     AF
1315+ 8C34 3C               INC     A
1316+ 8C35 18 E1            JR      FillGameAreaHRowLoop
1317+ 8C37
1318+ 8C37              ;------------------------------------------------------------------------
1319+ 8C37              ; Fill game area (Vertical)
1320+ 8C37              ; INPUT: -
1321+ 8C37              ; OUTPUT: -
1322+ 8C37              ; MODIFY: AF, DE, HL, BC
1323+ 8C37              ;-------------------------------------------------------------------------
1324+ 8C37              FillGameAreaV:
1325+ 8C37 1E 00            LD      E, 0
1326+ 8C39 16 00            LD      D, 0
1327+ 8C3B 3E 02            LD      A, 2
1328+ 8C3D              FillGameAreaVRowLoop:
1329+ 8C3D FE 16            CP      22
1330+ 8C3F C8               RET     Z
1331+ 8C40 F5               PUSH    AF
1332+ 8C41 57               LD      D, A
1333+ 8C42 3E 0B            LD      A, 11
1334+ 8C44              FillGameAreaVColLoop:
1335+ 8C44 FE 15            CP      21
1336+ 8C46 28 10            JR      Z, FillGameAreaVRowLoopContinue
1337+ 8C48 F5               PUSH    AF
1338+ 8C49 5F               LD      E, A
1339+ 8C4A
1340+ 8C4A
1341+ 8C4A 3E 00            LD      A, COLOR_BLACK
1342+ 8C4C CD 28 82         CALL    SetAttributeAtDE
1343+ 8C4F 3E 03            LD      A, TILE_BLOCK_EMPTY
1344+ 8C51 CD AD 82         CALL    Screen_PrintRamChar
1345+ 8C54
1346+ 8C54
1347+ 8C54 F1               POP     AF
1348+ 8C55 3C               INC     A
1349+ 8C56 18 EC            JR      FillGameAreaVColLoop
1350+ 8C58              FillGameAreaVRowLoopContinue:
1351+ 8C58 F1               POP     AF
1352+ 8C59 3C               INC     A
1353+ 8C5A 18 E1            JR      FillGameAreaVRowLoop
1354+ 8C5C
1355+ 8C5C              ;------------------------------------------------------------------------
1356+ 8C5C              ; Fill an area with a tile
1357+ 8C5C              ; INPUT: -
1358+ 8C5C              ; OUTPUT: -
1359+ 8C5C              ; MODIFY: AF, DE, HL, BC
1360+ 8C5C              ;-------------------------------------------------------------------------
1361+ 8C5C              FillWallArea:
1362+ 8C5C 3A CC 99         LD      A, (CurrentWallTile)
1363+ 8C5F 47               LD      B, A
1364+ 8C60 1E 00            LD      E, 0
1365+ 8C62 16 00            LD      D, 0
1366+ 8C64 AF               XOR     A
1367+ 8C65              FillAreaWithTileRowLoop:
1368+ 8C65 FE 18            CP      24
1369+ 8C67 C8               RET     Z
1370+ 8C68 F5               PUSH    AF
1371+ 8C69 57               LD      D, A
1372+ 8C6A AF               XOR     A
1373+ 8C6B              FillAreaWithTileColLoop:
1374+ 8C6B FE 20            CP      32
1375+ 8C6D 28 13            JR      Z, FillAreaWithTileRowLoopContinue
1376+ 8C6F F5               PUSH    AF
1377+ 8C70 5F               LD      E, A
1378+ 8C71
1379+ 8C71 D5               PUSH    DE
1380+ 8C72 3E 57            LD      A, 0x57
1381+ 8C74 CD 28 82         CALL    SetAttributeAtDE
1382+ 8C77 D1               POP     DE
1383+ 8C78 D5               PUSH    DE
1384+ 8C79 78               LD      A, B
1385+ 8C7A CD AD 82         CALL    Screen_PrintRamChar
1386+ 8C7D D1               POP     DE
1387+ 8C7E
1388+ 8C7E F1               POP     AF
1389+ 8C7F 3C               INC     A
1390+ 8C80 18 E9            JR      FillAreaWithTileColLoop
1391+ 8C82              FillAreaWithTileRowLoopContinue:
1392+ 8C82 F1               POP     AF
1393+ 8C83 3C               INC     A
1394+ 8C84 18 DF            JR      FillAreaWithTileRowLoop
1395+ 8C86
1396+ 8C86
1397+ 8C86
1398+ 8C86
1399+ 8C86
1400+ 8C86
1401+ 8C86              ;----------------------------------------------------------------------
1402+ 8C86              ;  Show game field
1403+ 8C86              ;  INPUT: -
1404+ 8C86              ;  OUTPUT: -
1405+ 8C86              ;  MODIFY: AF, BC, DE, HL
1406+ 8C86              ;----------------------------------------------------------------------
1407+ 8C86              ShowGameField:
1408+ 8C86 3A 7F 99         LD      A, (CurrentMatrixOrientation)
1409+ 8C89 08               EX      AF, AF'                 ; Save AF in AF'
1410+ 8C8A CD 8E 82         CALL    Screen_Clear            ; Clear screen
1411+ 8C8D 08               EX      AF, AF'                 ; Restore AF
1412+ 8C8E FE 02            CP      ORIENT_EAST
1413+ 8C90 CA B5 8C         JP      Z, ShowGameFieldHorizontal
1414+ 8C93 FE 03            CP      ORIENT_WEST
1415+ 8C95 CA B5 8C         JP      Z, ShowGameFieldHorizontal
1416+ 8C98 FE 00            CP      ORIENT_NORTH
1417+ 8C9A CA A3 8C         JP      Z, ShowGameFieldVertical
1418+ 8C9D FE 01            CP      ORIENT_SOUTH
1419+ 8C9F CA A3 8C         JP      Z, ShowGameFieldVertical
1420+ 8CA2 C9               RET
1421+ 8CA3              ShowGameFieldVertical:
1422+ 8CA3 3E 00            LD      A, TILE_VERTICAL_WALL
1423+ 8CA5 32 CC 99         LD      (CurrentWallTile), A
1424+ 8CA8 CD 5C 8C         CALL    FillWallArea
1425+ 8CAB CD 37 8C         CALL    FillGameAreaV
1426+ 8CAE CD C7 8C         CALL    ClearNextBlockArea
1427+ 8CB1 CD 57 84         CALL    FillScoreArea
1428+ 8CB4 C9               RET
1429+ 8CB5              ShowGameFieldHorizontal:
1430+ 8CB5 3E 04            LD      A, TILE_HORIZONTAL_WALL
1431+ 8CB7 32 CC 99         LD      (CurrentWallTile), A
1432+ 8CBA CD 5C 8C         CALL    FillWallArea
1433+ 8CBD CD 12 8C         CALL    FillGameAreaH
1434+ 8CC0 CD C7 8C         CALL    ClearNextBlockArea
1435+ 8CC3 CD 57 84         CALL    FillScoreArea
1436+ 8CC6 C9               RET
1437+ 8CC7
1438+ 8CC7              ;----------------------------------------------------------------------
1439+ 8CC7              ;  Clear next block area
1440+ 8CC7              ;  INPUT: -
1441+ 8CC7              ;  OUTPUT: -
1442+ 8CC7              ;  MODIFY: AF, BC, DE, HL
1443+ 8CC7              ;----------------------------------------------------------------------
1444+ 8CC7              ClearNextBlockArea:
1445+ 8CC7 3A 7F 99         LD      A, (CurrentMatrixOrientation)
1446+ 8CCA FE 02            CP      ORIENT_EAST
1447+ 8CCC CA E1 8C         JP      Z, ClearNextBlockAreaEast
1448+ 8CCF FE 03            CP      ORIENT_WEST
1449+ 8CD1 CA E5 8C         JP      Z, ClearNextBlockAreaWest
1450+ 8CD4 FE 00            CP      ORIENT_NORTH
1451+ 8CD6 CA DD 8C         JP      Z, ClearNextBlockAreaNorth
1452+ 8CD9 CD AA 8B         CALL    FillNextBlockAreaBottomLeft
1453+ 8CDC C9               RET
1454+ 8CDD              ClearNextBlockAreaNorth:
1455+ 8CDD CD 88 8B         CALL    FillNextBlockAreaTopRight
1456+ 8CE0 C9               RET
1457+ 8CE1              ClearNextBlockAreaEast:
1458+ 8CE1 CD 44 8B         CALL    FillNextBlockAreaBottomRight
1459+ 8CE4 C9               RET
1460+ 8CE5              ClearNextBlockAreaWest:
1461+ 8CE5 CD 66 8B         CALL    FillNextBlockAreaTopLeft
1462+ 8CE8 C9               RET
1463+ 8CE9              ;----------------------------------------------------------------------
1464+ 8CE9              ;  Print matrix
1465+ 8CE9              ;  INPUT:
1466+ 8CE9              ;    A: 250 Refresh all matrix
1467+ 8CE9              ;  OUTPUT: -
1468+ 8CE9              ;  MODIFY: AF, BC, DE, HL
1469+ 8CE9              ;----------------------------------------------------------------------
1470+ 8CE9              PrintMatrix:
1471+ 8CE9 3A AC 99         LD      A, (ForcePrintMatrixRepaintAll)
1472+ 8CEC FE 01            CP      1
1473+ 8CEE 20 0E            JR      NZ, PrintMatrixSetLimits
1474+ 8CF0 3E 00            LD      A, 0
1475+ 8CF2 32 AC 99         LD      (ForcePrintMatrixRepaintAll), A
1476+ 8CF5 3E 14            LD      A, 20
1477+ 8CF7 32 A7 99         LD      (PrintMatrixMaxRow), A
1478+ 8CFA 06 00            LD      B, 0
1479+ 8CFC 18 1A            JR      PrintMatrixContinue2
1480+ 8CFE              PrintMatrixSetLimits:
1481+ 8CFE
1482+ 8CFE
1483+ 8CFE 3A 80 99         LD      A, (SavedY)
1484+ 8D01 FE 00            CP      0
1485+ 8D03 28 01            JR      Z, PrintMatrixContinue
1486+ 8D05 3D               DEC     A
1487+ 8D06              PrintMatrixContinue:
1488+ 8D06 47               LD      B, A           ; C = column (0..9)
1489+ 8D07 3C               INC     A
1490+ 8D08 3C               INC     A
1491+ 8D09 3C               INC     A
1492+ 8D0A 3C               INC     A
1493+ 8D0B 3C               INC     A
1494+ 8D0C 32 A7 99         LD      (PrintMatrixMaxRow), A
1495+ 8D0F FE 15            CP      21
1496+ 8D11 38 05            JR      C, PrintMatrixContinue2
1497+ 8D13 3E 14            LD      A, 20
1498+ 8D15 32 A7 99         LD      (PrintMatrixMaxRow), A
1499+ 8D18              PrintMatrixContinue2:
1500+ 8D18 3A 7F 99         LD      A, (CurrentMatrixOrientation)
1501+ 8D1B FE 00            CP      ORIENT_NORTH
1502+ 8D1D CA 30 8D         JP      Z, PrintMatrixNorth
1503+ 8D20 FE 01            CP      ORIENT_SOUTH
1504+ 8D22 CA 76 8D         JP      Z, PrintMatrixSouth
1505+ 8D25 FE 02            CP      ORIENT_EAST
1506+ 8D27 CA C1 8D         JP      Z, PrintMatrixEast
1507+ 8D2A FE 03            CP      ORIENT_WEST
1508+ 8D2C CA 0A 8E         JP      Z, PrintMatrixWest
1509+ 8D2F C9               RET
1510+ 8D30              ;----------------------------------------------------------------------
1511+ 8D30              ;  PrintMatrixNorth
1512+ 8D30              ;  - Shows the matrix as is (20 rows, 10 columns).
1513+ 8D30              ;  - We center it: offset row = 2, offset col = 11.
1514+ 8D30              ;  - For each (r,c), we read matrix[r*10 + c].
1515+ 8D30              ;    Then we print at (2 + r, 11 + c).
1516+ 8D30              ;----------------------------------------------------------------------
1517+ 8D30              PrintMatrixNorth:
1518+ 8D30                  ;LD      B, 0           ; B = row (0..19)
1519+ 8D30              North_RowLoop:
1520+ 8D30 0E 00            LD      C, 0           ; C = column (0..9)
1521+ 8D32              North_ColLoop:
1522+ 8D32                  ; Calculate address = Matrix + (B*10 + C)
1523+ 8D32 C5               PUSH    BC
1524+ 8D33 78               LD      A, B
1525+ 8D34 26 00            LD      H, 0
1526+ 8D36 6F               LD      L, A
1527+ 8D37 11 0A 00         LD      DE, 10
1528+ 8D3A CD A5 8F         CALL    MultiplyHLbyDE     ; HL = B*10
1529+ 8D3D 79               LD      A, C
1530+ 8D3E 5F               LD      E, A
1531+ 8D3F 16 00            LD      D, 0
1532+ 8D41 19               ADD     HL, DE             ; HL = B*10 + C
1533+ 8D42 11 B7 98         LD      DE, Matrix          ; <-- Load base address of Matrix in DE
1534+ 8D45 19               ADD     HL, DE              ; HL = Matrix + (B*10 + C)
1535+ 8D46 C1               POP     BC
1536+ 8D47
1537+ 8D47                  ;LD      A, (HL)             ; A = cell value (0..8)
1538+ 8D47
1539+ 8D47                  ; Calculate screen row/column
1540+ 8D47                  ; Row (D) = 2 + B
1541+ 8D47 50               LD      D, B
1542+ 8D48 14               INC     D
1543+ 8D49 14               INC     D
1544+ 8D4A                  ; Col (E) = 11 + C
1545+ 8D4A 59               LD      E, C
1546+ 8D4B 7B               LD      A, E
1547+ 8D4C C6 0B            ADD     A, 11
1548+ 8D4E 5F               LD      E, A
1549+ 8D4F
1550+ 8D4F                  ; Restore A with the cell color
1551+ 8D4F 7E               LD      A, (HL)
1552+ 8D50 D5               PUSH    DE
1553+ 8D51 C5               PUSH    BC
1554+ 8D52
1555+ 8D52
1556+ 8D52 F5               PUSH    AF
1557+ 8D53 CD 28 82         CALL    SetAttributeAtDE
1558+ 8D56 F1               POP     AF
1559+ 8D57 FE FF            CP      0xFF
1560+ 8D59 3E 01            LD      A, TILE_BLOCK
1561+ 8D5B 20 02            JR      NZ, PrintMatrixNorthEndContinue
1562+ 8D5D 3E 02            LD      A, TILE_BLOCK_ROW_COMPETED
1563+ 8D5F              PrintMatrixNorthEndContinue:
1564+ 8D5F CD AD 82         CALL    Screen_PrintRamChar
1565+ 8D62 C1               POP     BC
1566+ 8D63 D1               POP     DE
1567+ 8D64 0C               INC     C
1568+ 8D65 79               LD      A, C
1569+ 8D66 FE 0A            CP      10
1570+ 8D68 20 C8            JR      NZ, North_ColLoop
1571+ 8D6A
1572+ 8D6A 04               INC     B
1573+ 8D6B 3A A7 99         LD      A, (PrintMatrixMaxRow)
1574+ 8D6E D5               PUSH    DE
1575+ 8D6F 57               LD      D, A
1576+ 8D70 78               LD      A, B
1577+ 8D71 BA               CP      D
1578+ 8D72 D1               POP     DE
1579+ 8D73 20 BB            JR      NZ, North_RowLoop
1580+ 8D75 C9               RET
1581+ 8D76
1582+ 8D76              ;----------------------------------------------------------------------
1583+ 8D76              ;  PrintMatrixSouth
1584+ 8D76              ;  - Shows the matrix upside down (180°).
1585+ 8D76              ;  - We center it the same way (offset row=2, col=11).
1586+ 8D76              ;  - For (r,c), screen row = 2 + (19 - r), col = 11 + (9 - c).
1587+ 8D76              ;----------------------------------------------------------------------
1588+ 8D76              PrintMatrixSouth:
1589+ 8D76                  ;LD      B, 0
1590+ 8D76              South_RowLoop:
1591+ 8D76 0E 00            LD      C, 0
1592+ 8D78              South_ColLoop:
1593+ 8D78 C5               PUSH    BC
1594+ 8D79 78               LD      A, B
1595+ 8D7A 26 00            LD      H, 0
1596+ 8D7C 6F               LD      L, A
1597+ 8D7D 11 0A 00         LD      DE, 10
1598+ 8D80 CD A5 8F         CALL    MultiplyHLbyDE
1599+ 8D83 79               LD      A, C
1600+ 8D84 5F               LD      E, A
1601+ 8D85 16 00            LD      D, 0
1602+ 8D87 19               ADD     HL, DE
1603+ 8D88 11 B7 98         LD      DE, Matrix
1604+ 8D8B 19               ADD     HL, DE
1605+ 8D8C C1               POP     BC
1606+ 8D8D
1607+ 8D8D 7E               LD      A, (HL)
1608+ 8D8E
1609+ 8D8E                  ; R = 2 + (19 - B)
1610+ 8D8E 50               LD      D, B
1611+ 8D8F 3E 13            LD      A, 19
1612+ 8D91 92               SUB     D
1613+ 8D92 C6 02            ADD     A, 2
1614+ 8D94 57               LD      D, A
1615+ 8D95
1616+ 8D95                  ; C = 11 + (9 - C)
1617+ 8D95 59               LD      E, C
1618+ 8D96 3E 09            LD      A, 9
1619+ 8D98 93               SUB     E
1620+ 8D99 C6 0B            ADD     A, 11
1621+ 8D9B 5F               LD      E, A
1622+ 8D9C
1623+ 8D9C 7E               LD      A, (HL)
1624+ 8D9D D5               PUSH    DE
1625+ 8D9E C5               PUSH    BC
1626+ 8D9F F5               PUSH    AF
1627+ 8DA0 CD 28 82         CALL    SetAttributeAtDE
1628+ 8DA3 F1               POP     AF
1629+ 8DA4 FE FF            CP      0xFF
1630+ 8DA6 3E 01            LD      A, TILE_BLOCK
1631+ 8DA8 20 02            JR      NZ, PrintMatrixSouthEndContinue
1632+ 8DAA 3E 02            LD      A, TILE_BLOCK_ROW_COMPETED
1633+ 8DAC              PrintMatrixSouthEndContinue:
1634+ 8DAC CD AD 82         CALL    Screen_PrintRamChar
1635+ 8DAF C1               POP     BC
1636+ 8DB0 D1               POP     DE
1637+ 8DB1
1638+ 8DB1 0C               INC     C
1639+ 8DB2 79               LD      A, C
1640+ 8DB3 FE 0A            CP      10
1641+ 8DB5 20 C1            JR      NZ, South_ColLoop
1642+ 8DB7
1643+ 8DB7 04               INC     B
1644+ 8DB8 3A A7 99         LD      A, (PrintMatrixMaxRow)
1645+ 8DBB 57               LD      D, A
1646+ 8DBC 78               LD      A, B
1647+ 8DBD BA               CP      D
1648+ 8DBE 20 B6            JR      NZ, South_RowLoop
1649+ 8DC0 C9               RET
1650+ 8DC1
1651+ 8DC1              ;----------------------------------------------------------------------
1652+ 8DC1              ;  PrintMatrixEast
1653+ 8DC1              ;  - Shows the matrix rotated 90° right.
1654+ 8DC1              ;  - Now it becomes 10 rows x 20 columns.
1655+ 8DC1              ;  - Center offsets: row=7, col=6.
1656+ 8DC1              ;  - For (r,c): new_row = c + 7, new_col = (19 - r) + 6.
1657+ 8DC1              ;----------------------------------------------------------------------
1658+ 8DC1              PrintMatrixEast:
1659+ 8DC1                  ;LD      B, 0         ; B = r
1660+ 8DC1              East_RowLoop:
1661+ 8DC1 0E 00            LD      C, 0         ; C = c
1662+ 8DC3              East_ColLoop:
1663+ 8DC3 C5               PUSH    BC
1664+ 8DC4 78               LD      A, B
1665+ 8DC5 26 00            LD      H, 0
1666+ 8DC7 6F               LD      L, A
1667+ 8DC8 11 0A 00         LD      DE, 10
1668+ 8DCB CD A5 8F         CALL    MultiplyHLbyDE
1669+ 8DCE 79               LD      A, C
1670+ 8DCF 5F               LD      E, A
1671+ 8DD0 16 00            LD      D, 0
1672+ 8DD2 19               ADD     HL, DE
1673+ 8DD3 11 B7 98         LD      DE, Matrix          ; <-- Load base address of Matrix in DE
1674+ 8DD6 19               ADD     HL, DE
1675+ 8DD7 C1               POP     BC
1676+ 8DD8
1677+ 8DD8 7E               LD      A, (HL)
1678+ 8DD9
1679+ 8DD9                  ; R = 7 + C
1680+ 8DD9 51               LD      D, C
1681+ 8DDA 7A               LD      A, D
1682+ 8DDB C6 07            ADD     A, 7
1683+ 8DDD 57               LD      D, A
1684+ 8DDE
1685+ 8DDE                  ; C = 6 + (19 - B)
1686+ 8DDE 58               LD      E, B
1687+ 8DDF 3E 13            LD      A, 19
1688+ 8DE1 93               SUB     E
1689+ 8DE2 C6 06            ADD     A, 6
1690+ 8DE4 5F               LD      E, A
1691+ 8DE5
1692+ 8DE5 7E               LD      A, (HL)
1693+ 8DE6 D5               PUSH    DE
1694+ 8DE7 C5               PUSH    BC
1695+ 8DE8 F5               PUSH    AF
1696+ 8DE9 CD 28 82         CALL    SetAttributeAtDE
1697+ 8DEC F1               POP     AF
1698+ 8DED FE FF            CP      0xFF
1699+ 8DEF 3E 01            LD      A, TILE_BLOCK
1700+ 8DF1 20 02            JR      NZ, PrintMatrixEastEndContinue
1701+ 8DF3 3E 02            LD      A, TILE_BLOCK_ROW_COMPETED
1702+ 8DF5              PrintMatrixEastEndContinue:
1703+ 8DF5 CD AD 82         CALL    Screen_PrintRamChar
1704+ 8DF8 C1               POP     BC
1705+ 8DF9 D1               POP     DE
1706+ 8DFA
1707+ 8DFA 0C               INC     C
1708+ 8DFB 79               LD      A, C
1709+ 8DFC FE 0A            CP      10
1710+ 8DFE 20 C3            JR      NZ, East_ColLoop
1711+ 8E00
1712+ 8E00 04               INC     B
1713+ 8E01 3A A7 99         LD      A, (PrintMatrixMaxRow)
1714+ 8E04 57               LD      D, A
1715+ 8E05 78               LD      A, B
1716+ 8E06 BA               CP      D
1717+ 8E07 20 B8            JR      NZ, East_RowLoop
1718+ 8E09 C9               RET
1719+ 8E0A
1720+ 8E0A              ;----------------------------------------------------------------------
1721+ 8E0A              ;  PrintMatrixWest
1722+ 8E0A              ;  - Shows the matrix rotated 90° left.
1723+ 8E0A              ;  - Now it becomes 10 rows x 20 columns.
1724+ 8E0A              ;  - Center offsets: row=7, col=6.
1725+ 8E0A              ;  - For (r,c): new_row = (9 - c) + 7, new_col = r + 6.
1726+ 8E0A              ;----------------------------------------------------------------------
1727+ 8E0A              PrintMatrixWest:
1728+ 8E0A                  ;LD      B, 0
1729+ 8E0A              West_RowLoop:
1730+ 8E0A 0E 00            LD      C, 0
1731+ 8E0C              West_ColLoop:
1732+ 8E0C C5               PUSH    BC
1733+ 8E0D 78               LD      A, B
1734+ 8E0E 26 00            LD      H, 0
1735+ 8E10 6F               LD      L, A
1736+ 8E11 11 0A 00         LD      DE, 10
1737+ 8E14 CD A5 8F         CALL    MultiplyHLbyDE
1738+ 8E17 79               LD      A, C
1739+ 8E18 5F               LD      E, A
1740+ 8E19 16 00            LD      D, 0
1741+ 8E1B 19               ADD     HL, DE
1742+ 8E1C 11 B7 98         LD      DE, Matrix          ; <-- Load base address of Matrix in DE
1743+ 8E1F 19               ADD     HL, DE
1744+ 8E20 C1               POP     BC
1745+ 8E21
1746+ 8E21 7E               LD      A, (HL)
1747+ 8E22
1748+ 8E22                  ; R = 7 + (9 - C)
1749+ 8E22 51               LD      D, C
1750+ 8E23 3E 09            LD      A, 9
1751+ 8E25 92               SUB     D
1752+ 8E26 C6 07            ADD     A, 7
1753+ 8E28 57               LD      D, A
1754+ 8E29
1755+ 8E29                  ; C = 6 + B
1756+ 8E29 58               LD      E, B
1757+ 8E2A 7B               LD      A, E
1758+ 8E2B C6 06            ADD     A, 6
1759+ 8E2D 5F               LD      E, A
1760+ 8E2E
1761+ 8E2E 7E               LD      A, (HL)
1762+ 8E2F D5               PUSH    DE
1763+ 8E30 C5               PUSH    BC
1764+ 8E31 F5               PUSH    AF
1765+ 8E32 CD 28 82         CALL    SetAttributeAtDE
1766+ 8E35 F1               POP     AF
1767+ 8E36 FE FF            CP      0xFF
1768+ 8E38 3E 01            LD      A, TILE_BLOCK
1769+ 8E3A 20 02            JR      NZ, PrintMatrixWestEndContinue
1770+ 8E3C 3E 02            LD      A, TILE_BLOCK_ROW_COMPETED
1771+ 8E3E              PrintMatrixWestEndContinue:
1772+ 8E3E CD AD 82         CALL    Screen_PrintRamChar
1773+ 8E41 C1               POP     BC
1774+ 8E42 D1               POP     DE
1775+ 8E43
1776+ 8E43 0C               INC     C
1777+ 8E44 79               LD      A, C
1778+ 8E45 FE 0A            CP      10
1779+ 8E47 20 C3            JR      NZ, West_ColLoop
1780+ 8E49
1781+ 8E49 04               INC     B
1782+ 8E4A 3A A7 99         LD      A, (PrintMatrixMaxRow)
1783+ 8E4D 57               LD      D, A
1784+ 8E4E 78               LD      A, B
1785+ 8E4F BA               CP      D
1786+ 8E50 20 B8            JR      NZ, West_RowLoop
1787+ 8E52 C9               RET
1788+ 8E53
1789+ 8E53              ;--------------------------------------------------
1790+ 8E53              ; Check blocks collision
1791+ 8E53              ; INPUT: -
1792+ 8E53              ; OUTPUT:
1793+ 8E53              ;   A: 1=Yes - 0=No
1794+ 8E53              ; MODIFY: AF, HL, BC, DE
1795+ 8E53              ;--------------------------------------------------
1796+ 8E53              CheckBlocksCollision:
1797+ 8E53 3A 81 99         LD      A, (SavedX)
1798+ 8E56 32 A9 99         LD      (TempXBlocPosition), A
1799+ 8E59 2A 83 99         LD      HL,(CurrentBlockTable)
1800+ 8E5C 3A A8 99         LD      A, (BlockLeftMoving)
1801+ 8E5F FE 00            CP      0
1802+ 8E61 CA 7A 8E         JP      Z, CheckBlocksCollisionLoop
1803+ 8E64 FE 01            CP      1
1804+ 8E66 CA 73 8E         JP      Z, CheckBlocksCollisionLoopLeft
1805+ 8E69 3A 81 99         LD      A, (SavedX)
1806+ 8E6C 3C               INC     A
1807+ 8E6D 32 A9 99         LD      (TempXBlocPosition), A
1808+ 8E70 C3 7A 8E         JP      CheckBlocksCollisionLoop
1809+ 8E73              CheckBlocksCollisionLoopLeft:
1810+ 8E73 3A 81 99         LD      A, (SavedX)
1811+ 8E76 3D               DEC     A
1812+ 8E77 32 A9 99         LD      (TempXBlocPosition), A
1813+ 8E7A              CheckBlocksCollisionLoop:
1814+ 8E7A 7E               LD      A, (HL)
1815+ 8E7B FE FF            CP      0xFF
1816+ 8E7D CA A3 8E         JP      Z, CheckBlocksCollisionNo
1817+ 8E80 4F               LD      C, A        ; dy
1818+ 8E81 23               INC     HL
1819+ 8E82 7E               LD      A, (HL)     ; dx
1820+ 8E83 23               INC     HL
1821+ 8E84 47               LD      B, A
1822+ 8E85 E5               PUSH    HL
1823+ 8E86                  ; r = SavedY + dy
1824+ 8E86 3A 80 99         LD      A, (SavedY)
1825+ 8E89 81               ADD     A, C
1826+ 8E8A 4F               LD      C, A
1827+ 8E8B
1828+ 8E8B                  ; c = SavedX + dx
1829+ 8E8B 3A A9 99         LD      A, (TempXBlocPosition)
1830+ 8E8E 80               ADD     A, B
1831+ 8E8F 47               LD      B, A
1832+ 8E90
1833+ 8E90                  ; offset = r*10 + c => HL
1834+ 8E90 CD 34 93         CALL    ComputeOffset
1835+ 8E93 11 B7 98         LD      DE, Matrix
1836+ 8E96 19               ADD     HL, DE
1837+ 8E97
1838+ 8E97 7E               LD      A, (HL)
1839+ 8E98 FE 00            CP      COLOR_BLACK
1840+ 8E9A 20 03            JR      NZ, CheckBlocksCollisionYes
1841+ 8E9C E1               POP     HL
1842+ 8E9D 18 DB            JR      CheckBlocksCollisionLoop
1843+ 8E9F
1844+ 8E9F              CheckBlocksCollisionYes:
1845+ 8E9F E1               POP     HL
1846+ 8EA0 3E 01            LD      A, 1
1847+ 8EA2 C9               RET
1848+ 8EA3
1849+ 8EA3
1850+ 8EA3              CheckBlocksCollisionNo:
1851+ 8EA3 AF               XOR A
1852+ 8EA4 C9               RET
1853+ 8EA5              ;--------------------------------------------------
1854+ 8EA5              ; Update current block table
1855+ 8EA5              ; INPUT:
1856+ 8EA5              ;   D: Y position
1857+ 8EA5              ;   E: X position
1858+ 8EA5              ; OUTPUT: -
1859+ 8EA5              ; MODIFY: AF, BC, DE, HL
1860+ 8EA5              ;--------------------------------------------------
1861+ 8EA5              UpdateCurrentBlockTable:
1862+ 8EA5 3A 88 99         LD      A, (CurrentBlock)
1863+ 8EA8 47               LD      B, A                ; Salvo ID in B
1864+ 8EA9 6F               LD      L, A                ; L = ID
1865+ 8EAA 7A               LD      A, D
1866+ 8EAB 32 80 99         LD      (SavedY), A
1867+ 8EAE 7B               LD      A, E
1868+ 8EAF 32 81 99         LD      (SavedX), A
1869+ 8EB2 26 00            LD      H, 0
1870+ 8EB4 11 7C 96         LD      DE, BLOCK_COLORS
1871+ 8EB7 19               ADD     HL, DE              ; HL -> &BLOCK_COLORS[ID]
1872+ 8EB8 7E               LD      A, (HL)             ; A = colore
1873+ 8EB9 32 82 99         LD      (ColorOfBlock), A   ; mettiamo in una variabile
1874+ 8EBC 3A 87 99         LD      A, (CurrentBlockRotation) ; A = rotazione (0..3)
1875+ 8EBF 68               LD      L, B                       ; L = ID salvato prima
1876+ 8EC0 CB 25            SLA     L
1877+ 8EC2 CB 25            SLA     L                          ; L = ID*4
1878+ 8EC4 85               ADD     A, L                       ; A = (ID*4) + rot
1879+ 8EC5 6F               LD      L, A
1880+ 8EC6 26 00            LD      H, 0
1881+ 8EC8 29               ADD     HL, HL                     ; HL *= 2 (ogni voce della tabella = 2 byte)
1882+ 8EC9 11 BB 96         LD      DE, BLOCKS_TABLE
1883+ 8ECC 19               ADD     HL, DE                     ; HL => DW con l'indirizzo giusto
1884+ 8ECD 5E               LD      E, (HL)
1885+ 8ECE 23               INC     HL
1886+ 8ECF 56               LD      D, (HL)
1887+ 8ED0 EB               EX      DE, HL
1888+ 8ED1 22 83 99         LD      (CurrentBlockTable), HL
1889+ 8ED4 C9               RET
1890+ 8ED5              ;------------------------------------------------------------------------
1891+ 8ED5              ; Delay
1892+ 8ED5              ; INPUT: -
1893+ 8ED5              ; OUTPUT: -
1894+ 8ED5              ; MODIFY: AF, BC
1895+ 8ED5              ;------------------------------------------------------------------------
1896+ 8ED5              Delay:
1897+ 8ED5 01 20 01         LD      BC, 0x0120              ; Set a counter
1898+ 8ED8              .DelayLoop:
1899+ 8ED8 0B               DEC     BC
1900+ 8ED9 78               LD      A, B
1901+ 8EDA B1               OR      C
1902+ 8EDB 20 FB            JR      NZ, .DelayLoop          ; Wait until BC is 0
1903+ 8EDD C9               RET
1904+ 8EDE              ; ---------------------------------------------------------------------
1905+ 8EDE              ; Remove completed rows
1906+ 8EDE              ; ---------------------------------------------------------------------
1907+ 8EDE              RemoveCompletedRows:
1908+ 8EDE 06 13            LD      B, 19               ; Partiamo dalla riga più bassa (19)
1909+ 8EE0              RemoveCompletedLoop:
1910+ 8EE0 78               LD      A, B
1911+ 8EE1 FE 00            CP      0                   ; Se siamo alla riga 0, fermati
1912+ 8EE3 28 0F            JR      Z, RemoveCompletedEnd
1913+ 8EE5
1914+ 8EE5                  ; Controlla la prima colonna della riga corrente
1915+ 8EE5 C5               PUSH    BC
1916+ 8EE6 CD FA 8E         CALL    CheckFirstColumnFF  ; Z=1 se la prima colonna è 0xFF
1917+ 8EE9 C1               POP     BC
1918+ 8EEA FE 00            CP      0
1919+ 8EEC 28 03            JR      Z, RemoveCompletedSkipRow         ; Se Z=0, passa alla riga successiva
1920+ 8EEE
1921+ 8EEE                  ; Se la prima colonna è 0xFF, sposta le righe superiori verso il basso
1922+ 8EEE CD 0F 8F         CALL    ShiftRowsDown
1923+ 8EF1
1924+ 8EF1              RemoveCompletedSkipRow:
1925+ 8EF1 05               DEC     B                   ; Passa alla riga superiore
1926+ 8EF2 18 EC            JR      RemoveCompletedLoop            ; Continua il ciclo
1927+ 8EF4
1928+ 8EF4              RemoveCompletedEnd:
1929+ 8EF4 3E 01            LD      A, 0x1
1930+ 8EF6 32 AC 99         LD      (ForcePrintMatrixRepaintAll), A
1931+ 8EF9 C9               RET
1932+ 8EFA
1933+ 8EFA              ; ---------------------------------------------------------------------
1934+ 8EFA              ; CheckFirstColumnFF
1935+ 8EFA              ; Controlla se la prima colonna della riga specificata è 0xFF.
1936+ 8EFA              ; Input:
1937+ 8EFA              ;   B = numero della riga (0..19)
1938+ 8EFA              ; Output:
1939+ 8EFA              ;   Z=1 se la prima colonna è 0xFF, Z=0 altrimenti
1940+ 8EFA              ; ---------------------------------------------------------------------
1941+ 8EFA              CheckFirstColumnFF:
1942+ 8EFA
1943+ 8EFA 48               LD      C, B
1944+ 8EFB 06 00            LD      B, 0
1945+ 8EFD CD 34 93         CALL    ComputeOffset
1946+ 8F00 11 B7 98         LD      DE, Matrix
1947+ 8F03 19               ADD     HL, DE
1948+ 8F04 7E               LD      A, (HL)
1949+ 8F05 FE FF            CP      0xFF                ; Confronta con 0xFF
1950+ 8F07 28 03            JR      Z, CheckFirstColumnFFContinue
1951+ 8F09 AF               XOR     A
1952+ 8F0A 18 02            JR      CheckFirstColumnFFEnd
1953+ 8F0C              CheckFirstColumnFFContinue:
1954+ 8F0C 3E 01            LD      A, 1
1955+ 8F0E              CheckFirstColumnFFEnd:
1956+ 8F0E C9               RET
1957+ 8F0F
1958+ 8F0F              ; ---------------------------------------------------------------------
1959+ 8F0F              ; ShiftRowsDown
1960+ 8F0F              ; Sposta tutte le righe superiori verso il basso, riempie la riga 0
1961+ 8F0F              ; con COLOR_BLACK.
1962+ 8F0F              ; Input:
1963+ 8F0F              ;   B = numero della riga corrente (da spostare verso il basso)
1964+ 8F0F              ; ---------------------------------------------------------------------
1965+ 8F0F              ShiftRowsDown:
1966+ 8F0F C5               PUSH    BC
1967+ 8F10 05               DEC     B                   ; Passa alla riga corrente
1968+ 8F11 48               LD      C, B
1969+ 8F12 06 00            LD      B, 0
1970+ 8F14 C5               PUSH    BC
1971+ 8F15 CD 34 93         CALL    ComputeOffset
1972+ 8F18 C1               POP     BC
1973+ 8F19 11 B7 98         LD      DE, Matrix
1974+ 8F1C 19               ADD     HL, DE   ; HL=Start position to copy from
1975+ 8F1D E5               PUSH    HL
1976+ 8F1E AF               XOR     A
1977+ 8F1F              ShiftRowsDownLoop:
1978+ 8F1F 4F               LD      C, A
1979+ 8F20 7E               LD      A, (HL) ; Value to copy
1980+ 8F21 23               INC     HL
1981+ 8F22 23               INC     HL
1982+ 8F23 23               INC     HL
1983+ 8F24 23               INC     HL
1984+ 8F25 23               INC     HL
1985+ 8F26 23               INC     HL
1986+ 8F27 23               INC     HL
1987+ 8F28 23               INC     HL
1988+ 8F29 23               INC     HL
1989+ 8F2A 23               INC     HL
1990+ 8F2B 77               LD      (HL), A ; Copy value to the next row
1991+ 8F2C 2B               DEC     HL
1992+ 8F2D 2B               DEC     HL
1993+ 8F2E 2B               DEC     HL
1994+ 8F2F 2B               DEC     HL
1995+ 8F30 2B               DEC     HL
1996+ 8F31 2B               DEC     HL
1997+ 8F32 2B               DEC     HL
1998+ 8F33 2B               DEC     HL
1999+ 8F34 2B               DEC     HL
2000+ 8F35 79               LD      A, C
2001+ 8F36 3C               INC     A
2002+ 8F37 FE 0A            CP      10
2003+ 8F39 28 02            JR      Z, ShiftRowsDownLoopEnd
2004+ 8F3B 18 E2            JR      ShiftRowsDownLoop
2005+ 8F3D              ShiftRowsDownLoopEnd:
2006+ 8F3D E1               POP     HL
2007+ 8F3E C1               POP     BC
2008+ 8F3F 78               LD      A, B
2009+ 8F40 3D               DEC     A
2010+ 8F41 FE 00            CP      0
2011+ 8F43 C8               RET     Z
2012+ 8F44                  ;LD      B, 20
2013+ 8F44 3E FF            LD      A, 0xFF
2014+ 8F46 77               LD      (HL), A ; Fill the first row with 0xFF
2015+ 8F47 C9               RET
2016+ 8F48              FillTopRow:
2017+ 8F48                  ; Riempie la riga 0 con COLOR_BLACK
2018+ 8F48 16 00            LD      D, 0
2019+ 8F4A 1E 00            LD      E, 0
2020+ 8F4C CD 58 8F         CALL    ComputeRowAddress   ; HL = indirizzo della riga 0
2021+ 8F4F 0E 0A            LD      C, 10               ; Numero di colonne
2022+ 8F51              FillRowLoop:
2023+ 8F51 36 00            LD      (HL), COLOR_BLACK   ; Riempie con COLOR_BLACK
2024+ 8F53 23               INC     HL
2025+ 8F54 0D               DEC     C
2026+ 8F55 20 FA            JR      NZ, FillRowLoop
2027+ 8F57 C9               RET
2028+ 8F58
2029+ 8F58              ; ---------------------------------------------------------------------
2030+ 8F58              ; ComputeRowAddress
2031+ 8F58              ; Calcola l'indirizzo della riga in Matrix.
2032+ 8F58              ; Input:
2033+ 8F58              ;   D = 0
2034+ 8F58              ;   E = numero della riga (0..19)
2035+ 8F58              ; Output:
2036+ 8F58              ;   HL = indirizzo della riga in Matrix
2037+ 8F58              ; ---------------------------------------------------------------------
2038+ 8F58              ComputeRowAddress:
2039+ 8F58 21 B7 98         LD      HL, Matrix          ; Base della matrice
2040+ 8F5B 7B               LD      A, E
2041+ 8F5C CD 3E 93         CALL    MulByteBy10         ; HL = E * 10
2042+ 8F5F 29               ADD     HL, HL              ; HL = Matrix + (E * 10)
2043+ 8F60 C9               RET
2044+ 8F61              ;--------------------------------------------------
2045+ 8F61              ; Place block into matrix (with collision check)
2046+ 8F61              ; INPUT:
2047+ 8F61              ;   D: Y position
2048+ 8F61              ;   E: X position
2049+ 8F61              ; OUTPUT: -
2050+ 8F61              ; MODIFY: AF, BC, HL
2051+ 8F61              ;--------------------------------------------------
2052+ 8F61              PlaceBlock:
2053+ 8F61 CD A5 8E         CALL    UpdateCurrentBlockTable
2054+ 8F64 CD 53 8E         CALL    CheckBlocksCollision
2055+ 8F67 FE 00            CP      0
2056+ 8F69 28 0F            JR      Z, CheckOk
2057+ 8F6B              Collision:
2058+ 8F6B
2059+ 8F6B 32 C4 99         LD      (ShowNextBlock), A
2060+ 8F6E 3A 80 99         LD      A, (SavedY)
2061+ 8F71 FE 00            CP      0
2062+ 8F73 CA 9F 8F         JP      Z, NoMoreBlocks
2063+ 8F76 3D               DEC     A
2064+ 8F77 32 80 99         LD      (SavedY), A
2065+ 8F7A
2066+ 8F7A              CheckOk:
2067+ 8F7A                  ; => arrivati a 0xFF => nessuna collisione
2068+ 8F7A                  ;XOR     A
2069+ 8F7A                  ;ADC     A, A      ; forziamo CF=0 (modo classico: "OR A" + "Ccf" e simili)
2070+ 8F7A 2A 83 99         LD      HL,(CurrentBlockTable)
2071+ 8F7D                  ;LD      A, (ColorOfBlock)
2072+ 8F7D              PlaceBlockLoop:
2073+ 8F7D 7E               LD      A, (HL)
2074+ 8F7E FE FF            CP      0xFF
2075+ 8F80 C8               RET     Z
2076+ 8F81 4F               LD      C, A        ; dy
2077+ 8F82 23               INC     HL
2078+ 8F83 7E               LD      A, (HL)     ; dx
2079+ 8F84 23               INC     HL
2080+ 8F85 47               LD      B, A
2081+ 8F86 E5               PUSH    HL
2082+ 8F87                  ; r = SavedY + dy
2083+ 8F87 3A 80 99         LD      A, (SavedY)
2084+ 8F8A 81               ADD     A, C
2085+ 8F8B 4F               LD      C, A
2086+ 8F8C
2087+ 8F8C                  ; c = SavedX + dx
2088+ 8F8C 3A 81 99         LD      A, (SavedX)
2089+ 8F8F 80               ADD     A, B
2090+ 8F90 47               LD      B, A
2091+ 8F91
2092+ 8F91                  ; offset = r*10 + c => HL
2093+ 8F91 CD 34 93         CALL    ComputeOffset
2094+ 8F94 11 B7 98         LD      DE, Matrix
2095+ 8F97 19               ADD     HL, DE
2096+ 8F98
2097+ 8F98 3A 82 99         LD      A, (ColorOfBlock)
2098+ 8F9B 77               LD      (HL), A
2099+ 8F9C E1               POP     HL
2100+ 8F9D 18 DE            JR      PlaceBlockLoop
2101+ 8F9F
2102+ 8F9F              NoMoreBlocks: ; GAME OVER
2103+ 8F9F 3E 01            LD      A, 1
2104+ 8FA1 32 DD 99         LD      (GameOver), A
2105+ 8FA4 C9               RET
2106+ 8FA5
2107+ 8FA5              ;--------------------------------------------------
2108+ 8FA5              ; Multiply HL by DE
2109+ 8FA5              ; INPUT:
2110+ 8FA5              ;   DE: First value to multiply (16-bit)
2111+ 8FA5              ;   HL: Second value to multiply (16-bit)
2112+ 8FA5              ; OUTPUT:
2113+ 8FA5              ;   HL: result of multiplication
2114+ 8FA5              ; MODIFIY: DE, HL, BC
2115+ 8FA5              ;--------------------------------------------------
2116+ 8FA5              MultiplyHLbyDE:
2117+ 8FA5 C5               PUSH    BC
2118+ 8FA6 44               LD      B, H
2119+ 8FA7 4D               LD      C, L
2120+ 8FA8 AF               XOR     A
2121+ 8FA9 67               LD      H, A
2122+ 8FAA 6F               LD      L, A
2123+ 8FAB 3E 10            LD      A, 16
2124+ 8FAD              MulLoop:
2125+ 8FAD CB 41            BIT     0, C
2126+ 8FAF 28 01            JR      Z, SkipAdd
2127+ 8FB1                  ; Se e' 1 => HL = HL + DE
2128+ 8FB1 19               ADD     HL, DE
2129+ 8FB2              SkipAdd:
2130+ 8FB2 CB 39            SRL     C
2131+ 8FB4 CB 18            RR      B
2132+ 8FB6 CB 23            SLA     E
2133+ 8FB8 CB 12            RL      D
2134+ 8FBA 3D               DEC     A
2135+ 8FBB 20 F0            JR      NZ, MulLoop
2136+ 8FBD C1               POP     BC
2137+ 8FBE C9               RET
2138+ 8FBF              ;--------------------------------------------------
2139+ 8FBF              ; Game over
2140+ 8FBF              ; INPUT: -
2141+ 8FBF              ; OUTPUT: -
2142+ 8FBF              ; MODIFY: AF, BC, DE, HL
2143+ 8FBF              ;--------------------------------------------------
2144+ 8FBF              ShowGameOver:
2145+ 8FBF
2146+ 8FBF F3               DI
2147+ 8FC0 ED 56            IM 1       ; Torna alla modalità interrupt standard
2148+ 8FC2 FB               EI
2149+ 8FC3
2150+ 8FC3 21 B7 98         LD   HL, Matrix            ; HL punta all'inizio della matrice
2151+ 8FC6 06 00            LD   B,0
2152+ 8FC8 0E C8            LD   C, 200                 ; BC = contatore di byte da scorrere
2153+ 8FCA
2154+ 8FCA              ShowGameOverNextByte:
2155+ 8FCA 7E               LD   A, (HL)               ; Carica il valore corrente
2156+ 8FCB FE 00            CP   COLOR_BLACK           ; È nero?
2157+ 8FCD 28 02            JR   Z, ShowGameOverSkipReplace        ; Se sì, salta
2158+ 8FCF
2159+ 8FCF 36 38            LD   (HL), COLOR_WHITE     ; Altrimenti, imposta bianco
2160+ 8FD1
2161+ 8FD1              ShowGameOverSkipReplace:
2162+ 8FD1 23               INC  HL                    ; Passa al prossimo byte
2163+ 8FD2 0B               DEC  BC
2164+ 8FD3 78               LD   A, B
2165+ 8FD4 B1               OR   C
2166+ 8FD5 C2 CA 8F         JP   NZ, ShowGameOverNextByte          ; Finché BC ≠ 0
2167+ 8FD8
2168+ 8FD8 3E 01            LD     A, 1
2169+ 8FDA 32 AC 99         LD     (ForcePrintMatrixRepaintAll), A
2170+ 8FDD CD E9 8C         CALL   PrintMatrix
2171+ 8FE0
2172+ 8FE0
2173+ 8FE0
2174+ 8FE0 1E 0B            LD     E, 11
2175+ 8FE2 16 0B            LD     D, 11
2176+ 8FE4 21 12 97         LD     HL, TEXT_GAME_OVER_1
2177+ 8FE7 CD 47 82         CALL   Screen_PrintString
2178+ 8FEA
2179+ 8FEA 1E 0B            LD     E, 11
2180+ 8FEC 16 0C            LD     D, 12
2181+ 8FEE 21 1D 97         LD     HL, TEXT_GAME_OVER_2
2182+ 8FF1 CD 47 82         CALL   Screen_PrintString
2183+ 8FF4
2184+ 8FF4 1E 0B            LD     E, 11
2185+ 8FF6 16 0D            LD     D, 13
2186+ 8FF8 21 28 97         LD     HL, TEXT_GAME_OVER_3
2187+ 8FFB CD 47 82         CALL   Screen_PrintString
2188+ 8FFE
2189+ 8FFE 1E 0B            LD     E, 11
2190+ 9000 16 0E            LD     D, 14
2191+ 9002 21 12 97         LD     HL, TEXT_GAME_OVER_1
2192+ 9005 CD 47 82         CALL   Screen_PrintString
2193+ 9008 CD 0B 84         CALL   GameOverSound
2194+ 900B              ShowGameOverKeyPress:
2195+ 900B CD B4 94         CALL   ReadKeyboard
2196+ 900E 3A AB 99         LD     A, (KeyPressed)
2197+ 9011 FE 20            CP     32
2198+ 9013 CA FD 99         JP     Z, InitMenu
2199+ 9016 18 F3            JR     ShowGameOverKeyPress
2200+ 9018              ;--------------------------------------------------
2201+ 9018              ; Init new game
2202+ 9018              ;--------------------------------------------------
2203+ 9018              InitNewGame:
2204+ 9018 AF               XOR     A
2205+ 9019 32 DE 99         LD      (MusicNoteIndex),A
2206+ 901C 32 DD 99         LD      (GameOver), A
2207+ 901F 32 AD 99         LD      (CompletedRows), A
2208+ 9022 32 9D 99         LD      (FrameCounter), A
2209+ 9025 32 9E 99         LD      (SecondsCounter), A
2210+ 9028 32 9F 99         LD      (MinutesCounter), A
2211+ 902B 32 A0 99         LD      (Score), A
2212+ 902E 32 C4 99         LD      (ShowNextBlock), A
2213+ 9031 32 A6 99         LD      (BlockSpeedCounter), A
2214+ 9034 26 00            LD      H, 0
2215+ 9036 2E 00            LD      L, 0
2216+ 9038 22 CD 99         LD      (PlacedBlocks), HL              ; Set the number of blocks to 0
2217+ 903B 22 A0 99         LD      (Score), HL                     ; Set the score to 0
2218+ 903E
2219+ 903E F3               DI                                      ; Disable interrupts
2220+ 903F ED 5E            IM      2                               ; Set the interrupt mode
2221+ 9041 FB               EI                                      ; Enable interrupts
2222+ 9042 C9               RET
2223+ 9043
2224+ 9043              ;--------------------------------------------------
2225+ 9043              ; Set M2 interrupt routine
2226+ 9043              ; INPUT: -
2227+ 9043              ; OUTPUT: -
2228+ 9043              ; MODIFY: AF, BC, DE, HL
2229+ 9043              ;--------------------------------------------------
2230+ 9043              SetM2RRoutine:
2231+ 9043 21 AE 90         LD      HL,M2Routine
2232+ 9046 DD 21 F0 FF      LD      IX,0xFFF0                       ; This code is to be written at 0xFF
2233+ 904A DD 36 04 C3      LD      (IX+04h),0xC3                   ; Opcode for JP
2234+ 904E DD 75 05         LD      (IX+05h),L                      ; Store the address of the interrupt routine in
2235+ 9051 DD 74 06         LD      (IX+06h),H
2236+ 9054 DD 36 0F 18      LD      (IX+0Fh),0x18                   ; Opcode for JR; this will do JR to FFF4h
2237+ 9058 3E 39            LD      A,0x39                          ; Interrupt table at page 0x3900 (ROM)
2238+ 905A ED 47            LD      I,A                             ; Set the interrupt register to that page
2239+ 905C C9               RET
2240+ 905D              ;----------------------------------------------------
2241+ 905D              ; Move block down
2242+ 905D              ;----------------------------------------------------
2243+ 905D              MoveBlockDown:
2244+ 905D 0E 13            LD      C, 19
2245+ 905F 3A 88 99         LD      A, (CurrentBlock)
2246+ 9062 FE 00            CP      0
2247+ 9064 20 02            JR      NZ, MoveBlockDownNoIBlock
2248+ 9066 0E 14            LD      C, 20
2249+ 9068              MoveBlockDownNoIBlock:
2250+ 9068 47               LD      B, A
2251+ 9069 3A 87 99         LD      A, (CurrentBlockRotation) ; A = rotazione (0..3)
2252+ 906C 68               LD      L, B                       ; L = ID salvato prima
2253+ 906D CB 25            SLA     L
2254+ 906F CB 25            SLA     L                          ; L = ID*4
2255+ 9071 85               ADD     A, L                       ; A = (ID*4) + rot
2256+ 9072 6F               LD      L, A
2257+ 9073 26 00            LD      H, 0
2258+ 9075 11 9F 96         LD      DE, BLOCKS_HEIGHT
2259+ 9078 19               ADD     HL, DE                      ; HL => DW con l'indirizzo giusto
2260+ 9079 46               LD      B, (HL)                     ; Current block height
2261+ 907A 3A 80 99         LD      A, (SavedY)
2262+ 907D 80               ADD     B
2263+ 907E FE 14            CP      20
2264+ 9080 20 0A            JR      NZ, MoveBlockDownCheckBottomLimit       ; Continue moving if not at the bottom
2265+ 9082 AF               XOR     A
2266+ 9083 32 A6 99         LD      (BlockSpeedCounter), A
2267+ 9086 3E 01            LD      A, 1
2268+ 9088 32 C4 99         LD      (ShowNextBlock), A
2269+ 908B C9               RET
2270+ 908C              MoveBlockDownCheckBottomLimit:
2271+ 908C AF               XOR     A
2272+ 908D 32 A6 99         LD      (BlockSpeedCounter), A
2273+ 9090 3A 80 99         LD      A, (SavedY)
2274+ 9093 3C               INC     A
2275+ 9094 B9               CP      C
2276+ 9095 20 06            JR      NZ, MoveBlockDownContinue       ; Continue moving if not at the bottom
2277+ 9097 3E 01            LD      A, 1
2278+ 9099 32 C4 99         LD      (ShowNextBlock), A
2279+ 909C C9               RET
2280+ 909D              MoveBlockDownContinue:
2281+ 909D F5               PUSH    AF
2282+ 909E CD F6 92         CALL    RemoveCurrentBlock
2283+ 90A1 F1               POP     AF
2284+ 90A2 32 80 99         LD      (SavedY), A           ; Increment the Y position
2285+ 90A5 57               LD      D, A
2286+ 90A6 3A 81 99         LD      A, (SavedX)           ; Increment the Y position
2287+ 90A9 5F               LD      E, A           ; Get the X position
2288+ 90AA CD 61 8F         CALL    PlaceBlock
2289+ 90AD C9               RET
2290+ 90AE
2291+ 90AE              ;---------------------------------------------------
2292+ 90AE              ; M2 routine
2293+ 90AE              ;---------------------------------------------------
2294+ 90AE              M2Routine:
2295+ 90AE F3               DI                                      ; Disable interrupts
2296+ 90AF F5               PUSH    AF                                 ; Save all the registers on the stack
2297+ 90B0 C5               PUSH    BC                                 ; This is probably not necessary unless
2298+ 90B1 D5               PUSH    DE                                 ; we're looking at returning cleanly
2299+ 90B2 E5               PUSH    HL                                 ; back to BASIC at some point
2300+ 90B3 DD E5            PUSH    IX
2301+ 90B5 D9               EXX
2302+ 90B6 08               EX      AF,AF'
2303+ 90B7 F5               PUSH    AF
2304+ 90B8 C5               PUSH    BC
2305+ 90B9 D5               PUSH    DE
2306+ 90BA E5               PUSH    HL
2307+ 90BB FD E5            PUSH    IY
2308+ 90BD
2309+ 90BD                  ;
2310+ 90BD
2311+ 90BD
2312+ 90BD
2313+ 90BD 3A 9D 99         LD      A, (FrameCounter)
2314+ 90C0 3C               INC     A
2315+ 90C1 FE 33            CP      51
2316+ 90C3 20 15            JR      NZ, M2RoutineContinue
2317+ 90C5 3A 9E 99         LD      A, (SecondsCounter)
2318+ 90C8 3C               INC     A
2319+ 90C9 FE 3D            CP      61
2320+ 90CB 20 08            JR      NZ, M2RoutineNoNewMinute
2321+ 90CD 3A 9F 99         LD      A, (MinutesCounter)
2322+ 90D0 3C               INC     A
2323+ 90D1 32 9F 99         LD      (MinutesCounter), A
2324+ 90D4 AF               XOR     A                            ; Reset the seconds counter
2325+ 90D5              M2RoutineNoNewMinute:
2326+ 90D5 32 9E 99         LD      (SecondsCounter), A
2327+ 90D8 3E 00            LD      A, 0                            ; Reset the frame counter
2328+ 90DA              M2RoutineContinue:
2329+ 90DA 32 9D 99         LD      (FrameCounter), A
2330+ 90DD
2331+ 90DD 3A DF 99         LD      A, (InGame)
2332+ 90E0 FE 01            CP      1
2333+ 90E2 28 43            JR      Z, M2RoutineInGame
2334+ 90E4 3A 9D 99         LD      A, (FrameCounter)
2335+ 90E7 FE 00            CP      0
2336+ 90E9 CA 21 91         JP      Z, PlayMenuMusic
2337+ 90EC FE 00            CP      0
2338+ 90EE CA 21 91         JP      Z, PlayMenuMusic
2339+ 90F1 FE 0A            CP      10
2340+ 90F3 CA 21 91         JP      Z, PlayMenuMusic
2341+ 90F6 FE 14            CP      20
2342+ 90F8 CA 21 91         JP      Z, PlayMenuMusic
2343+ 90FB FE 1E            CP      30
2344+ 90FD CA 21 91         JP      Z, PlayMenuMusic
2345+ 9100 FE 28            CP      40
2346+ 9102 CA 21 91         JP      Z, PlayMenuMusic
2347+ 9105
2348+ 9105
2349+ 9105 FE 05            CP      5
2350+ 9107 CA 21 91         JP      Z, PlayMenuMusic
2351+ 910A FE 0F            CP      15
2352+ 910C CA 21 91         JP      Z, PlayMenuMusic
2353+ 910F FE 19            CP      25
2354+ 9111 CA 21 91         JP      Z, PlayMenuMusic
2355+ 9114 FE 23            CP      35
2356+ 9116 CA 21 91         JP      Z, PlayMenuMusic
2357+ 9119 FE 2D            CP      45
2358+ 911B CA 21 91         JP      Z, PlayMenuMusic
2359+ 911E
2360+ 911E C3 72 91         JP      M2RoutineBlockMoveExit
2361+ 9121              PlayMenuMusic:
2362+ 9121 CD 31 84         CALL    PlayInGameMusic
2363+ 9124 C3 72 91         JP      M2RoutineBlockMoveExit
2364+ 9127
2365+ 9127              M2RoutineInGame:
2366+ 9127
2367+ 9127 3A AB 99         LD      A, (KeyPressed)
2368+ 912A FE 20            CP      32
2369+ 912C CA CF 92         JP      Z, MoveBlockToBottom
2370+ 912F FE 33            CP      51
2371+ 9131 CA CF 92         JP      Z, MoveBlockToBottom
2372+ 9134 FE 34            CP      52
2373+ 9136 CA 82 91         JP      Z, MoveBlockLeft
2374+ 9139 FE 35            CP      53
2375+ 913B CA 1F 92         JP      Z, BlockRotation
2376+ 913E FE 36            CP      54
2377+ 9140 CA C8 91         JP      Z, MoveBlockRight
2378+ 9143 FE 00            CP      0
2379+ 9145 28 0F            JR      Z, M2RoutineBlockMoveDown
2380+ 9147 18 22            JR      M2RoutineBlockMoveEnd
2381+ 9149              M2RoutineKeyOk:
2382+ 9149 3A 80 99         LD      A, (SavedY)
2383+ 914C 57               LD      D, A
2384+ 914D 3A 81 99         LD      A, (SavedX)           ; Increment the Y position
2385+ 9150 5F               LD      E, A           ; Get the X position
2386+ 9151 CD 61 8F         CALL    PlaceBlock
2387+ 9154
2388+ 9154 18 15            JR      M2RoutineBlockMoveEnd
2389+ 9156              M2RoutineBlockMoveDown:
2390+ 9156 AF               XOR     A
2391+ 9157 32 A8 99         LD      (BlockLeftMoving), A
2392+ 915A 21 A5 99         LD      HL, BlockSpeed
2393+ 915D 3A A6 99         LD      A, (BlockSpeedCounter)
2394+ 9160 BE               CP      (HL)
2395+ 9161 CC 5D 90         CALL    Z, MoveBlockDown
2396+ 9164 3A A6 99         LD      A, (BlockSpeedCounter)
2397+ 9167 3C               INC     A
2398+ 9168 32 A6 99         LD      (BlockSpeedCounter), A
2399+ 916B              M2RoutineBlockMoveEnd:
2400+ 916B AF               XOR     A
2401+ 916C 32 AB 99         LD      (KeyPressed), A
2402+ 916F CD E9 8C         CALL    PrintMatrix             ; Display the initial matrix
2403+ 9172              M2RoutineBlockMoveExit:
2404+ 9172 FD E1            POP     IY                                  ; Restore all the registers
2405+ 9174 E1               POP     HL
2406+ 9175 D1               POP     DE
2407+ 9176 C1               POP     BC
2408+ 9177 F1               POP     AF
2409+ 9178 D9               EXX
2410+ 9179 08               EX      AF,AF'
2411+ 917A DD E1            POP     IX
2412+ 917C E1               POP     HL
2413+ 917D D1               POP     DE
2414+ 917E C1               POP     BC
2415+ 917F F1               POP     AF
2416+ 9180 FB               EI                                      ; Enable interrupts
2417+ 9181 C9               RET                                     ; And return
2418+ 9182
2419+ 9182              MoveBlockLeft:
2420+ 9182 3A 7F 99         LD      A, (CurrentMatrixOrientation)
2421+ 9185 FE 03            CP      ORIENT_WEST
2422+ 9187 CA 92 91         JP      Z, MoveBlockLeftContinue
2423+ 918A FE 00            CP      ORIENT_NORTH
2424+ 918C CA 92 91         JP      Z, MoveBlockLeftContinue
2425+ 918F C3 D8 91         JP      MoveBlockRightContinue
2426+ 9192              MoveBlockLeftContinue:
2427+ 9192 3E 01            LD      A, 1
2428+ 9194 32 A8 99         LD      (BlockLeftMoving), A
2429+ 9197 CD F6 92         CALL    RemoveCurrentBlock
2430+ 919A 3A 81 99         LD      A, (SavedX)
2431+ 919D FE 00            CP      0
2432+ 919F CA 49 91         JP      Z, M2RoutineKeyOk
2433+ 91A2 3D               DEC     A
2434+ 91A3 5F               LD      E, A
2435+ 91A4 3A 80 99         LD      A, (SavedY)
2436+ 91A7 57               LD      D, A
2437+ 91A8 CD A5 8E         CALL    UpdateCurrentBlockTable
2438+ 91AB 3A 81 99         LD      A, (SavedX)
2439+ 91AE 3C               INC     A
2440+ 91AF 32 81 99         LD      (SavedX), A
2441+ 91B2 CD 53 8E         CALL    CheckBlocksCollision
2442+ 91B5 FE 01            CP      1
2443+ 91B7 CA 56 91         JP      Z, M2RoutineBlockMoveDown
2444+ 91BA AF               XOR     A
2445+ 91BB 32 A8 99         LD      (BlockLeftMoving), A
2446+ 91BE 3A 81 99         LD      A, (SavedX)
2447+ 91C1 3D               DEC     A
2448+ 91C2 32 81 99         LD      (SavedX), A
2449+ 91C5 C3 49 91         JP      M2RoutineKeyOk
2450+ 91C8              MoveBlockRight:
2451+ 91C8 3A 7F 99         LD      A, (CurrentMatrixOrientation)
2452+ 91CB FE 03            CP      ORIENT_WEST
2453+ 91CD CA D8 91         JP      Z, MoveBlockRightContinue
2454+ 91D0 FE 00            CP      ORIENT_NORTH
2455+ 91D2 CA D8 91         JP      Z, MoveBlockRightContinue
2456+ 91D5 C3 92 91         JP      MoveBlockLeftContinue
2457+ 91D8              MoveBlockRightContinue:
2458+ 91D8 3E 02            LD      A, 2
2459+ 91DA 32 A8 99         LD      (BlockLeftMoving), A
2460+ 91DD CD F6 92         CALL    RemoveCurrentBlock
2461+ 91E0 3A 80 99         LD      A, (SavedY)
2462+ 91E3 57               LD      D, A
2463+ 91E4 3A 81 99         LD      A, (SavedX)           ; Increment the Y position
2464+ 91E7 5F               LD      E, A           ; Get the X position
2465+ 91E8 CD A5 8E         CALL    UpdateCurrentBlockTable
2466+ 91EB CD 53 8E         CALL    CheckBlocksCollision
2467+ 91EE FE 01            CP      1
2468+ 91F0 CA 56 91         JP      Z, M2RoutineBlockMoveDown
2469+ 91F3 AF               XOR     A
2470+ 91F4 32 A8 99         LD      (BlockLeftMoving), A
2471+ 91F7 3A 88 99         LD      A, (CurrentBlock)
2472+ 91FA 47               LD      B, A
2473+ 91FB 3A 87 99         LD      A, (CurrentBlockRotation) ; A = rotazione (0..3)
2474+ 91FE 68               LD      L, B                       ; L = ID salvato prima
2475+ 91FF CB 25            SLA     L
2476+ 9201 CB 25            SLA     L                          ; L = ID*4
2477+ 9203 85               ADD     A, L                       ; A = (ID*4) + rot
2478+ 9204 6F               LD      L, A
2479+ 9205 26 00            LD      H, 0
2480+ 9207 11 83 96         LD      DE, BLOCKS_WIDTH
2481+ 920A 19               ADD     HL, DE                      ; HL => DW con l'indirizzo giusto
2482+ 920B 46               LD      B, (HL)                     ; Current block width
2483+ 920C 3A 81 99         LD      A, (SavedX)
2484+ 920F 80               ADD     B
2485+ 9210 FE 0A            CP      10
2486+ 9212 CA 49 91         JP      Z, M2RoutineKeyOk
2487+ 9215 3A 81 99         LD      A, (SavedX)
2488+ 9218 3C               INC     A
2489+ 9219 32 81 99         LD      (SavedX), A
2490+ 921C C3 49 91         JP      M2RoutineKeyOk
2491+ 921F              BlockRotation:
2492+ 921F CD F6 92         CALL    RemoveCurrentBlock
2493+ 9222 3A 81 99         LD      A, (SavedX)
2494+ 9225                  ;CP      0
2495+ 9225                  ;JP      Z, M2RoutineKeyOk
2496+ 9225 5F               LD      E, A
2497+ 9226 3A 80 99         LD      A, (SavedY)
2498+ 9229 57               LD      D, A
2499+ 922A CD A5 8E         CALL    UpdateCurrentBlockTable
2500+ 922D CD 53 8E         CALL    CheckBlocksCollision
2501+ 9230 FE 01            CP      1
2502+ 9232 CA 56 91         JP      Z, M2RoutineBlockMoveDown
2503+ 9235 3A 87 99         LD      A,  (CurrentBlockRotation)
2504+ 9238 3C               INC     A
2505+ 9239 FE 04            CP      4
2506+ 923B 20 02            JR      NZ, BlockRotationContinue
2507+ 923D 3E 00            LD      A, 0
2508+ 923F              BlockRotationContinue:
2509+ 923F
2510+ 923F 57               LD      D, A
2511+ 9240 3A 81 99         LD      A, (SavedX)
2512+ 9243 FE 07            CP      7
2513+ 9245 D2 AD 92         JP      NC, BlockRotationIBlock
2514+ 9248 FE 08            CP      8
2515+ 924A DA 79 92         JP      C, BlockRotationContinueEnd
2516+ 924D              BlockRotationContinue1:
2517+ 924D D5               PUSH    DE
2518+ 924E 3A 88 99         LD      A, (CurrentBlock)
2519+ 9251 47               LD      B, A
2520+ 9252
2521+ 9252 7A               LD      A, D
2522+ 9253
2523+ 9253 68               LD      L, B                       ; L = ID salvato prima
2524+ 9254 CB 25            SLA     L
2525+ 9256 CB 25            SLA     L                          ; L = ID*4
2526+ 9258 85               ADD     A, L                       ; A = (ID*4) + rot
2527+ 9259 6F               LD      L, A
2528+ 925A 26 00            LD      H, 0
2529+ 925C 11 83 96         LD      DE, BLOCKS_WIDTH
2530+ 925F 19               ADD     HL, DE                      ; HL => DW con l'indirizzo giusto
2531+ 9260 46               LD      B, (HL)                     ; Current block width
2532+ 9261 3A 81 99         LD      A, (SavedX)
2533+ 9264 80               ADD     B
2534+ 9265 D1               POP     DE
2535+ 9266 FE 0D            CP      13
2536+ 9268 38 09            JR      C, BlockRotationContinue2
2537+ 926A FE 0C            CP      12
2538+ 926C 38 05            JR      C, BlockRotationContinue2
2539+ 926E FE 0C            CP      12
2540+ 9270 D2 49 91         JP      NC, M2RoutineKeyOk
2541+ 9273              BlockRotationContinue2:
2542+ 9273 3E 0A            LD      A, 10
2543+ 9275 90               SUB     B
2544+ 9276 32 81 99         LD      (SavedX), A
2545+ 9279              BlockRotationContinueEnd:
2546+ 9279 3A 87 99         LD      A, (CurrentBlockRotation)
2547+ 927C 5F               LD      E, A
2548+ 927D 7A               LD      A, D
2549+ 927E 32 87 99         LD      (CurrentBlockRotation), A
2550+ 9281 D5               PUSH    DE
2551+ 9282 3A 81 99         LD      A, (SavedX)
2552+ 9285 5F               LD      E, A
2553+ 9286 3A 80 99         LD      A, (SavedY)
2554+ 9289 57               LD      D, A
2555+ 928A 21 4C 95         LD      HL, BLOCK_3x3
2556+ 928D 22 83 99         LD      (CurrentBlockTable), HL
2557+ 9290 3A 88 99         LD      A, (CurrentBlock)
2558+ 9293 FE 00            CP      BLOCK_I
2559+ 9295 20 06            JR      NZ, BlockRotationContinueEnd1
2560+ 9297 21 5F 95         LD      HL, BLOCK_4x4
2561+ 929A 22 83 99         LD      (CurrentBlockTable), HL
2562+ 929D              BlockRotationContinueEnd1:
2563+ 929D
2564+ 929D CD 53 8E         CALL    CheckBlocksCollision
2565+ 92A0 D1               POP     DE
2566+ 92A1 FE 01            CP      1
2567+ 92A3 C2 49 91         JP      NZ, M2RoutineKeyOk
2568+ 92A6 7B               LD      A, E
2569+ 92A7 32 87 99         LD      (CurrentBlockRotation), A
2570+ 92AA C3 49 91         JP      M2RoutineKeyOk
2571+ 92AD              BlockRotationIBlock:
2572+ 92AD 3A 88 99         LD      A, (CurrentBlock)
2573+ 92B0 FE 00            CP      BLOCK_I
2574+ 92B2 20 99            JR      NZ, BlockRotationContinue1
2575+ 92B4 7A               LD      A, D
2576+ 92B5 FE 02            CP      2
2577+ 92B7 CA 4D 92         JP      Z, BlockRotationContinue1
2578+ 92BA FE 04            CP      4
2579+ 92BC CA 4D 92         JP      Z, BlockRotationContinue1
2580+ 92BF                  ;LD      A, (SavedY)
2581+ 92BF                  ;CP      16
2582+ 92BF                  ;JP      NC, BlockRotationContinueEnd
2583+ 92BF 3A 81 99         LD      A, (SavedX)
2584+ 92C2 FE 07            CP      7
2585+ 92C4 DA 4D 92         JP      C, BlockRotationContinue1
2586+ 92C7 3E 06            LD      A, 6
2587+ 92C9 32 81 99         LD      (SavedX), A
2588+ 92CC C3 4D 92         JP      BlockRotationContinue1
2589+ 92CF              MoveBlockToBottom:
2590+ 92CF 3E 01            LD      A, 1
2591+ 92D1 32 CB 99         LD      (MoveToBottomInAction), A
2592+ 92D4 3A 80 99         LD      A, (SavedY)
2593+ 92D7              MoveBlockToBottomLoop:
2594+ 92D7 FE 13            CP      19
2595+ 92D9 CA E5 92         JP      Z, MoveBlockToBottomLoopEnd
2596+ 92DC F5               PUSH    AF
2597+ 92DD CD 5D 90         CALL    MoveBlockDown
2598+ 92E0 F1               POP     AF
2599+ 92E1 3C               INC     A
2600+ 92E2 C3 D7 92         JP      MoveBlockToBottomLoop
2601+ 92E5              MoveBlockToBottomLoopEnd:
2602+ 92E5 3E 01            LD      A, 1 ; Force all matrix repaint
2603+ 92E7 32 AC 99         LD      (ForcePrintMatrixRepaintAll), A
2604+ 92EA C3 6B 91         JP      M2RoutineBlockMoveEnd
2605+ 92ED              ;--------------------------------------------------
2606+ 92ED              ; Fill M2 table
2607+ 92ED              ; INPUT: -
2608+ 92ED              ; OUTPUT: -
2609+ 92ED              ; MODIFY: AF, HL, DE, BC
2610+ 92ED              ;--------------------------------------------------
2611+ 92ED              FillM2Table:
2612+ 92ED 06 81            LD      B, 129          ; 129*2 = 258 byte, uno in piu'
2613+ 92EF              FillM2TableLoop:
2614+ 92EF 73               LD      (HL), E         ; low byte
2615+ 92F0 23               INC     HL
2616+ 92F1 72               LD      (HL), D         ; high byte
2617+ 92F2 23               INC     HL
2618+ 92F3
2619+ 92F3 10 FA            DJNZ    FillM2TableLoop
2620+ 92F5 C9               RET
2621+ 92F6              ;--------------------------------------------------
2622+ 92F6              ; Remove block from matrix (with collision check)
2623+ 92F6              ; INPUT:
2624+ 92F6              ;   A: ID del pezzo (0..6)
2625+ 92F6              ;   D: Y di posizionamento (0..19)
2626+ 92F6              ;   E: X di posizionamento (0..9)
2627+ 92F6              ; OUTPUT:
2628+ 92F6              ;   A: Collision (0=NO, 1=YES);
2629+ 92F6              ; MODIFY: AF, BC, HL
2630+ 92F6              ;--------------------------------------------------
2631+ 92F6              RemoveCurrentBlock:
2632+ 92F6 3A 88 99         LD      A, (CurrentBlock)       ; Ottieni il colore del pezzo
2633+ 92F9 47               LD      B, A                ; Salvo ID in B
2634+ 92FA 6F               LD      L, A                ; L = ID
2635+ 92FB 3A 87 99         LD      A, (CurrentBlockRotation) ; A = rotazione (0..3)
2636+ 92FE 68               LD      L, B                       ; L = ID salvato prima
2637+ 92FF CB 25            SLA     L
2638+ 9301 CB 25            SLA     L                          ; L = ID*4
2639+ 9303 85               ADD     A, L                       ; A = (ID*4) + rot
2640+ 9304 6F               LD      L, A
2641+ 9305 26 00            LD      H, 0
2642+ 9307 29               ADD     HL, HL                     ; HL *= 2 (ogni voce della tabella = 2 byte)
2643+ 9308 11 BB 96         LD      DE, BLOCKS_TABLE
2644+ 930B 19               ADD     HL, DE                     ; HL => DW con l'indirizzo giusto
2645+ 930C 5E               LD      E, (HL)
2646+ 930D 23               INC     HL
2647+ 930E 56               LD      D, (HL)
2648+ 930F EB               EX      DE, HL
2649+ 9310              RemoveCurrentBlockLoop:
2650+ 9310 7E               LD      A, (HL)
2651+ 9311 FE FF            CP      0xFF
2652+ 9313 28 1D            JR      Z, RemoveCurrentBlockDone
2653+ 9315 4F               LD      C, A        ; dy
2654+ 9316 23               INC     HL
2655+ 9317 7E               LD      A, (HL)     ; dx
2656+ 9318 23               INC     HL
2657+ 9319 47               LD      B, A
2658+ 931A E5               PUSH    HL
2659+ 931B                  ; r = SavedY + dy
2660+ 931B 3A 80 99         LD      A, (SavedY)
2661+ 931E 81               ADD     A, C
2662+ 931F 4F               LD      C, A
2663+ 9320
2664+ 9320                  ; c = SavedX + dx
2665+ 9320 3A 81 99         LD      A, (SavedX)
2666+ 9323 80               ADD     A, B
2667+ 9324 47               LD      B, A
2668+ 9325
2669+ 9325                  ; offset = r*10 + c => HL
2670+ 9325 CD 34 93         CALL    ComputeOffset
2671+ 9328 11 B7 98         LD      DE, Matrix
2672+ 932B 19               ADD     HL, DE
2673+ 932C
2674+ 932C 3E 00            LD      A, COLOR_BLACK
2675+ 932E 77               LD      (HL), A
2676+ 932F E1               POP     HL
2677+ 9330 18 DE            JR      RemoveCurrentBlockLoop
2678+ 9332
2679+ 9332              RemoveCurrentBlockDone:
2680+ 9332                  ; => Piazzato, CF=0
2681+ 9332 AF               XOR     A
2682+ 9333 C9               RET
2683+ 9334              ;--------------------------------------------------
2684+ 9334              ; Compute Place block offset
2685+ 9334              ; INPUT:
2686+ 9334              ;   B: Column
2687+ 9334              ;   C: Row
2688+ 9334              ; OUTPUT:
2689+ 9334              ;   HL: Row*10 + column
2690+ 9334              ; MODIFY: AF, BC, HL
2691+ 9334              ;--------------------------------------------------
2692+ 9334              ComputeOffset:
2693+ 9334 79                   LD   A, C
2694+ 9335 C5                   PUSH  BC
2695+ 9336 CD 3E 93             CALL MulByteBy10  ; => HL = row*10
2696+ 9339 C1                   POP  BC
2697+ 933A 78                   LD   A, B         ; col
2698+ 933B 85                   ADD  A, L         ; L += col
2699+ 933C 6F                   LD   L, A
2700+ 933D                      ; Se si generasse carry (non dovrebbe in 20x10),
2701+ 933D                      ; potrebbe influire su H, ma in Tetris reale (r<20, c<10) siamo tranquilli.
2702+ 933D C9                   RET
2703+ 933E
2704+ 933E              ;--------------------------------------------------
2705+ 933E              ; Multiply A by 10
2706+ 933E              ; INPUT:
2707+ 933E              ;   A: Value 0..255
2708+ 933E              ; OUTPUT:
2709+ 933E              ;   HL: A * 10 (16 bit)
2710+ 933E              ;   MODIFY: AF, BC, HL
2711+ 933E              ;--------------------------------------------------
2712+ 933E              MulByteBy10:
2713+ 933E 47               LD   B, A         ; salviamo in B
2714+ 933F 26 00            LD   H, 0
2715+ 9341 68               LD   L, B         ; HL = val
2716+ 9342 29               ADD  HL, HL       ; *2
2717+ 9343 29               ADD  HL, HL       ; *4
2718+ 9344 29               ADD  HL, HL       ; *8
2719+ 9345 78               LD   A, B
2720+ 9346 87               ADD  A, A         ; *2
2721+ 9347 47               LD   B, A
2722+ 9348 7D               LD   A, L
2723+ 9349 80               ADD  A, B         ; HL.low + r*2 => r*8 + r*2 = r*10
2724+ 934A 6F               LD   L, A
2725+ 934B                  ; Se ci fosse carry (r>25), potremmo toccare H, ma in Tetris r<20
2726+ 934B C9               RET
2727+ 934C
2728+ 934C              ;--------------------------------------------------
2729+ 934C              ; Randomize matrix blocks
2730+ 934C              ; INPUT: -
2731+ 934C              ; OUTPUT: -
2732+ 934C              ; MODIFY: HL, AF, BC
2733+ 934C              ;--------------------------------------------------
2734+ 934C              RandomizeMatrixBlocks:
2735+ 934C 21 DD 97         LD   HL, ZXETRISMATRIX      ; Punto iniziale della matrice
2736+ 934F 01 AF 00         LD   BC, 175        ; Contatore di byte
2737+ 9352
2738+ 9352              NextByte:
2739+ 9352 7E               LD   A, (HL)                ; Legge il valore attuale
2740+ 9353 B7               OR   A
2741+ 9354 28 10            JR   Z, SkipReplace         ; Salta se è zero
2742+ 9356
2743+ 9356                  ; Chiamata alla routine random
2744+ 9356 CD 6E 93         CALL ChooseRandomBlock      ; A = 0-6
2745+ 9359 5F               LD   E, A
2746+ 935A 16 00            LD   D, 0
2747+ 935C DD 21 8C 98      LD   IX, COLORS_TABLE
2748+ 9360 DD 19            ADD  IX, DE
2749+ 9362 DD 7E 00         LD   A, (IX)                ; A = attributo colore
2750+ 9365 77               LD   (HL), A                ; Scrive il nuovo valore nella matrice
2751+ 9366
2752+ 9366              SkipReplace:
2753+ 9366 23               INC  HL                     ; Prossimo byte
2754+ 9367 0B               DEC  BC
2755+ 9368 78               LD   A, B
2756+ 9369 B1               OR   C
2757+ 936A C2 52 93         JP   NZ, NextByte           ; Finché BC ≠ 0, continua
2758+ 936D
2759+ 936D C9               RET
2760+ 936E
2761+ 936E              ;------------------------------------------------------------------------
2762+ 936E              ; Choose random block
2763+ 936E              ; INPUT: -
2764+ 936E              ; OUTPUT:
2765+ 936E              ;   A: Block ID (0..6)
2766+ 936E              ; MODIFY: -
2767+ 936E              ;------------------------------------------------------------------------
2768+ 936E              ChooseRandomBlock:
2769+ 936E 3A 9C 99         LD      A, (Seed)
2770+ 9371 C6 11            ADD     A, 17
2771+ 9373 32 9C 99         LD      (Seed), A
2772+ 9376              ChooseRandomBlockLoop:
2773+ 9376 FE 07            CP      7                           ; confronta A con 7
2774+ 9378 38 04            JR      C, ChooseRandomBlockDone    ; se A < 7, abbiamo finito
2775+ 937A D6 07            SUB     7                           ; altrimenti sottrai 7
2776+ 937C 18 F8            JR      ChooseRandomBlockLoop       ; e ripeti
2777+ 937E
2778+ 937E              ChooseRandomBlockDone:
2779+ 937E                  ;LD      A, 0 ; RIMUOVI DOPO TEST    FP_USER
2780+ 937E                      ; Al termine A è compreso tra 0 e 6
2781+ 937E 32 B0 99         LD      (NextBlock), A       ; Salva il pezzo scelto (ora è il colore)
2782+ 9381 C9               RET
2783+ 9382              ;------------------------------------------------------------------------
2784+ 9382              ; Choose random orientation
2785+ 9382              ; INPUT:
2786+ 9382              ;   B: Max value
2787+ 9382              ; OUTPUT:
2788+ 9382              ;   A: Result
2789+ 9382              ; MODIFY: -
2790+ 9382              ;------------------------------------------------------------------------
2791+ 9382              GetRandomValue:
2792+ 9382 3A 9C 99         LD      A, (Seed)
2793+ 9385 C6 11            ADD     A, 17
2794+ 9387 32 9C 99         LD      (Seed), A
2795+ 938A              GetRandomValueLoop:
2796+ 938A B8               CP      B
2797+ 938B 38 03            JR      C, GetRandomValueDone
2798+ 938D 90               SUB     B
2799+ 938E 18 FA            JR      GetRandomValueLoop
2800+ 9390
2801+ 9390              GetRandomValueDone:
2802+ 9390 C9               RET
2803+ 9391              ;------------------------------------------------------------------------
2804+ 9391              ; Get block color
2805+ 9391              ; INPUT:
2806+ 9391              ;   A: Block ID (0..6)
2807+ 9391              ; OUTPUT:
2808+ 9391              ;   A: Block color
2809+ 9391              ; MODIFY: -
2810+ 9391              ;------------------------------------------------------------------------
2811+ 9391              GetBlockColor:
2812+ 9391 FE 00            CP      0
2813+ 9393 28 19            JR      Z, .SetBlue
2814+ 9395 FE 01            CP      1
2815+ 9397 28 18            JR      Z, .SetYellow
2816+ 9399 FE 02            CP      2
2817+ 939B 28 17            JR      Z, .SetRed
2818+ 939D FE 03            CP      3
2819+ 939F 28 16            JR      Z, .SetCyan
2820+ 93A1 FE 04            CP      4
2821+ 93A3 28 15            JR      Z, .SetMagenta
2822+ 93A5 FE 05            CP      5
2823+ 93A7 28 14            JR      Z, .SetWhite
2824+ 93A9 FE 06            CP      6
2825+ 93AB 28 13            JR      Z, .SetGreen
2826+ 93AD C9               RET
2827+ 93AE
2828+ 93AE              .SetBlue:
2829+ 93AE 3E 08            LD      A, COLOR_BLUE
2830+ 93B0 C9               RET
2831+ 93B1              .SetYellow:
2832+ 93B1 3E 30            LD      A, COLOR_YELLOW
2833+ 93B3 C9               RET
2834+ 93B4              .SetRed:
2835+ 93B4 3E 10            LD      A, COLOR_RED
2836+ 93B6 C9               RET
2837+ 93B7              .SetCyan:
2838+ 93B7 3E 28            LD      A, COLOR_CYAN
2839+ 93B9 C9               RET
2840+ 93BA              .SetMagenta:
2841+ 93BA 3E 18            LD      A, COLOR_MAGENTA
2842+ 93BC C9               RET
2843+ 93BD              .SetWhite:
2844+ 93BD 3E 38            LD      A, COLOR_WHITE
2845+ 93BF C9               RET
2846+ 93C0              .SetGreen:
2847+ 93C0 3E 20            LD      A, COLOR_GREEN
2848+ 93C2 C9               RET
2849+ 93C3
2850+ 93C3              ;------------------------------------------------------------------------
2851+ 93C3              ; Set speed by level
2852+ 93C3              ; INPUT: -
2853+ 93C3              ; OUTPUT: -
2854+ 93C3              ; MODIFY: HL, AF
2855+ 93C3              ;------------------------------------------------------------------------
2856+ 93C3              SetSpeedByLevel:
2857+ 93C3 3A A4 99         LD      A, (Level)
2858+ 93C6 FE 0A            CP      10
2859+ 93C8 C8               RET     Z
2860+ 93C9 47               LD      B, A
2861+ 93CA 3E 0A            LD      A, 10
2862+ 93CC 90               SUB     B
2863+ 93CD 32 A5 99         LD      (BlockSpeed), A
2864+ 93D0 AF               XOR     A
2865+ 93D1 32 D7 99         LD      (LevelBlocksCounter), A
2866+ 93D4 C9               RET
2867+ 93D5              ;------------------------------------------------------------------------
2868+ 93D5              ; Change matrix the orientation
2869+ 93D5              ; INPUT: -
2870+ 93D5              ; OUTPUT: -
2871+ 93D5              ; MODIFY: HL, AF
2872+ 93D5              ;------------------------------------------------------------------------
2873+ 93D5              ChangeOrientation:
2874+ 93D5 06 03            LD      B, 3
2875+ 93D7 CD 82 93         CALL    GetRandomValue
2876+ 93DA 47               LD      B, A
2877+ 93DB 3A 7F 99         LD      A, (CurrentMatrixOrientation)
2878+ 93DE B8               CP      B
2879+ 93DF C8               RET     Z
2880+ 93E0 78               LD      A, B
2881+ 93E1 32 7F 99         LD      (CurrentMatrixOrientation), A
2882+ 93E4 CD 86 8C         CALL    ShowGameField
2883+ 93E7 3E 01            LD      A, 1
2884+ 93E9 32 AC 99         LD      (ForcePrintMatrixRepaintAll), A
2885+ 93EC CD E9 8C         CALL    PrintMatrix
2886+ 93EF CD B9 85         CALL    DisplayScoreUpdate
2887+ 93F2 3A B0 99         LD      A, (NextBlock)
2888+ 93F5 CD 9F 88         CALL    UpdateNextBlockInfo
2889+ 93F8 CD 1C 88         CALL    SetNextBoxPosition
2890+ 93FB CD FC 88         CALL    ShowNextBlockOnBox
2891+ 93FE C9               RET
2892+ 93FF              ;------------------------------------------------------------------------
2893+ 93FF              ; Place block at top
2894+ 93FF              ; INPUT: -
2895+ 93FF              ; OUTPUT: -
2896+ 93FF              ; MODIFY: DE, HL, AF
2897+ 93FF              ;------------------------------------------------------------------------
2898+ 93FF              PlaceBlockAtTop:
2899+ 93FF
2900+ 93FF 3A D7 99         LD      A, (LevelBlocksCounter)
2901+ 9402 FE 05            CP      5
2902+ 9404 CC D5 93         CALL    Z, ChangeOrientation
2903+ 9407 FE 0F            CP      15
2904+ 9409 CC D5 93         CALL    Z, ChangeOrientation
2905+ 940C FE 19            CP      25
2906+ 940E CC D5 93         CALL    Z, ChangeOrientation
2907+ 9411 FE 23            CP      35
2908+ 9413 CC D5 93         CALL    Z, ChangeOrientation
2909+ 9416 FE 2D            CP      45
2910+ 9418 CC D5 93         CALL    Z, ChangeOrientation
2911+ 941B FE 37            CP      55
2912+ 941D CC D5 93         CALL    Z, ChangeOrientation
2913+ 9420 FE 41            CP      65
2914+ 9422 CC D5 93         CALL    Z, ChangeOrientation
2915+ 9425 FE 4B            CP      75
2916+ 9427 CC D5 93         CALL    Z, ChangeOrientation
2917+ 942A FE 55            CP      85
2918+ 942C CC D5 93         CALL    Z, ChangeOrientation
2919+ 942F FE 5F            CP      95
2920+ 9431 CC D5 93         CALL    Z, ChangeOrientation
2921+ 9434 AF               XOR     A
2922+ 9435 32 87 99         LD      (CurrentBlockRotation), A
2923+ 9438 32 CB 99         LD      (MoveToBottomInAction), A
2924+ 943B 21 B7 98         LD      HL, Matrix              ; Inizia dalla cima della matrice
2925+ 943E CD 7B 94         CALL    GetBlockXStartPosition  ; Ottieni la posizione iniziale del pezzo
2926+ 9441 5F               LD      E, A                    ; Riga iniziale
2927+ 9442 16 00            LD      D, 0                    ; First row
2928+ 9444 FB               EI
2929+ 9445 CD 61 8F         CALL    PlaceBlock              ; Disegna il pezzo nella matrice
2930+ 9448 F3               DI
2931+ 9449                  ;CALL    PrintMatrix             ; Mostra la matrice
2932+ 9449 AF               XOR     A                       ; A = 0
2933+ 944A 32 C4 99         LD      (ShowNextBlock), A      ; Mostra il pezzo successivo
2934+ 944D 3A D7 99         LD      A, (LevelBlocksCounter)
2935+ 9450 3C               INC     A
2936+ 9451 FE 64            CP      100                     ; Check for level up
2937+ 9453 20 16            JR      NZ, PlaceBlockAtTopEnd
2938+ 9455 3A DA 99         LD      A, (SelectedCanGrow)
2939+ 9458 FE 01            CP      1
2940+ 945A 20 0E            JR      NZ, PlaceBlockAtTopContinue
2941+ 945C 3A A4 99         LD      A, (Level)
2942+ 945F FE 0A            CP      10
2943+ 9461 28 07            JR      Z, PlaceBlockAtTopContinue
2944+ 9463 3C               INC     A
2945+ 9464 32 A4 99         LD      (Level), A
2946+ 9467 CD C3 93         CALL    SetSpeedByLevel
2947+ 946A              PlaceBlockAtTopContinue:
2948+ 946A AF               XOR     A
2949+ 946B              PlaceBlockAtTopEnd:
2950+ 946B 32 D7 99         LD      (LevelBlocksCounter), A  ; Incrementa il contatore dei pezzi
2951+ 946E CD B9 85         CALL    DisplayScoreUpdate
2952+ 9471 3A CD 99         LD      A, (PlacedBlocks)
2953+ 9474 FE 00            CP      0
2954+ 9476 C8               RET     Z
2955+ 9477 CD 29 84         CALL    BlockLandSound
2956+ 947A C9               RET
2957+ 947B              ;------------------------------------------------------------------------
2958+ 947B              ; Get new block start position
2959+ 947B              ; INPUT:
2960+ 947B              ;   A: Block ID
2961+ 947B              ; OUTPUT:
2962+ 947B              ;   A: Block start position in the matrix
2963+ 947B              ; MODIFY: -
2964+ 947B              ;------------------------------------------------------------------------
2965+ 947B              GetBlockXStartPosition:
2966+ 947B FE 00            CP      BLOCK_I
2967+ 947D CA 9F 94         JP      Z, .PosI
2968+ 9480 FE 01            CP      BLOCK_O
2969+ 9482 CA A2 94         JP      Z, .PosO
2970+ 9485 FE 03            CP      BLOCK_S
2971+ 9487 CA A8 94         JP      Z, .PosS
2972+ 948A FE 02            CP      BLOCK_T
2973+ 948C CA A5 94         JP      Z, .PosT
2974+ 948F FE 04            CP      BLOCK_Z
2975+ 9491 CA AB 94         JP      Z, .PosZ
2976+ 9494 FE 06            CP      BLOCK_J
2977+ 9496 CA AE 94         JP      Z, .PosJ
2978+ 9499 FE 05            CP      BLOCK_L
2979+ 949B CA B1 94         JP      Z, .PosL
2980+ 949E C9               RET
2981+ 949F
2982+ 949F              .PosI:
2983+ 949F 3E 03            LD      A, 3
2984+ 94A1 C9               RET
2985+ 94A2
2986+ 94A2              .PosO:
2987+ 94A2 3E 04            LD      A, 4
2988+ 94A4 C9               RET
2989+ 94A5
2990+ 94A5              .PosT:
2991+ 94A5 3E 00            LD      A, 0
2992+ 94A7 C9               RET
2993+ 94A8              .PosS:
2994+ 94A8 3E 03            LD      A, 3
2995+ 94AA C9               RET
2996+ 94AB              .PosZ:
2997+ 94AB 3E 03            LD      A, 3
2998+ 94AD C9               RET
2999+ 94AE
3000+ 94AE              .PosJ:
3001+ 94AE 3E 04            LD      A, 4
3002+ 94B0 C9               RET
3003+ 94B1
3004+ 94B1              .PosL:
3005+ 94B1 3E 04            LD      A, 4
3006+ 94B3 C9               RET
3007+ 94B4              ;------------------------------------------------------------------------
3008+ 94B4              ; Read the keyboard
3009+ 94B4              ; INPUT: -
3010+ 94B4              ; OUTPUT:
3011+ 94B4              ;   A: ASCII code of key pressed
3012+ 94B4              ; MODIFY: HL, BC, AF
3013+ 94B4              ;------------------------------------------------------------------------
3014+ 94B4              ReadKeyboard:
3015+ 94B4 21 1C 95         LD  HL,KEYBOARD_MAP     ; Point HL at the keyboard list
3016+ 94B7 16 08            LD  D, 8                ; This is the number of ports (rows) to check
3017+ 94B9 0E FE            LD  C, #FE              ; C is always FEh for reading keyboard ports
3018+ 94BB              ReadKeyboard0:
3019+ 94BB 46               LD  B, (HL)             ; Get the keyboard port address from table
3020+ 94BC 23               INC HL                  ; Increment to list of keys
3021+ 94BD ED 78            IN  A, (C)              ; Read the row of keys in
3022+ 94BF E6 1F            AND #1F                 ; We are only interested in the first five bits
3023+ 94C1 1E 05            LD  E, 5                ; This is the number of keys in the row
3024+ 94C3              ReadKeyboard1:
3025+ 94C3 CB 3F            SRL A                   ; Shift A right; bit 0 sets carry bit
3026+ 94C5 30 0C            JR  NC, ReadKeyboard2   ; If the bit is 0, we've found our key
3027+ 94C7 23               INC HL                  ; Go to next table address
3028+ 94C8 1D               DEC E                   ; Decrement key loop counter
3029+ 94C9 20 F8            JR  NZ, ReadKeyboard1   ; Loop around until this row finished
3030+ 94CB 15               DEC D                   ; Decrement row loop counter
3031+ 94CC 20 ED            JR  NZ, ReadKeyboard0   ; Loop around until we are done
3032+ 94CE A7               AND A                   ; Clear A (no key found)
3033+ 94CF 32 AA 99         LD  (LastKeyPressed), A
3034+ 94D2 C9               RET
3035+ 94D3              ReadKeyboard2:
3036+ 94D3 7E               LD  A, (HL)             ; We've found a key at this point; fetch the character code!
3037+ 94D4 47               LD  B, A
3038+ 94D5 3A AA 99         LD  A,(LastKeyPressed)
3039+ 94D8 FE 00            CP  0
3040+ 94DA 28 05            JR  Z, ReadKeyboard3    ; If no key pressed before, skip the check
3041+ 94DC B8               CP  B                   ; Check if the key is the same as the last one pressed
3042+ 94DD 20 02            JR  NZ, ReadKeyboard3    ; If it is, skip the rest of this routine
3043+ 94DF AF               XOR A               ; If it is the same, clear A (no key found)
3044+ 94E0 C9               RET
3045+ 94E1              ReadKeyboard3:
3046+ 94E1 78               LD  A, B
3047+ 94E2 32 AA 99         LD  (LastKeyPressed), A
3048+ 94E5 32 AB 99         LD  (KeyPressed), A
3049+ 94E8 C9               RET
3050+ 94E9              ;--------------------------------------------------
3051+ 94E9              ; Check and mark completed rows
3052+ 94E9              ; INPUT: -
3053+ 94E9              ; OUTPUT: -
3054+ 94E9              ; MODIFY: AF, BC, DE, HL
3055+ 94E9              ;--------------------------------------------------
3056+ 94E9              CheckAndMarkCompletedRows:
3057+ 94E9 AF               XOR     A                ; A = 0 (nessuna riga completata)
3058+ 94EA 32 AD 99         LD      (CompletedRows), A
3059+ 94ED 21 B7 98         LD      HL, Matrix          ; HL punta all'inizio della matrice
3060+ 94F0 06 14            LD      B, 20               ; Contatore righe (20 righe)
3061+ 94F2              CheckRowLoop:
3062+ 94F2 E5               PUSH    HL                  ; Salva HL per ripristinarlo dopo
3063+ 94F3 0E 0A            LD      C, 10               ; Contatore colonne (10 colonne)
3064+ 94F5 3E 00            LD      A, 0                ; Flag per riga completata (A=0: completata, A!=0: non completata)
3065+ 94F7              CheckColumnLoop:
3066+ 94F7 56               LD      D, (HL)             ; Legge il byte corrente
3067+ 94F8 BA               CP      D                   ; Confronta con 0
3068+ 94F9 28 18            JR      Z, RowNotCompleted  ; Se un byte è 0, la riga non è completata
3069+ 94FB 23               INC     HL                  ; Passa al prossimo byte
3070+ 94FC 0D               DEC     C                   ; Decrementa il contatore colonne
3071+ 94FD 20 F8            JR      NZ, CheckColumnLoop ; Continua a controllare la riga
3072+ 94FF                  ; Se tutte le colonne sono diverse da 0, marca la riga come completata
3073+ 94FF E1               POP     HL                  ; Ripristina HL all'inizio della riga
3074+ 9500 0E 0A            LD      C, 10               ; Reset contatore colonne
3075+ 9502 3E FF            LD      A, 0XFF ; Valore per riga completata
3076+ 9504              MarkRowCompleted:
3077+ 9504 77               LD      (HL), A             ; Imposta il byte corrente a CHAR_ROW_COMPLETED
3078+ 9505 23               INC     HL                  ; Passa al prossimo byte
3079+ 9506 0D               DEC     C                   ; Decrementa il contatore colonne
3080+ 9507 20 FB            JR      NZ, MarkRowCompleted ; Continua a marcare la riga
3081+ 9509 3A AD 99         LD      A, (CompletedRows)     ; A = valore corrente di CompletedRows
3082+ 950C C6 01            ADD     1                   ; Incrementa il contatore righe completate
3083+ 950E 32 AD 99         LD      (CompletedRows), A  ; Marca la riga come completata
3084+ 9511 18 05            JR      NextTitleRow             ; Passa alla riga successiva
3085+ 9513              RowNotCompleted:
3086+ 9513 E1               POP     HL                  ; Ripristina HL all'inizio della riga
3087+ 9514 11 0A 00         LD      DE, 10              ; DE = 10 (numero di colonne per riga)
3088+ 9517 19               ADD     HL, DE              ; HL = HL + DE (salta alla prossima riga)
3089+ 9518              NextTitleRow:
3090+ 9518 05               DEC     B                   ; Decrementa il contatore righe
3091+ 9519 20 D7            JR      NZ, CheckRowLoop    ; Continua a controllare le righe
3092+ 951B C9               RET                         ; Fine della subroutine
3093+ 951C              ;----------------------------------------------------------------------
3094+ 951C              ;  Constants
3095+ 951C              ;----------------------------------------------------------------------
3096+ 951C              MATRIX       EQU 8000h         ; Indirizzo base dell’area 20x10 (200 bytes)
3097+ 951C              ROWS         EQU 20
3098+ 951C              COLS         EQU 10
3099+ 951C              SIZE         EQU ROWS * COLS    ; 200
3100+ 951C FE 23 5A 58  KEYBOARD_MAP:                   db #FE,"#","Z","X","C","V"
3100+ 9520 43 56
3101+ 9522 FD 41 53 44                                  db #FD,"A","S","D","F","G"
3101+ 9526 46 47
3102+ 9528 FB 51 57 45                                  db #FB,"Q","W","E","R","T"
3102+ 952C 52 54
3103+ 952E F7 31 32 33                                  db #F7,"1","2","3","4","5"
3103+ 9532 34 35
3104+ 9534 EF 30 39 38                                  db #EF,"0","9","8","7","6"
3104+ 9538 37 36
3105+ 953A DF 50 4F 49                                  db #DF,"P","O","I","U","Y"
3105+ 953E 55 59
3106+ 9540 BF 23 4C 4B                                  db #BF,"#","L","K","J","H"
3106+ 9544 4A 48
3107+ 9546 7F 20 23 4D                                  db #7F," ","#","M","N","B"
3107+ 954A 4E 42
3108+ 954C              BLOCK_T:        EQU 2
3109+ 954C              BLOCK_I:        EQU 0
3110+ 954C              BLOCK_O:        EQU 1
3111+ 954C              BLOCK_S:        EQU 3
3112+ 954C              BLOCK_Z:        EQU 4
3113+ 954C              BLOCK_L:        EQU 5
3114+ 954C              BLOCK_J:        EQU 6
3115+ 954C
3116+ 954C              ORIENT_NORTH:   EQU 0   ; Matrix as is (20 high, 10 wide)
3117+ 954C              ORIENT_SOUTH:   EQU 1   ; Upside down (20 high, 10 wide)
3118+ 954C              ORIENT_EAST:    EQU 2   ; Rotated 90° right (10 high, 20 wide)
3119+ 954C              ORIENT_WEST:    EQU 3   ; Rotated 90° left  (10 high, 20 wide)
3120+ 954C              BLOCK_3x3:
3121+ 954C 00 00            DEFB    0,0
3122+ 954E 00 01            DEFB    0,1
3123+ 9550 00 02            DEFB    0,2
3124+ 9552 01 00            DEFB    1,0
3125+ 9554 01 01            DEFB    1,1
3126+ 9556 01 02            DEFB    1,2
3127+ 9558 02 00            DEFB    2,0
3128+ 955A 02 01            DEFB    2,1
3129+ 955C 02 02            DEFB    2,2
3130+ 955E FF               DEFB    0xFF
3131+ 955F              BLOCK_4x4:
3132+ 955F 00 00            DEFB    0,0
3133+ 9561 00 01            DEFB    0,1
3134+ 9563 00 02            DEFB    0,2
3135+ 9565 00 03            DEFB    0,3
3136+ 9567 01 00            DEFB    1,0
3137+ 9569 01 01            DEFB    1,1
3138+ 956B 01 02            DEFB    1,2
3139+ 956D 01 03            DEFB    1,3
3140+ 956F 02 00            DEFB    2,0
3141+ 9571 02 01            DEFB    2,1
3142+ 9573 02 02            DEFB    2,2
3143+ 9575 02 03            DEFB    2,3
3144+ 9577 03 00            DEFB    3,0
3145+ 9579 03 01            DEFB    3,1
3146+ 957B 03 02            DEFB    3,2
3147+ 957D 03 03            DEFB    3,3
3148+ 957F FF               DEFB    0xFF
3149+ 9580              BLOCK_I_DEF_0:
3150+ 9580 00 00            DEFB    0, 0
3151+ 9582 00 01            DEFB    0, 1
3152+ 9584 00 02            DEFB    0, 2
3153+ 9586 00 03            DEFB    0, 3
3154+ 9588 FF               DEFB    0xFF
3155+ 9589              BLOCK_I_DEF_90:
3156+ 9589 00 00            DEFB    0,0
3157+ 958B 01 00            DEFB    1,0
3158+ 958D 02 00            DEFB    2,0
3159+ 958F 03 00            DEFB    3,0
3160+ 9591 FF               DEFB    0xFF
3161+ 9592              BLOCK_I_DEF_180:
3162+ 9592 00 00            DEFB    0,0
3163+ 9594 00 01            DEFB    0,1
3164+ 9596 00 02            DEFB    0,2
3165+ 9598 00 03            DEFB    0,3
3166+ 959A FF               DEFB    0xFF
3167+ 959B              BLOCK_I_DEF_270:
3168+ 959B 00 00            DEFB    0,0
3169+ 959D 01 00            DEFB    1,0
3170+ 959F 02 00            DEFB    2,0
3171+ 95A1 03 00            DEFB    3,0
3172+ 95A3 FF               DEFB    0xFF
3173+ 95A4              BLOCK_O_DEF_0:
3174+ 95A4 00 00            DEFB    0,0
3175+ 95A6 00 01            DEFB    0,1
3176+ 95A8 01 00            DEFB    1,0
3177+ 95AA 01 01            DEFB    1,1
3178+ 95AC FF               DEFB    0xFF
3179+ 95AD              BLOCK_O_DEF_90:
3180+ 95AD 00 00            DEFB    0,0
3181+ 95AF 00 01            DEFB    0,1
3182+ 95B1 01 00            DEFB    1,0
3183+ 95B3 01 01            DEFB    1,1
3184+ 95B5 FF               DEFB    0xFF
3185+ 95B6              BLOCK_O_DEF_180:
3186+ 95B6 00 00            DEFB    0,0
3187+ 95B8 00 01            DEFB    0,1
3188+ 95BA 01 00            DEFB    1,0
3189+ 95BC 01 01            DEFB    1,1
3190+ 95BE FF               DEFB    0xFF
3191+ 95BF              BLOCK_O_DEF_270:
3192+ 95BF 00 00            DEFB    0,0
3193+ 95C1 00 01            DEFB    0,1
3194+ 95C3 01 00            DEFB    1,0
3195+ 95C5 01 01            DEFB    1,1
3196+ 95C7 FF               DEFB    0xFF
3197+ 95C8              BLOCK_T_DEF_0:
3198+ 95C8 00 00            DEFB    0, 0
3199+ 95CA 00 01            DEFB    0, 1
3200+ 95CC 00 02            DEFB    0, 2
3201+ 95CE 01 01            DEFB    1, 1
3202+ 95D0 FF               DEFB    0xFF
3203+ 95D1              BLOCK_T_DEF_90:
3204+ 95D1 00 01            DEFB    0,1
3205+ 95D3 01 00            DEFB    1,0
3206+ 95D5 01 01            DEFB    1,1
3207+ 95D7 02 01            DEFB    2,1
3208+ 95D9 FF               DEFB    0xFF
3209+ 95DA              BLOCK_T_DEF_180:
3210+ 95DA 00 01            DEFB    0,1
3211+ 95DC 01 00            DEFB    1,0
3212+ 95DE 01 01            DEFB    1,1
3213+ 95E0 01 02            DEFB    1,2
3214+ 95E2 FF               DEFB    0xFF
3215+ 95E3              BLOCK_T_DEF_270:
3216+ 95E3 00 00            DEFB    0,0
3217+ 95E5 01 00            DEFB    1,0
3218+ 95E7 01 01            DEFB    1,1
3219+ 95E9 02 00            DEFB    2,0
3220+ 95EB FF               DEFB    0xFF
3221+ 95EC              BLOCK_S_DEF_0:
3222+ 95EC 00 01            DEFB    0, 1
3223+ 95EE 00 02            DEFB    0, 2
3224+ 95F0 01 00            DEFB    1, 0
3225+ 95F2 01 01            DEFB    1, 1
3226+ 95F4 FF               DEFB    0xFF
3227+ 95F5              BLOCK_S_DEF_90:
3228+ 95F5 00 00            DEFB    0,0
3229+ 95F7 01 00            DEFB    1,0
3230+ 95F9 01 01            DEFB    1,1
3231+ 95FB 02 01            DEFB    2,1
3232+ 95FD FF               DEFB    0xFF
3233+ 95FE              BLOCK_S_DEF_180:
3234+ 95FE 00 01            DEFB    0,1
3235+ 9600 00 02            DEFB    0,2
3236+ 9602 01 00            DEFB    1,0
3237+ 9604 01 01            DEFB    1,1
3238+ 9606 FF               DEFB    0xFF
3239+ 9607              BLOCK_S_DEF_270:
3240+ 9607 00 00            DEFB    0,0
3241+ 9609 01 00            DEFB    1,0
3242+ 960B 01 01            DEFB    1,1
3243+ 960D 02 01            DEFB    2,1
3244+ 960F FF               DEFB    0xFF
3245+ 9610              BLOCK_Z_DEF_0:
3246+ 9610 00 00            DEFB    0, 0
3247+ 9612 00 01            DEFB    0, 1
3248+ 9614 01 01            DEFB    1, 1
3249+ 9616 01 02            DEFB    1, 2
3250+ 9618 FF               DEFB    0xFF
3251+ 9619              BLOCK_Z_DEF_90:
3252+ 9619 00 01            DEFB    0,1
3253+ 961B 01 00            DEFB    1,0
3254+ 961D 01 01            DEFB    1,1
3255+ 961F 02 00            DEFB    2,0
3256+ 9621 FF               DEFB    0xFF
3257+ 9622              BLOCK_Z_DEF_180:
3258+ 9622 00 00            DEFB    0,0
3259+ 9624 00 01            DEFB    0,1
3260+ 9626 01 01            DEFB    1,1
3261+ 9628 01 02            DEFB    1,2
3262+ 962A FF               DEFB    0xFF
3263+ 962B              BLOCK_Z_DEF_270:
3264+ 962B 00 01            DEFB    0,1
3265+ 962D 01 00            DEFB    1,0
3266+ 962F 01 01            DEFB    1,1
3267+ 9631 02 00            DEFB    2,0
3268+ 9633 FF               DEFB    0xFF
3269+ 9634              BLOCK_J_DEF_0:
3270+ 9634 00 00            DEFB    0, 0
3271+ 9636 00 01            DEFB    0, 1
3272+ 9638 00 02            DEFB    0, 2
3273+ 963A 01 00            DEFB    1, 0
3274+ 963C FF               DEFB    0xFF
3275+ 963D              BLOCK_J_DEF_90:
3276+ 963D 00 00            DEFB    0,0
3277+ 963F 00 01            DEFB    0,1
3278+ 9641 01 01            DEFB    1,1
3279+ 9643 02 01            DEFB    2,1
3280+ 9645 FF               DEFB    0xFF
3281+ 9646              BLOCK_J_DEF_180:
3282+ 9646 00 02            DEFB    0,2
3283+ 9648 01 00            DEFB    1,0
3284+ 964A 01 01            DEFB    1,1
3285+ 964C 01 02            DEFB    1,2
3286+ 964E FF               DEFB    0xFF
3287+ 964F              BLOCK_J_DEF_270:
3288+ 964F 00 00            DEFB    0,0
3289+ 9651 01 00            DEFB    1,0
3290+ 9653 02 00            DEFB    2,0
3291+ 9655 02 01            DEFB    2,1
3292+ 9657 FF               DEFB    0xFF
3293+ 9658              BLOCK_L_DEF_0:
3294+ 9658 00 00            DEFB    0, 0
3295+ 965A 00 01            DEFB    0, 1
3296+ 965C 00 02            DEFB    0, 2
3297+ 965E 01 02            DEFB    1, 2
3298+ 9660 FF               DEFB    0xFF
3299+ 9661              BLOCK_L_DEF_90:
3300+ 9661 00 01            DEFB    0,1
3301+ 9663 01 01            DEFB    1,1
3302+ 9665 02 00            DEFB    2,0
3303+ 9667 02 01            DEFB    2,1
3304+ 9669 FF               DEFB    0xFF
3305+ 966A              BLOCK_L_DEF_180:
3306+ 966A 00 00            DEFB    0,0
3307+ 966C 01 00            DEFB    1,0
3308+ 966E 01 01            DEFB    1,1
3309+ 9670 01 02            DEFB    1,2
3310+ 9672 FF               DEFB    0xFF
3311+ 9673              BLOCK_L_DEF_270:
3312+ 9673 00 00            DEFB    0,0
3313+ 9675 00 01            DEFB    0,1
3314+ 9677 01 00            DEFB    1,0
3315+ 9679 02 00            DEFB    2,0
3316+ 967B FF               DEFB    0xFF
3317+ 967C              BLOCK_COLORS:
3318+ 967C 08               DEFB    COLOR_BLUE      ; ID=0
3319+ 967D 30               DEFB    COLOR_YELLOW    ; ID=1
3320+ 967E 28               DEFB    COLOR_CYAN      ; ID=2
3321+ 967F 20               DEFB    COLOR_GREEN     ; ID=3
3322+ 9680 10               DEFB    COLOR_RED       ; ID=4
3323+ 9681 18               DEFB    COLOR_MAGENTA   ; ID=5
3324+ 9682 38               DEFB    COLOR_WHITE     ; ID=6
3325+ 9683
3326+ 9683              BLOCKS_WIDTH:
3327+ 9683 04               DB  4           ; Block I - 0 Degrees
3328+ 9684 01               DB  1           ; Block I - 90 Degrees
3329+ 9685 04               DB  4           ; Block I - 180 Degrees
3330+ 9686 01               DB  1           ; Block I - 270 Degrees
3331+ 9687 02               DB  2           ; Block O - 0 Degrees
3332+ 9688 02               DB  2           ; Block O - 90 Degrees
3333+ 9689 02               DB  2           ; Block O - 180 Degrees
3334+ 968A 02               DB  2           ; Block O - 270 Degrees
3335+ 968B 03               DB  3           ; Block T - 0 Degrees
3336+ 968C 02               DB  2           ; Block T - 90 Degrees
3337+ 968D 03               DB  3           ; Block T - 180 Degrees
3338+ 968E 02               DB  2           ; Block T - 270 Degrees
3339+ 968F 03               DB  3           ; Block S - 0 Degrees
3340+ 9690 02               DB  2           ; Block S - 90 Degrees
3341+ 9691 03               DB  3           ; Block S - 180 Degrees
3342+ 9692 02               DB  2           ; Block S - 270 Degrees
3343+ 9693 03               DB  3           ; Block Z - 0 Degrees
3344+ 9694 02               DB  2           ; Block Z - 90 Degrees
3345+ 9695 03               DB  3           ; Block Z - 180 Degrees
3346+ 9696 02               DB  2           ; Block Z - 270 Degrees
3347+ 9697 03               DB  3           ; Block J - 0 Degrees
3348+ 9698 02               DB  2           ; Block J - 90 Degrees
3349+ 9699 03               DB  3           ; Block J - 180 Degrees
3350+ 969A 02               DB  2           ; Block J - 270 Degrees
3351+ 969B 03               DB  3           ; Block L - 0 Degrees
3352+ 969C 02               DB  2           ; Block L - 90 Degrees
3353+ 969D 03               DB  3           ; Block L - 180 Degrees
3354+ 969E 02               DB  2           ; Block L - 270 Degrees
3355+ 969F              BLOCKS_HEIGHT:
3356+ 969F 01               DB  1           ; Block I - 0 Degrees
3357+ 96A0 04               DB  4           ; Block I - 90 Degrees
3358+ 96A1 01               DB  1           ; Block I - 180 Degrees
3359+ 96A2 04               DB  4           ; Block I - 270 Degrees
3360+ 96A3 02               DB  2           ; Block O - 0 Degrees
3361+ 96A4 02               DB  2           ; Block O - 90 Degrees
3362+ 96A5 02               DB  2           ; Block O - 180 Degrees
3363+ 96A6 02               DB  2           ; Block O - 270 Degrees
3364+ 96A7 02               DB  2           ; Block T - 0 Degrees
3365+ 96A8 03               DB  3           ; Block T - 90 Degrees
3366+ 96A9 02               DB  2           ; Block T - 180 Degrees
3367+ 96AA 03               DB  3           ; Block T - 270 Degrees
3368+ 96AB 02               DB  2           ; Block S - 0 Degrees
3369+ 96AC 03               DB  3           ; Block S - 90 Degrees
3370+ 96AD 02               DB  2           ; Block S - 180 Degrees
3371+ 96AE 03               DB  3           ; Block S - 270 Degrees
3372+ 96AF 02               DB  2           ; Block Z - 0 Degrees
3373+ 96B0 03               DB  3           ; Block Z - 90 Degrees
3374+ 96B1 02               DB  2           ; Block Z - 180 Degrees
3375+ 96B2 03               DB  3           ; Block Z - 270 Degrees
3376+ 96B3 02               DB  2           ; Block J - 0 Degrees
3377+ 96B4 03               DB  3           ; Block J - 90 Degrees
3378+ 96B5 02               DB  2           ; Block J - 180 Degrees
3379+ 96B6 03               DB  3           ; Block J - 270 Degrees
3380+ 96B7 02               DB  2           ; Block L - 0 Degrees
3381+ 96B8 03               DB  3           ; Block L - 90 Degrees
3382+ 96B9 02               DB  2           ; Block L - 180 Degrees
3383+ 96BA 03               DB  3           ; Block L - 270 Degrees
3384+ 96BB              BLOCKS_TABLE:
3385+ 96BB                      ; ID=0 => pezzo I
3386+ 96BB 80 95            DW      BLOCK_I_DEF_0
3387+ 96BD 89 95            DW      BLOCK_I_DEF_90
3388+ 96BF 92 95            DW      BLOCK_I_DEF_180
3389+ 96C1 9B 95            DW      BLOCK_I_DEF_270
3390+ 96C3
3391+ 96C3                  ; ID=1 => pezzo O
3392+ 96C3 A4 95            DW      BLOCK_O_DEF_0
3393+ 96C5 AD 95            DW      BLOCK_O_DEF_90
3394+ 96C7 B6 95            DW      BLOCK_O_DEF_180
3395+ 96C9 BF 95            DW      BLOCK_O_DEF_270
3396+ 96CB
3397+ 96CB                  ; ID=2 => pezzo T
3398+ 96CB C8 95            DW      BLOCK_T_DEF_0
3399+ 96CD D1 95            DW      BLOCK_T_DEF_90
3400+ 96CF DA 95            DW      BLOCK_T_DEF_180
3401+ 96D1 E3 95            DW      BLOCK_T_DEF_270
3402+ 96D3
3403+ 96D3                  ; ID=3 => pezzo S
3404+ 96D3 EC 95            DW      BLOCK_S_DEF_0
3405+ 96D5 F5 95            DW      BLOCK_S_DEF_90
3406+ 96D7 FE 95            DW      BLOCK_S_DEF_180
3407+ 96D9 07 96            DW      BLOCK_S_DEF_270
3408+ 96DB
3409+ 96DB                  ; ID=4 => pezzo Z
3410+ 96DB 10 96            DW      BLOCK_Z_DEF_0
3411+ 96DD 19 96            DW      BLOCK_Z_DEF_90
3412+ 96DF 22 96            DW      BLOCK_Z_DEF_180
3413+ 96E1 2B 96            DW      BLOCK_Z_DEF_270
3414+ 96E3
3415+ 96E3                  ; ID=5 => pezzo J
3416+ 96E3 34 96            DW      BLOCK_J_DEF_0
3417+ 96E5 3D 96            DW      BLOCK_J_DEF_90
3418+ 96E7 46 96            DW      BLOCK_J_DEF_180
3419+ 96E9 4F 96            DW      BLOCK_J_DEF_270
3420+ 96EB
3421+ 96EB                  ; ID=6 => pezzo L
3422+ 96EB 58 96            DW      BLOCK_L_DEF_0
3423+ 96ED 61 96            DW      BLOCK_L_DEF_90
3424+ 96EF 6A 96            DW      BLOCK_L_DEF_180
3425+ 96F1 73 96            DW      BLOCK_L_DEF_270
3426+ 96F3              CHAR_ROW_COMPLETED:
3427+ 96F3 FF               DB 0xFF
3428+ 96F4              TEXT_EMPTY5:
3429+ 96F4 20 20 20 20      DB "     ",0
3429+ 96F8 20 00
3430+ 96FA              TEXT_SCORE:
3431+ 96FA 53 43 4F 52      DB "SCORE",0
3431+ 96FE 45 00
3432+ 9700              TEXT_HIGH_SCORE_1:
3433+ 9700 48 49 47 48      DB "HIGH ",0
3433+ 9704 20 00
3434+ 9706              TEXT_HIGH_SCORE_2:
3435+ 9706 53 43 4F 52      DB "SCORE",0
3435+ 970A 45 00
3436+ 970C              TEXT_LEVEL:
3437+ 970C 4C 45 56 45      DB "LEVEL",0
3437+ 9710 4C 00
3438+ 9712              TEXT_GAME_OVER_1:
3439+ 9712 20 20 20 20      DB "          ",0
3439+ 9716 20 20 20 20
3439+ 971A 20 20 00
3440+ 971D              TEXT_GAME_OVER_2:
3441+ 971D 20 20 20 47      DB "   GAME   ",0
3441+ 9721 41 4D 45 20
3441+ 9725 20 20 00
3442+ 9728
3443+ 9728              TEXT_GAME_OVER_3:
3444+ 9728 20 20 20 4F      DB "   OVER   ",0
3444+ 972C 56 45 52 20
3444+ 9730 20 20 00
3445+ 9733
3446+ 9733              TEXT_BLOCKS:
3447+ 9733 42 4C 4B 53      DB "BLKS ",0
3447+ 9737 20 00
3448+ 9739              TEXT_MAX_BLOCKS:
3449+ 9739 4D 41 58 20      DB "MAX  ",0
3449+ 973D 20 00
3450+ 973F              TEXT_START_LEVEL:
3451+ 973F 53 54 41 52      DB "START LEVEL",0
3451+ 9743 54 20 4C 45
3451+ 9747 56 45 4C 00
3452+ 974B              TEXT_ORIENTATION:
3453+ 974B 44 49 52 45      DB "DIRECTION",0
3453+ 974F 43 54 49 4F
3453+ 9753 4E 00
3454+ 9755              TEXT_LEVEL_GROWING:
3455+ 9755 4C 45 56 45      DB "LEVEL GROWING",0
3455+ 9759 4C 20 47 52
3455+ 975D 4F 57 49 4E
3455+ 9761 47 00
3456+ 9763              TEXT_YES:
3457+ 9763 59 45 53 00      DB "YES",0
3458+ 9767              TEXT_NO:
3459+ 9767 20 4E 4F 00      DB " NO",0
3460+ 976B              TEXT_NORTH:
3461+ 976B 4E 4F 52 54      DB "NORTH",0
3461+ 976F 48 00
3462+ 9771              TEXT_SOUTH:
3463+ 9771 53 4F 55 54      DB "SOUTH",0
3463+ 9775 48 00
3464+ 9777              TEXT_EAST:
3465+ 9777 20 45 41 53      DB " EAST",0
3465+ 977B 54 00
3466+ 977D              TEXT_WEST:
3467+ 977D 20 57 45 53      DB " WEST",0
3467+ 9781 54 00
3468+ 9783              TEXT_CHAOS:
3469+ 9783 43 48 41 4F       DB "CHAOS",0
3469+ 9787 53 00
3470+ 9789              TEXT_SPACE:
3471+ 9789 20 00             DB " ",0
3472+ 978B              TEXT_COPYRIGHT:
3473+ 978B 32 30 32 35      DB "2025 FAUSTO PRACEK",0
3473+ 978F 20 46 41 55
3473+ 9793 53 54 4F 20
3473+ 9797 50 52 41 43
3473+ 979B 45 4B 00
3474+ 979E              TEXT_COMMANDS:
3475+ 979E 34 3D 4C 45      DB "4=LEFT  5=ROTATE  6=RIGHT",0
3475+ 97A2 46 54 20 20
3475+ 97A6 35 3D 52 4F
3475+ 97AA 54 41 54 45
3475+ 97AE 20 20 36 3D
3475+ 97B2 52 49 47 48
3475+ 97B6 54 00
3476+ 97B8              TEXT_COMMANDS_SPACE:
3477+ 97B8 53 50 41 43      DB "SPACE=PULL DOWN",0
3477+ 97BC 45 3D 50 55
3477+ 97C0 4C 4C 20 44
3477+ 97C4 4F 57 4E 00
3478+ 97C8              TEXT_COMMANDS_SPACE_TO_START:
3479+ 97C8 50 52 45 53      DB "PRESS SPACE TO START",0
3479+ 97CC 53 20 53 50
3479+ 97D0 41 43 45 20
3479+ 97D4 54 4F 20 53
3479+ 97D8 54 41 52 54
3479+ 97DC 00
3480+ 97DD              ZXETRISMATRIX:
3481+ 97DD FF FF FF 00      DEFB 255, 255, 255, 0,   255, 0,   255, 0,   255, 255, 255, 0,   255, 255, 255, 0,   255, 255, 255, 0,   255, 0,   255, 255, 255
3481+ 97E1 FF 00 FF 00
3481+ 97E5 FF FF FF 00
3481+ 97E9 FF FF FF 00
3481+ 97ED FF FF FF 00
3481+ 97F1 FF 00 FF FF
3481+ 97F5 FF
3482+ 97F6 00 00 FF 00      DEFB   0,   0, 255, 0,   255, 0,   255, 0,   255,   0,   0,   0,     0, 255,   0,   0,   255,   0,   255,   0,   255,   0,   255,   0,   0
3482+ 97FA FF 00 FF 00
3482+ 97FE FF 00 00 00
3482+ 9802 00 FF 00 00
3482+ 9806 FF 00 FF 00
3482+ 980A FF 00 FF 00
3482+ 980E 00
3483+ 980F 00 00 FF 00      DEFB   0,   0, 255, 0,   255, 0,   255, 0,   255,   0,   0,   0,     0, 255,   0,   0,   255,   0,   255,   0,   255,   0,   255,   0,   0
3483+ 9813 FF 00 FF 00
3483+ 9817 FF 00 00 00
3483+ 981B 00 FF 00 00
3483+ 981F FF 00 FF 00
3483+ 9823 FF 00 FF 00
3483+ 9827 00
3484+ 9828 00 FF 00 00      DEFB   0, 255,   0,   0,   0, 255,   0,   0,   255, 255,   0,   0,     0, 255,   0,   0,   255, 255, 255,   0,   255,   0,   0,   255,   0
3484+ 982C 00 FF 00 00
3484+ 9830 FF FF 00 00
3484+ 9834 00 FF 00 00
3484+ 9838 FF FF FF 00
3484+ 983C FF 00 00 FF
3484+ 9840 00
3485+ 9841 FF 00 00 00      DEFB 255,   0,   0,   0, 255,   0, 255,   0,   255,   0,   0,   0,     0, 255,   0,   0,   255, 255,   0,   0,   255,   0,   0,   0, 255
3485+ 9845 FF 00 FF 00
3485+ 9849 FF 00 00 00
3485+ 984D 00 FF 00 00
3485+ 9851 FF FF 00 00
3485+ 9855 FF 00 00 00
3485+ 9859 FF
3486+ 985A FF 00 00 00      DEFB 255,   0,   0,   0, 255,   0, 255,   0,   255,   0,   0,   0,     0, 255,   0,   0,   255,   0,   255,   0,   255,   0,   0,   0, 255
3486+ 985E FF 00 FF 00
3486+ 9862 FF 00 00 00
3486+ 9866 00 FF 00 00
3486+ 986A FF 00 FF 00
3486+ 986E FF 00 00 00
3486+ 9872 FF
3487+ 9873 FF FF FF 00      DEFB 255, 255, 255, 0,   255, 0,   255, 0,   255, 255, 255, 0,     0, 255,   0,   0,   255,   0,   255,   0,   255,   0,   255, 255, 255
3487+ 9877 FF 00 FF 00
3487+ 987B FF FF FF 00
3487+ 987F 00 FF 00 00
3487+ 9883 FF 00 FF 00
3487+ 9887 FF 00 FF FF
3487+ 988B FF
3488+ 988C              COLORS_TABLE:
3489+ 988C 08               DEFB COLOR_BLUE
3490+ 988D 30               DEFB COLOR_YELLOW
3491+ 988E 28               DEFB COLOR_CYAN
3492+ 988F 20               DEFB COLOR_GREEN
3493+ 9890 10               DEFB COLOR_RED
3494+ 9891 18               DEFB COLOR_MAGENTA
3495+ 9892 38               DEFB COLOR_WHITE
3496+ 9893              InGameTuneData:
3497+ 9893 1B 24 22 1E      DB 0x1B,0x24,0x22,0x1E,0x22,0x24,0x28,0x28    ; E5, B4, C5, D5, C5, B4, A4, A4
3497+ 9897 22 24 28 28
3498+ 989B 22 1B 1E 22      DB 0x22,0x1B,0x1E,0x22,0x24,0x22,0x1E,0x1B    ; C5, E5, D5, C5, B4, C5, D5, E5
3498+ 989F 24 22 1E 1B
3499+ 98A3 1B 22 28 24      DB 0x1B,0x22,0x28,0x24,0x22,0x24,0x22,0x1E    ; E5, C5, A4, A4, C5, E5, D5, C5
3499+ 98A7 22 24 22 1E
3500+ 98AB 24 22 1B 1B      DB 0x24,0x22,0x1B,0x1B,0x22,0x1B,0x22,0x24    ; B4, C5, D5, E5, C5, A4, A4, C5
3500+ 98AF 22 1B 22 24
3501+ 98B3 22 1E 1B 1B      DB 0x22,0x1E,0x1B,0x1B                        ; E5, C5, A4, A4  (chiusura/frase finale)
3502+ 98B7
3503+ 98B7              ;----------------------------------------------------------------------
3504+ 98B7              ;  Variabili
3505+ 98B7              ;----------------------------------------------------------------------
3506+ 98B7              Matrix:
3507+ 98B7 00 00 00...      DEFS 200 ; 200 bytes for the game matrix (20x10)
3508+ 997F              CurrentMatrixOrientation:
3509+ 997F 00               DEFB ORIENT_NORTH
3510+ 9980              SavedY:
3511+ 9980 00               DEFB 0
3512+ 9981              SavedX:
3513+ 9981 00               DEFB 0
3514+ 9982              ColorOfBlock:
3515+ 9982 00               DEFB  0   ; usato per salvare il colore del blocco
3516+ 9983              CurrentBlockTable:
3517+ 9983 00 00 00 00      DW 0,0
3518+ 9987              CurrentBlockRotation:
3519+ 9987 00               DEFB    0                           ; Rotazione corrente del pezzo (0-3)
3520+ 9988              CurrentBlock:
3521+ 9988 00               DEFB    0                           ; Pezzo corrente
3522+ 9989              BlockCoordinates:
3523+ 9989 00 00 00...      DEFS    16                          ; Coordinate dei byte occupati dal pezzo
3524+ 9999 FF               DEFB    0xFF                        ; Fine delle coordinate
3525+ 999A              CurrentPosition:
3526+ 999A 00               DEFB    0                           ; Offset corrente nella matrice
3527+ 999B              PreviousPosition:
3528+ 999B 00               DEFB    0                           ; Offset precedente nella matrice
3529+ 999C              Seed:
3530+ 999C 5A               DB      0x5A                        ; Seed for random number generation
3531+ 999D              FrameCounter:
3532+ 999D 00               DB      0                           ; Contatore di frame per il movimento del pezzo
3533+ 999E              SecondsCounter:
3534+ 999E 00               DB      0                           ; Contatore di secondi per il movimento del pezzo
3535+ 999F              MinutesCounter:
3536+ 999F 00               DB      0                           ; Contatore di minuti per il movimento del pezzo
3537+ 99A0              Score:
3538+ 99A0 00 00            DW      0                           ; Current score
3539+ 99A2              HighScore:
3540+ 99A2 00 00            DW      0                           ; High score
3541+ 99A4              Level:
3542+ 99A4 00               DB      0                           ; Livello corrente
3543+ 99A5              BlockSpeed:
3544+ 99A5 00               DB      0                           ; Velocità del pezzo corrente
3545+ 99A6              BlockSpeedCounter:
3546+ 99A6 00               DB      0                           ; Contatore di velocità del pezzo corrente
3547+ 99A7              PrintMatrixMaxRow:
3548+ 99A7 00               DB      0                          ; Massimo numero di righe nella matrice
3549+ 99A8              BlockLeftMoving:
3550+ 99A8 00               DB      0                          ; Flag per il movimento a sinistra del pezzo corrente, se 1 vuol dire verso sinistra, se 2 verso destra (viene usato solo i movimenti laterali)
3551+ 99A9              TempXBlocPosition:
3552+ 99A9 00               DB      0                          ; Posizione temporanea del pezzo corrente (per verfica spostamenti laterali)
3553+ 99AA              LastKeyPressed:
3554+ 99AA 00               DB      0                          ; Ultimo tasto premuto
3555+ 99AB              KeyPressed:
3556+ 99AB 00               DB      0                          ; Tasto premuto (0=NO, 1=SI)
3557+ 99AC              ForcePrintMatrixRepaintAll:
3558+ 99AC 00               DB      0                          ; Forza il ridisegno della matrice (0=NO, 1=SI)
3559+ 99AD              CompletedRows:
3560+ 99AD 00               DB      0                          ; Righe completate (0=NO, 1=SI)
3561+ 99AE              Changes:
3562+ 99AE 00               DEFB 0
3563+ 99AF              ChangesOnce:
3564+ 99AF 00               DEFB 0
3565+ 99B0              NextBlock:
3566+ 99B0 00               DEFB    0                           ; Pezzo successivo
3567+ 99B1              NextBlockXPosition:
3568+ 99B1 00               DEFB 0
3569+ 99B2              NextBlockYPosition
3570+ 99B2 00               DEFB 0
3571+ 99B3              Bug:
3572+ 99B3 00               DB 0x00                              ; Used for bug workaround only
3573+ 99B4              TempBlock:
3574+ 99B4 00 00 00...      DEFS 16
3575+ 99C4              ShowNextBlock:
3576+ 99C4 00               DB 0                              ; Flag to show next block (0=NO, 1=YES)
3577+ 99C5              NextBlockColor:
3578+ 99C5 00               DB 0                              ; Color of the next block
3579+ 99C6              NextBlockTable:
3580+ 99C6 00 00 00 00      DW 0,0
3581+ 99CA              LastSamprSprite:
3582+ 99CA 00               DB 0                              ; Last sprite used for Sampr
3583+ 99CB              MoveToBottomInAction:
3584+ 99CB 00               DB 0                              ; Flag to indicate if the block is moving to the bottom (0=NO, 1=YES)
3585+ 99CC              CurrentWallTile:
3586+ 99CC 00               DB 0                              ; Current wall orientation (0=left, 1=right)
3587+ 99CD              PlacedBlocks:
3588+ 99CD 00 00            DW 0                              ; Number of blocks placed
3589+ 99CF              MaxPlacedBlocks:
3590+ 99CF 00 00            DW 0                              ; Amx number of blocks placedù
3591+ 99D1 31 32 33 34  NumberValue:  DB "12345",0   ;  characters plus null terminator
3591+ 99D5 35 00
3592+ 99D7              LevelBlocksCounter:
3593+ 99D7 00               DB 0                              ; Number of blocks placed in the current level
3594+ 99D8              SelectedLevel:
3595+ 99D8 00               DB 0                              ; Selected level (0-9)
3596+ 99D9              SelectedOrientation:
3597+ 99D9 00               DB 0                              ; Selected orientation (0-3)
3598+ 99DA              SelectedCanGrow:
3599+ 99DA 00               DB 0                              ; Selected can grow (0=NO, 1=YES)
3600+ 99DB              SelectedOption:
3601+ 99DB 00               DB 0                              ; Selected option (0=NO, 1=YES)
3602+ 99DC              TitleTimer:
3603+ 99DC 00               DB 0                              ; Timer for title screen
3604+ 99DD              GameOver:
3605+ 99DD 00               DB 0                              ; Game over flag (0=NO, 1=YES)
3606+ 99DE              MusicNoteIndex:
3607+ 99DE 00               DB 0                              ; Index for music note
3608+ 99DF              InGame:
3609+ 99DF 00               DB 0                              ; In game flag (0=NO, 1=YES)
# file closed: ./inc/GAMESUBS.asm
  15  99E0
  16  99E0
  17  99E0
  18  99E0
  19  99E0
  20  99E0              ;------------------------------------------------------------------------
  21  99E0              ; START OF PROGRAM
  22  99E0              ;------------------------------------------------------------------------
  23  99E0
  24  99E0              InitGame:
  25  99E0 CD 43 90             CALL    SetM2RRoutine
  26  99E3 26 00                LD      H, 0
  27  99E5 2E 00                LD      L, 0
  28  99E7 22 CF 99             LD      (MaxPlacedBlocks), HL           ; Set the maximum number of blocks to 0
  29  99EA 22 A2 99             LD      (HighScore), HL                 ; Set the high score to 0
  30  99ED 3E 01                LD      A, 1
  31  99EF 32 D8 99             LD      (SelectedLevel), A
  32  99F2 32 DA 99             LD      (SelectedCanGrow), A            ; Can grow
  33  99F5 3E 04                LD      A, 4
  34  99F7 32 D9 99             LD      (SelectedOrientation), A        ; CHAOS
  35  99FA
  36  99FA CD 80 82             CALL    Screen_LoadTiles                ; Load tiles into RAM
  37  99FD              InitMenu:
  38  99FD AF                   XOR     A
  39  99FE 32 AB 99             LD      (KeyPressed), A
  40  9A01 CD 5C 89             CALL    ShowMenu                        ; Show menu
  41  9A04 3E 01                LD      A, 1
  42  9A06 32 DF 99             LD      (InGame), A
  43  9A09 3E 00                LD      A, ORIENT_NORTH
  44  9A0B 32 7F 99             LD      (CurrentMatrixOrientation), A  ; Set the current matrix orientation to north
  45  9A0E AF                   XOR     A
  46  9A0F 32 AB 99             LD      (KeyPressed), A
  47  9A12
  48  9A12              StartGame:
  49  9A12 3A D8 99             LD      A, (SelectedLevel)
  50  9A15 32 A4 99             LD      (Level), A
  51  9A18 CD C3 93             CALL    SetSpeedByLevel
  52  9A1B CD 86 8C             CALL    ShowGameField  ; Show game field
  53  9A1E CD 18 90             CALL    InitNewGame
  54  9A21 CD 47 89             CALL    MatrixInit
  55  9A24 CD 6E 93             CALL    ChooseRandomBlock       ; Choose a random piece
  56  9A27 F3                   DI                                      ; Disable interrupts
  57  9A28 ED 5E                IM      2                               ; Set the interrupt mode
  58  9A2A FB                   EI                                      ; Enable interrupts
  59  9A2B
  60  9A2B              ;------------------------------------------------------------------------
  61  9A2B              ; TETRIS GAME LOOP
  62  9A2B              ;------------------------------------------------------------------------
  63  9A2B
  64  9A2B              TetrisLoop:
  65  9A2B 3A DD 99             LD      A, (GameOver)
  66  9A2E FE 01                CP      1
  67  9A30 CA BF 8F             JP      Z, ShowGameOver
  68  9A33 3A C4 99             LD      A, (ShowNextBlock)
  69  9A36 FE 00                CP      0
  70  9A38 28 19                JR      Z, TetrisLoopNext
  71  9A3A
  72  9A3A 3E 01                LD      A, 1
  73  9A3C 2A CD 99             LD      HL, (PlacedBlocks)
  74  9A3F CD C1 83             CALL    Math_AddAToHL
  75  9A42 22 CD 99             LD      (PlacedBlocks), HL      ; Incrementa il numero di pezzi piazzati
  76  9A45 ED 4B CF 99          LD      BC, (MaxPlacedBlocks)
  77  9A49 CD C6 83             CALL    Math_CompareHLtoBC
  78  9A4C FE 01                CP      1
  79  9A4E 20 03                JR      NZ, TetrisLoopNext
  80  9A50 22 CF 99             LD      (MaxPlacedBlocks), HL  ; Set the maximum number of blocks to the current number of blocks
  81  9A53              TetrisLoopNext:
  82  9A53
  83  9A53 CD E9 94             CALL    CheckAndMarkCompletedRows
  84  9A56 3A AD 99             LD      A, (CompletedRows)
  85  9A59 FE 00                CP      0
  86  9A5B 28 4A                JR      Z, TetrisLoopContinue
  87  9A5D F3                   DI
  88  9A5E CD CF 87             CALL    ScoreUpdate
  89  9A61 32 AC 99             LD      (ForcePrintMatrixRepaintAll), A
  90  9A64 CD E9 8C             CALL    PrintMatrix
  91  9A67 CD DE 8E             CALL    RemoveCompletedRows
  92  9A6A CD DE 8E             CALL    RemoveCompletedRows
  93  9A6D CD DE 8E             CALL    RemoveCompletedRows
  94  9A70 CD DE 8E             CALL    RemoveCompletedRows
  95  9A73 CD DE 8E             CALL    RemoveCompletedRows
  96  9A76 CD DE 8E             CALL    RemoveCompletedRows
  97  9A79 CD DE 8E             CALL    RemoveCompletedRows
  98  9A7C CD DE 8E             CALL    RemoveCompletedRows
  99  9A7F CD DE 8E             CALL    RemoveCompletedRows
 100  9A82 CD DE 8E             CALL    RemoveCompletedRows
 101  9A85 CD DE 8E             CALL    RemoveCompletedRows
 102  9A88 CD DE 8E             CALL    RemoveCompletedRows
 103  9A8B CD DE 8E             CALL    RemoveCompletedRows
 104  9A8E CD DE 8E             CALL    RemoveCompletedRows
 105  9A91 CD DE 8E             CALL    RemoveCompletedRows
 106  9A94 CD DE 8E             CALL    RemoveCompletedRows
 107  9A97 CD DE 8E             CALL    RemoveCompletedRows
 108  9A9A CD DE 8E             CALL    RemoveCompletedRows
 109  9A9D CD DE 8E             CALL    RemoveCompletedRows
 110  9AA0 CD DE 8E             CALL    RemoveCompletedRows
 111  9AA3 CD DE 8E             CALL    RemoveCompletedRows
 112  9AA6                      ;CALL    PrintMatrix
 113  9AA6 FB                   EI
 114  9AA7              TetrisLoopContinue:
 115  9AA7
 116  9AA7
 117  9AA7
 118  9AA7
 119  9AA7
 120  9AA7
 121  9AA7
 122  9AA7 F3                   DI
 123  9AA8 3A B0 99             LD      A, (NextBlock)
 124  9AAB 32 88 99             LD      (CurrentBlock), A
 125  9AAE CD 6E 93             CALL    ChooseRandomBlock       ; Choose a random piece
 126  9AB1 3A B0 99             LD      A, (NextBlock)
 127  9AB4 CD 9F 88             CALL    UpdateNextBlockInfo
 128  9AB7 CD 1C 88             CALL    SetNextBoxPosition
 129  9ABA CD FC 88             CALL    ShowNextBlockOnBox
 130  9ABD CD FF 93             CALL    PlaceBlockAtTop         ; Place the piece at the top
 131  9AC0 FB                   EI
 132  9AC1
 133  9AC1              MoveBlock:
 134  9AC1 16 00                LD      D, 0
 135  9AC3 1E 00                LD      E, 0
 136  9AC5 CD B4 94             CALL    ReadKeyboard
 137  9AC8
 138  9AC8 3A C4 99             LD      A, (ShowNextBlock)
 139  9ACB FE 01                CP      1
 140  9ACD CA 2B 9A             JP      Z, TetrisLoop
 141  9AD0 C3 C1 9A             JP      MoveBlock         ; Continue moving down
 142  9AD3
 143  9AD3
 144  9AD3
 145  9AD3                      SAVESNA "./out/samprtrt.sna", InitGame
 146  9AD3              END
 147  9AD3
# file closed: ./src/SAMPRTRT.asm
